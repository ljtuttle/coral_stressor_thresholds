---
title: "Effects of sediment on the growth of adult corals"
author: "Lillian J. Tuttle"
date: "7/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(lme4)
library(pROC)
library(effects)
library(lattice)
library(MuMIn)
binaryDS <- read.csv("/Volumes/GoogleDrive/My Drive/iScience/Code/thresholds/sedimentation/binary/binaryDS.csv", header=T)
binarySS <- read.csv("/Volumes/GoogleDrive/My Drive/iScience/Code/thresholds/sedimentation/binary/binarySS.csv", header=T)

#keyboard shortcuts to remember: 
#command-option-I inserts new code chunk
#command-shift-M inserts pipeline symbols
#command-enter runs line of code where cursor is (or highlighted portion)
```

#### Here I will explore how DEPOSITED AND SUSPENDED sediment affects the GROWTH of tropical, scleractinean coral ADULTS. The database to be used is comprised of data extracted from studies deemed relevant during the systematic literature review process.

# The Dataset
  
## Deposited Sediment 
Specifically, we will explore the results of 55 datapoints from 10 studies conducted in 2 oceans on 10 species within 7 genera.

```{r, echo=FALSE, warning=FALSE}
#head(growthDS)
growthDS <- binaryDS %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(!is.na(Binary_reduced_growth)) %>% 
  filter(Binary_sed_burial=="0")
growthDS %>% tally() #n=55 datapoints, tally() returns same result as count(growthDS)
growthDS %>% count(Ref, sort=T) #n=10 studies
growthDS %>% count(Ref_name, sort=T) #n=10 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
growthDS %>% count(Ocean, sort=T) #n=2 oceans
growthDS %>% count(Gsp, sort=T) #n=10 species
growthDS %>% count(Updated_Genus, sort=T) #n=7 genera
```
  
## Suspended Sediment  
Specifically, we will explore the results of 79 datapoints from 5 studies conducted in 2 oceans on 12 species within 12 genera (shown below only the top 10 species and genera, by number of datapoints).

```{r, echo=FALSE, warning=FALSE}
#head(binarySS)
growthSS <- binarySS %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(Coral_age_class=="adult") %>% #only adult corals
  filter(!is.na(Binary_reduced_growth))
growthSS %>% tally() #n=79 datapoints, tally() returns same result as count(growthSS)
growthSS %>% count(Ref, sort=T) #n=7 studies
growthSS %>% count(Ref_name, sort=T) #n=5 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
growthSS %>% count(Ocean, sort=T) #n=2 oceans
growthSS %>% count(Gsp, sort=T) %>% #n=12 species
  top_n(10)
growthSS %>% count(Updated_Genus, sort=T) %>% #n=12 genera
  top_n(10)
```

# Exploratory plots

First let's explore all data from all species for which there is binary data about the presence of a reduction in 'growth rate' as a result of exposure to deposited/suspended sediment.  

##### DEFINITIONS:  
* '**Growth rate**' is defined as coral growth measured in any way, e.g., tissue/skeletal linear extension or increase in weight.

```{r, echo=FALSE, warning=FALSE}
#DEPOSITED SEDIMENT
#growth rate, plotted by exposure concentration (x) and exposure duration (y)
growth_rate <- growthDS %>% 
  select(Ref, Ref_name, Sed_level_mg_cm2_d, Binary_reduced_growth, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Sed_days, Sed_origin, Sed_grain_class, Binary_sed_burial) %>% 
  filter(Binary_sed_burial=="0") %>% #remove all studies that buried corals instead of giving them a specific dosage (in mg/cm2/day)
  filter(!is.na(Binary_reduced_growth)) #remove NAs (studies that did not describe growth)
growth_rate %>% tally() #n=55 datapoints, tally() returns same result as count(growth_rate)
growth_rate %>% count(Ref, sort=T) #n=10 studies,
growth_rate %>% count(Ref_name, sort=T) #n=10 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
growth_rate %>% count(Gsp, sort=T) #n=10 species
growth_rate %>% count(Updated_Genus, sort=T) #n=7 genera, top four: Pocillopora n=17, Astrangia n=12, Acropora n=10, Porites n=8
#head(growth_rate)

growth_rate_plot <- ggplot(data=growth_rate, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      color = factor(Binary_reduced_growth),
      shape = factor(Binary_reduced_growth),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(growth_rate, Binary_reduced_growth=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000), 
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(10,200), breaks=c(10,100), 
                  label=c("10","100")) +
    scale_color_manual(name = "Reduced growth rate\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Reduced growth rate\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#SUSPENDED SEDIMENT
#growth, plotted by exposure concentration (x) and exposure duration (y)
growthSS <- growthSS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_mg_L, Binary_reduced_growth, Updated_Genus, Gsp, Ocean, Sed_exposure_days)
#growthSS %>% count(Updated_Genus, sort=T) #n=12 genera, top four: Goniastrea n=12, Porites n=12, Cladocora n=8, Manicina n=8
#head(growth)

growthSS_plot <- ggplot(data=growthSS, mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      color = factor(Binary_reduced_growth),
      shape = factor(Binary_reduced_growth),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(growthSS, Binary_reduced_growth=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.1,1000), 
                  breaks=c(0.1,1,10,100,1000), 
                  label=c("0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(10,100), breaks=c(10,100), 
                  label=c("10","100")) +
    scale_color_manual(name = "Reduced growth rate\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Reduced growth rate\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#PLOTS:
growth_rate_plot + geom_point(data = subset(growth_rate, Binary_reduced_growth=="1")) +
  labs(title = "Reduced Growth Rate from Deposited Sediment", 
       subtitle = "n = 55 datapoints, n = 10 studies from 10 articles, n = 10 spp. from 7 genera")
growthSS_plot + geom_point(data = subset(growthSS, Binary_reduced_growth=="1")) +
  labs(title = "Reduced Growth Rate from Suspended Sediment", 
       subtitle = "n = 79 datapoints, n = 7 studies from 5 articles, n = 12 spp. from 12 genera")
```
  
  
### Exploring the same plots with PLOTLY...  

##### Growth rate
**Legend**: Reduced growth rate due to sedimentation? Empty circles are no (0), and filled squares are yes (1). Colors are for different genera.

**Deposited sediment**: All species, n=35 datapoints, n=8 studies, n=6 genera
```{r, echo=FALSE, warning=FALSE}
growth_rate_plot2 <- ggplot(data=growth_rate) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      shape = factor(Binary_reduced_growth),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Exposure duration (days)",
         shape = "Reduced growth rate\ndue to sedimentation?",
         color = "Genus") +
    scale_x_log10(limits = c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000), 
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(1,200), breaks=c(1,10,100), 
                  label=c("1","10","100")) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
growth_rate_plotly <- ggplotly(growth_rate_plot2, tooltip="text")
growth_rate_plotly #plot where I can hover over points and get species, but legend cut-off
```
  
**Suspended sediment**: All species, n=79 datapoints, n=5 studies, n=12 genera
```{r, echo=FALSE, warning=FALSE}
growthSS_plot2 <- ggplot(data=growthSS) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      shape = factor(Binary_reduced_growth),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Exposure duration (days)",
         shape = "Reduced growth rate\ndue to sedimentation?",
         color = "Genus") +
    scale_x_log10(limits = c(0.1,1000), 
                  breaks=c(0.1,1,10,100,1000), 
                  label=c("0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(1,100), breaks=c(1,10,100), 
                  label=c("1","10","100")) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
growthSS_plotly <- ggplotly(growthSS_plot2, tooltip="text")
growthSS_plotly #plot where I can hover over points and get species, but legend cut-off
```
  
    
# Threshold Analyses with Binary Data 
Now let's calculate the thresholds, based on the binary data explored above.  

##### DEFINITIONS:  
* '**LOAEL**', or the 'lowest observed adverse effect level' is defined as the lowest dose at which there was an observed adverse effect.  
* '**NOAEL**', or the 'no observed adverse effect level' is defined as the highest dose at which there was NOT an observed adverse effect.  
* '**Adverse effect**' is defined here as any response of a coral individual, colony, or experimental treatment group that *may* negatively affect the coralâ€™s fitness and/or survival. These adverse effects may include sublethal physiological changes (e.g., significantly reduced growth or photosynthetic rates when compared to coral in ambient/control conditions), bleaching/tissue loss, and mortality.  This definition of adverse effect is independent of its magnitude, so while the affect may have potentially reduced fitness, its magnitude may be sufficiently small that the fitness effect is not measureable.  
  
  
## DEPOSITED SEDIMENT 
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_growth_rate <- growth_rate %>% 
  filter(Binary_reduced_growth=="1") %>%
  arrange(Sed_level_mg_cm2_d) #minimum Sedimentation level is 53 but only two rows from Lirman et al. (2008)!!

#LOAEL
summarize(adverse_growth_rate, LOAEL=min(Sed_level_mg_cm2_d)) #LOAEL is 53 and comes from Lirman et al. (2008)!!
loael <- adverse_growth_rate %>% summarize(min(Sed_level_mg_cm2_d))
loael <- as.numeric(loael)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_growth_rate <- growth_rate %>%
  filter(Binary_reduced_growth=="0") %>%
  arrange(desc(Sed_level_mg_cm2_d)) %>%
  filter(Sed_level_mg_cm2_d<=53) #less than or equal to the LOAEL, which = 53

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_growth_rate, NOAEL=max(Sed_level_mg_cm2_d)) #NOAEL is 38.4

#PLOT
growth %>% 
  select(Ocean, Region, Genus, species, Binary_sed_burial, Sed_level_mg_cm2_d, Binary_reduced_growth) %>% 
  filter(Binary_sed_burial=="0") %>% #remove all studies that buried corals instead of #giving them a specific dosage (in mg/cm2/day)
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_reduced_growth)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Reduced growth rate\ndue to sedimentation?") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=53, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_growth_rate2 <- growth_rate %>% 
  filter(Binary_reduced_growth=="1") %>% 
  filter(!is.na(Sed_days)) %>% 
  arrange(Sed_days)

#LOAEL
summarize(adverse_growth_rate2, LOAEL=min(Sed_days)) #LOAEL is 21 days

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_growth_rate2 <- growth_rate %>%
  filter(Binary_reduced_growth=="0") %>%
  filter(Sed_days<=21) #less than or equal to the LOAEL, which = 21

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_growth_rate2, NOAEL=max(Sed_days)) #NOAEL is 21 days

#PLOT LOAELs
growth_rate_plot + geom_point(data = subset(growth_rate, Binary_reduced_growth=="1")) +
  labs(title = "Reduced Growth Rate from Deposited Sediment", 
       subtitle = "n = 55 datapoints, n = 10 studies from 10 articles, n = 10 spp. from 7 genera", 
       caption = "LOAEL concentration = 53.0, duration = 21 d\nNOAEL concentration = 38.4, duration = 21 d\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=53, xmax=Inf, ymin=21, ymax=Inf, fill = "red", alpha=0.2)

growth_rate_plot + geom_point(data = subset(growth_rate, Binary_reduced_growth=="1")) +
  labs(caption = "LOAEL concentration = 53.0, duration = 21 d\nNOAEL concentration = 38.4, duration = 21 d\nShaded box represents 'risky' exposure area\nn = 55 datapoints, n = 10 studies from 10 articles, n = 10 spp. from 7 genera") +
    annotate("rect", xmin=53, xmax=Inf, ymin=21, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
## SUSPENDED SEDIMENT 
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_growthSS <- growthSS %>% 
  filter(Binary_reduced_growth=="1") %>%
  arrange(Sed_level_mg_L)

#LOAEL
summarize(adverse_growthSS, LOAEL=min(Sed_level_mg_L)) #LOAEL is 58.6 and comes from Te (2001 Chapter 6) with Montipora_verrucosa for 31 days exposure
loaelSS <- adverse_growthSS %>% summarize(min(Sed_level_mg_L))
loaelSS <- as.numeric(loaelSS)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_growthSS <- growthSS %>%
  filter(Binary_reduced_growth=="0") %>%
  arrange(desc(Sed_level_mg_L)) %>%
  filter(Sed_level_mg_L<=58.6) #less than or equal to the LOAEL, which = 58.6

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_growthSS, NOAEL=max(Sed_level_mg_L)) #NOAEL is 49

#PLOT
growthSS %>% 
  select(Ocean, Gsp, Sed_level_mg_L, Binary_reduced_growth) %>% 
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_L,
      y = Binary_reduced_growth)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Reduced growth rate\ndue to sedimentation?") +
    scale_x_continuous(trans='log10', breaks=c(0.01,0.1,1,10,100,1000), label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=58.6, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_growthSS2 <- growthSS %>% 
  filter(Binary_reduced_growth=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>% 
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_growthSS2, LOAEL=min(Sed_exposure_days)) #LOAEL is 31 days and is from Te 2001 Chapter 6 with Montipora verrucosa at 58.6 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_growthSS2 <- growthSS %>%
  filter(Binary_reduced_growth=="0") %>%
  filter(Sed_exposure_days<=31) #less than or equal to the LOAEL, which = 31

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_growthSS2, NOAEL=max(Sed_exposure_days)) #NOAEL is 31 days

#PLOT LOAELs
growthSS_plot + geom_point(data = subset(growthSS, Binary_reduced_growth=="1")) +
  labs(title = "Reduced Growth Rate from Suspended Sediment", 
       subtitle = "n = 79 datapoints, n = 7 studies from 5 articles, n = 12 spp. from 12 genera",
       caption = "LOAEL concentration = 58.6, duration = 31 d\nNOAEL concentration = 49.0, duration =  31 d\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=58.6, xmax=Inf, ymin=31, ymax=Inf, fill = "red", alpha=0.2)

growthSS_plot + geom_point(data = subset(growthSS, Binary_reduced_growth=="1")) +
  labs(caption = "LOAEL concentration = 58.6, duration = 31 d\nNOAEL concentration = 49.0, duration =  31 d\nShaded box represents 'risky' exposure area\nn = 79 datapoints, n = 7 studies from 5 articles, n = 12 spp. from 12 genera") +
    annotate("rect", xmin=58.6, xmax=Inf, ymin=31, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
# Logistic Regression Model Fitting  
## Deposited Sediment
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
growthDS2 <- growthDS %>% 
  select(Ref, Ref_name, Binary_reduced_growth, Control_code, Sed_level_mg_cm2_d, Sed_days, Gsp) %>% 
  mutate(log10_conc=log10(Sed_level_mg_cm2_d)) %>% 
  filter(Control_code=="0")

#Models with fixed effect(s) only
mod1 <- glm(Binary_reduced_growth ~ Sed_level_mg_cm2_d, 
            family = binomial(link = "logit"), data = growthDS2)
mod2 <- glm(Binary_reduced_growth ~ Sed_level_mg_cm2_d + Sed_days, 
            family = binomial(link = "logit"), data = growthDS2)
mod3 <- glm(Binary_reduced_growth ~ Sed_level_mg_cm2_d*Sed_days, 
            family = binomial(link = "logit"), data = growthDS2)

#Models with random effect for coral species or study
mod4 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d + (1 | Gsp), 
              family = binomial, data = growthDS2)
mod5 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d + Sed_days + (1 | Gsp), 
              family = binomial, data = growthDS2)
mod6 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d*Sed_days + (1 | Gsp), 
              family = binomial, data = growthDS2)
mod7 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d + (1 | Ref), 
              family = binomial, data = growthDS2)
mod8 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d + Sed_days + (1 | Ref), 
              family = binomial, data = growthDS2)
mod9 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d*Sed_days + (1 | Ref), 
              family = binomial, data = growthDS2)
mod10 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = growthDS2)
mod11 <- glmer(Binary_reduced_growth ~ 
                Sed_level_mg_cm2_d + Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = growthDS2)
mod12 <- glmer(Binary_reduced_growth ~ 
                Sed_level_mg_cm2_d*Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = growthDS2)
mod13 <- glmer(Binary_reduced_growth ~ Sed_level_mg_cm2_d + (1 | Ref_name/Ref), 
              family = binomial, data = growthDS2)
mod14 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d + Sed_days + (1 | Ref_name/Ref), 
              family = binomial, data = growthDS2)
mod15 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d*Sed_days + (1 | Ref_name/Ref), 
              family = binomial, data = growthDS2)
mod16 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = growthDS2)
mod17 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d + Sed_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = growthDS2)
mod18 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d*Sed_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = growthDS2)
mod19 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = growthDS2)
mod20 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d + Sed_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = growthDS2)
mod21 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_cm2_d*Sed_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = growthDS2)

#Model comparison and summary
anova(mod6,mod9,mod12,mod15,mod18,mod21) #compare full fixed effects models -- mod9 is best
anova(mod7,mod8,mod9) #No evidence against reduced model (mod7)
anova(mod4,mod7,mod10,mod13,mod16) #compare reduced fixed effects models -- mod7 is best
print(summary(mod7), correlation=FALSE) #No errors

#Trying out a log transformation of predictor...
#mod7_log <- glmer(Binary_reduced_growth ~ log10_conc + (1 | Ref), 
#                  family = binomial, data = growthDS2)
#print(summary(mod7_log), correlation=FALSE) #Also no errors
```
  
### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(mod7, type="response")>0.5)
#proportion correct:
mean(p==growthDS2$Binary_reduced_growth) #[1] 0.85
#predicted-vs-observed table:
table(p,growthDS2$Binary_reduced_growth)
#ROC and area under the curve:
pred_mod7 <- predict(mod7, newdata = growthDS2, type = "response")
auc(roc(growthDS2$Binary_reduced_growth, pred_mod7)) #AUC: 0.8817
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(mod7) #The fixed effect of sediment level explains ~0.3% of variation of the total variation. If the random intercepts for studies are also included, then 55.8% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(mod7))
dotplot(ranef(mod7, condVar = T)) #residual variation at the level of studies -- variation among studies is large
qqnorm(ranef(mod7)$Ref[,1])
qqline(ranef(mod7)$Ref[,1]) #distribution of random effects looks good
VarCorr(mod7) #SD=2.0307 
exp(sqrt(VarCorr(mod7)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
mod7_noSed <- glmer(Binary_reduced_growth ~ 1 + (1 | Ref), 
                    family = binomial, data = growthDS2)
#Explained_var_Ref <- (1-VarCorr(mod7)$Ref[1]/VarCorr(mod7_noSed)$Ref[1]) #not returning a proportion of variance explained, so not sure how to interpret.
random.intercepts <- ranef(mod7)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(mod7)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(mod7)["Sed_level_mg_cm2_d"]*x)/(1 + exp(Ref.intercepts[i] + fixef(mod7)["Sed_level_mg_cm2_d"]*x)), 
                    from = min(growthDS2$Sed_level_mg_cm2_d), to = max(growthDS2$Sed_level_mg_cm2_d), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(mod7)["Sed_level_mg_cm2_d"]*x)/(1 + exp(Ref.intercepts[i] + fixef(mod7)["Sed_level_mg_cm2_d"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Model was non-significant!
#se <- sqrt(diag(vcov(mod7)))
#tab <- cbind(Est = fixef(mod7), 
#             LL = fixef(mod7) - 1.96 * se, 
#             UL = fixef(mod7) + 1.96 * se)
#2^(tab)
#                        Est        LL        UL
#(Intercept)        0.215543 0.02925445 1.588094
#Sed_level_mg_cm2_d 1.001081 0.99498828 1.007212

```
    
There is no evidence to suggest that the exposure concentration of deposited sediment affects the odds of a reduction in coral growth rate (GLMM p=0.729).
  
### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_mod7 <- predict(mod7, newdata=growthDS2, type="response")
growthDS3 <- cbind(growthDS2, pred_mod7)

growthDS_plot <- ggplot(data = growthDS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_reduced_growth,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Reduced growth rate\ndue to sediment exposure",
         color = "Study") +
    scale_x_log10(limits=c(0.01,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_mg_cm2_d, y = pred_mod7), inherit.aes=FALSE) +
    theme_bw()

growthDS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
```{r}
#summary(growthDS2$Sed_level_mg_cm2_d)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   0.02   35.95  126.70  134.49  200.00  426.80

jvalues <- with(growthDS2, seq(from = min(Sed_level_mg_cm2_d), to = max(Sed_level_mg_cm2_d), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    growthDS2$Sed_level_mg_cm2_d <- j
    predict(mod7, newdata = growthDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_mg_cm2_d values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
growthDS_plot3 <- ggplot() +
    geom_point(data = growthDS2, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_reduced_growth,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of reduced growth\nrate due to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000,loael),
                  label=c("0.01","0.1","1","10","100","1000",round(loael,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loael, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

growthDS_plot3
```
  
## Suspended Sediment
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
growthSS2 <- growthSS %>% 
  filter(Control_code=="0") %>% 
  mutate(log10_conc=log10(Sed_level_mg_L))

#Models with fixed effect(s) only
modSS1 <- glm(Binary_reduced_growth ~ Sed_level_mg_L, 
            family = binomial(link = "logit"), data = growthSS2)
modSS2 <- glm(Binary_reduced_growth ~ Sed_level_mg_L + Sed_exposure_days, 
            family = binomial(link = "logit"), data = growthSS2)
modSS3 <- glm(Binary_reduced_growth ~ Sed_level_mg_L*Sed_exposure_days, 
            family = binomial(link = "logit"), data = growthSS2)

#modSSels with random effect for coral species or study
modSS4 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L + (1 | Gsp), 
              family = binomial, data = growthSS2)
modSS5 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = growthSS2)
#modSS6 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L*Sed_exposure_days + (1 | Gsp), 
#              family = binomial, data = growthSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSS7 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L + (1 | Ref), 
              family = binomial, data = growthSS2)
modSS8 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = growthSS2)
#modSS9 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L*Sed_exposure_days + (1 | Ref), 
#              family = binomial, data = growthSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSS10 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = growthSS2)
modSS11 <- glmer(Binary_reduced_growth ~ 
                Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = growthSS2)
#modSS12 <- glmer(Binary_reduced_growth ~ 
#                Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
#              family = binomial, data = growthSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSS13 <- glmer(Binary_reduced_growth ~ Sed_level_mg_L + (1 | Ref_name/Ref), 
              family = binomial, data = growthSS2)
modSS14 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_L + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = growthSS2)
#modSS15 <- glmer(Binary_reduced_growth ~ 
#                 Sed_level_mg_L*Sed_exposure_days + (1 | Ref_name/Ref), 
#              family = binomial, data = growthSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSS16 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = growthSS2)
modSS17 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = growthSS2)
#modSS18 <- glmer(Binary_reduced_growth ~ 
#                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
#              family = binomial, data = growthSS2)
modSS19 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = growthSS2)
modSS20 <- glmer(Binary_reduced_growth ~ 
                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = growthSS2)
#modSS21 <- glmer(Binary_reduced_growth ~ 
#                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
#              family = binomial, data = growthSS2)

#Model comparison and summary
anova(modSS5,modSS8,modSS11,modSS14,modSS17,modSS20) #compare full fixed effects models -- mod5 and 8 are best -- same AIC and prefer to account for Ref, so let's try 8
anova(modSS4,modSS7,modSS10,modSS13,modSS16,modSS19) #compare reduced fixed effects models -- mod13 and 16 are best -- same AIC but LRT suggests 16 better than 13 -- however, both models are singular!
anova(modSS7,modSS8) #modSS8
print(summary(modSS8), correlation=FALSE) #no errors
```
  
### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSS8, type="response")>0.5)
#proportion correct:
mean(p==growthSS2$Binary_reduced_growth) #[1] 1
#predicted-vs-observed table:
table(p,growthSS2$Binary_reduced_growth)
#ROC and area under the curve:
pred_modSS8 <- predict(modSS8, newdata = growthSS2, type = "response")
auc(roc(growthSS2$Binary_reduced_growth, pred_modSS8)) #AUC: 1
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSS8) #The fixed effect of sediment level explains ~1.6% of variation of the total variation. If the random intercepts for studies are also included, then 100% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modSS8))
dotplot(ranef(modSS8, condVar = T)) #residual variation at the level of studies -- variation among studies is enormous
qqnorm(ranef(modSS8)$Ref[,1])
qqline(ranef(modSS8)$Ref[,1])
VarCorr(modSS8)
exp(sqrt(VarCorr(modSS8)$Ref[1]))
modSS8_noSed <- glmer(Binary_reduced_growth ~ 1 + (1 | Ref), 
                  family = binomial, data = growthSS2)
#Explained_var_Ref <- (1-VarCorr(modSS8)$Ref[1]/VarCorr(modSS8_noSed)$Ref[1]) #not returning a proportion of variance explained, so not sure how to interpret.
random.intercepts <- ranef(modSS8)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modSS8)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modSS8)["Sed_level_mg_L"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSS8)["Sed_level_mg_L"]*x)), 
                    from = min(growthSS2$Sed_level_mg_L), to = max(growthSS2$Sed_level_mg_L), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/L)")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modSS8)["Sed_level_mg_L"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSS8)["Sed_level_mg_L"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modSS8)))
tab <- cbind(Est = fixef(modSS8), 
             LL = fixef(modSS8) - 1.96 * se, 
             UL = fixef(modSS8) + 1.96 * se)
2^(tab) #for duration estimate
```
    
For every doubling in exposure concentration of suspended sediment, the odds of a reduction in coral growth rate increase by 1.4 times (95% CI 1.2,1.8, GLMM z = 3.483, p = 0.0005), while holding exposure duration constant (and accounting for the random effect of study). For every doubling in exposure duration of suspended sediment, the odds of a reduction in coral growth rate increase by 2.3 times (95% CI 1.3,4.1; GLMM z = 2.776, p = 0.006), while holding exposure concentration constant (and accounting for the random effect of study).
  
### Prediction figures  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSS8 <- predict(modSS8, newdata=growthSS2, type="response")
growthSS3 <- cbind(growthSS2, pred_modSS8)

growthSS_plot <- ggplot(data = growthSS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_reduced_growth,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Reduced growth rate\ndue to sediment exposure",
         color = "Study") +
    scale_x_log10(limits=c(1,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_mg_L, y = pred_modSS8), inherit.aes=FALSE) +
    theme_bw()

growthSS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
#### By sediment exposure concentration
```{r}
#summary(growthSS2$Sed_level_mg_L)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   1.31   15.79   49.00   78.83  165.00  199.00 

jvalues <- with(growthSS2, seq(from = min(Sed_level_mg_L), to = max(Sed_level_mg_L), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    growthSS2$Sed_level_mg_L <- j
    predict(modSS8, newdata = growthSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_mg_L values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
growthSS_plot2 <- ggplot() +
    geom_point(data = growthSS2, mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_reduced_growth,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of reduced growth\nrate due to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(1,max(growthSS2$Sed_level_mg_L)),
                  breaks=c(0.01,0.1,1,10,100,1000,loaelSS),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelSS,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

growthSS_plot2
```
  
#### By sediment exposure duration
```{r}
#summary(growthSS2$Sed_exposure_days)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   1.31   15.79   49.00   78.83  165.00  199.00 

jvalues <- with(growthSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    growthSS2$Sed_exposure_days <- j
    predict(modSS8, newdata = growthSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
growthSS_plot3 <- ggplot() +
    geom_point(data = growthSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_reduced_growth,
      color = Ref)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of reduced growth\nrate due to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(growthSS2$Sed_exposure_days))) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

growthSS_plot3
```