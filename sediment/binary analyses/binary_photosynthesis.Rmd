---
title: "Binary effects of sediment on the photosynthesis of adult corals"
author: "Lillian J. Tuttle"
date: "9/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(lme4)
library(pROC)
library(effects)
library(lattice)
library(MuMIn)
binary <- read.csv("data/binary_ALL.csv", header=T)

#keyboard shortcuts to remember: 
#command-option-I inserts new code chunk
#command-shift-M inserts pipeline symbols
#command-enter runs line of code where cursor is (or highlighted portion)
```

#### Here I will explore how DEPOSITED AND SUSPENDED sediment affects the PHOTOSYNTHESIS of tropical, scleractinean coral ADULTS. The database to be used is comprised of data extracted from studies deemed relevant during the systematic literature review process.

# The Dataset
  
## Deposited Sediment 
Specifically, we will explore the results of 438 datapoints from 15 studies conducted in 3 oceans on 36 species within 23 genera.

```{r, echo=FALSE, warning=FALSE}
#head(photoDS)
photoDS <- binary %>%
  filter(DS_SS=="DS") %>% 
  filter(Coral_age_class=="adult") %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(!is.na(Binary_reduced_PR_ratio) | !is.na(Binary_reduced_FvFm))%>% 
  filter(Binary_sed_burial=="0") %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Binary_reduced_FvFm, Binary_reduced_PR_ratio, Updated_Genus, Gsp, Ocean, Sed_exposure_days)
photoDS %>% tally() #n=438 datapoints, tally() returns same result as count(photoDS)
photoDS %>% count(Ref, sort=T) #n=15 studies
photoDS %>% count(Ref_name, sort=T) #n=15 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
photoDS %>% count(Ocean, sort=T) #n=4 oceans (one is Indo-Pacific)
photoDS %>% count(Gsp) %>% #n=36 species
  top_n(10)
photoDS %>% count(Updated_Genus, sort=T) %>% #n=23 genera
  top_n(10)
```
  
## Suspended Sediment  
Specifically, we will explore the results of 251 datapoints from 7 studies conducted in 3 oceans on 9 species within 6 genera (shown below only the top 10 species and genera, by number of datapoints).

```{r, echo=FALSE, warning=FALSE}
#head(binarySS)
photoSS <- binary %>%
  filter(DS_SS=="SS") %>% 
  filter(Coral_age_class=="adult") %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(!is.na(Binary_reduced_FvFm & Binary_reduced_PR_ratio)) %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Binary_reduced_FvFm, Binary_reduced_PR_ratio, Updated_Genus, Gsp, Ocean, Sed_exposure_days) %>% 
  filter(!str_detect(Ref, "SS26")) %>% #removes study that reported P/R ratio for NTU only (Telesnicki and Goldberg 1995)
  mutate(Sed_level_stand_mg = as.numeric(Sed_level_stand_mg))
photoSS %>% tally() #n=251 datapoints, tally() returns same result as count(photoSS)
photoSS %>% count(Ref, sort=T) #n=7 studies
photoSS %>% count(Ref_name, sort=T) #n=6 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
photoSS %>% count(Ocean, sort=T) #n=3 oceans (one is 'Indo-Pacific' = Singapore)
photoSS %>% count(Gsp, sort=T) #n=9 species
photoSS %>% count(Updated_Genus, sort=T) #n=6 genera
```

# Exploratory plots

First let's explore all data from all species for which there is binary data about the presence of a reduction in 'photosynthetic efficiency' or 'P/R ratio' as a result of exposure to deposited sediment.  

##### DEFINITIONS:  
* '**Photosynthetic efficiency**' is defined as either maximum or effective quantum yield, reported as Fv/Fm or deltaF/F'm, respectively.  
* '**P/R ratio**' is defined as the ratio between photosynthetic and respiration rates.  

```{r, echo=FALSE, warning=FALSE}
#DEPOSITED SEDIMENT
#Photosynthetic efficiency, plotted by exposure concentration (x) and exposure duration (y)
photo_eff <- photoDS %>% 
  filter(!is.na(Binary_reduced_FvFm)) #remove NAs (studies that did not describe photosynthetic efficiency)
#photo_eff %>% tally() #n=372 datapoints, tally() returns same result as count(photo_eff)
#photo_eff %>% count(Ref, sort=T) #n=9 studies
#photo_eff %>% count(Ref_name, sort=T) #n=9 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#photo_eff %>% count(Gsp) #n=20 species
#photo_eff %>% count(Updated_Genus, sort=T) #n=12 genera, top four: Montipora n=232, Porites n=39, Turbinaria n=32, Acropora n=28
#head(photo_eff)

photo_eff_plot <- ggplot(data=photo_eff, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_reduced_FvFm),
      shape = factor(Binary_reduced_FvFm),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(photo_eff, Binary_reduced_FvFm=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(0.1,100), breaks=c(0.1,1,10,100), 
                  label=c("0.1","1","10","100")) +
    scale_color_manual(name = "Reduced photosynthetic\nefficiency due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Reduced photosynthetic\nefficiency due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#P/R ratio, plotted by exposure concentration (x) and exposure duration (y)
PR_ratio <- photoDS %>% 
  filter(!is.na(Binary_reduced_PR_ratio)) #remove NAs (studies that did not describe large necroses)
#PR_ratio %>% tally() #n=60 datapoints, tally() returns same result as count(PR_ratio)
#PR_ratio %>% count(Ref, sort=T) #n=5 studies
#PR_ratio %>% count(Ref_name, sort=T) #n=5 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#PR_ratio %>% count(Gsp, sort=T) #n=16 species
#PR_ratio %>% count(Updated_Genus, sort=T) #n=15 genera, top four: Galaxea n=8, Goniopora n=8, Orbicella n=6, Porites n=4 
#head(PR_ratio)
        
PR_ratio_plot <- ggplot(data=PR_ratio, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_reduced_PR_ratio),
      shape = factor(Binary_reduced_PR_ratio),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(PR_ratio, Binary_reduced_PR_ratio=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Exposure duration (days)") +
    scale_x_continuous(limits = c(0,200)) +
    scale_y_continuous(limits = c(0,30)) +
    scale_color_manual(name = "Reduced P/R ratio\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Reduced P/R ratio\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#SUSPENDED SEDIMENT
#Photosynthetic efficiency, plotted by exposure concentration (x) and exposure duration (y)
photo_effSS <- photoSS %>% 
  filter(!is.na(Binary_reduced_FvFm)) #remove NAs (studies that did not describe Fv/Fm)
#photo_effSS %>% tally() #n=238 datapoints, tally() returns same result as count(photo_effSS)
#photo_effSS %>% count(Ref, sort=T) #n=5 studies
#photo_effSS %>% count(Ref_name, sort=T) #n=5 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#photo_effSS %>% count(Gsp, sort=T) #n=8 species
#photo_effSS %>% count(Updated_Genus, sort=T) #n=6 genera, top four: Acropora n=56, Platygyra n=50, Merulina n=49, Pachyseris n=47

photo_effSS_plot <- ggplot(data=photo_effSS, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_reduced_FvFm),
      shape = factor(Binary_reduced_FvFm),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(photo_effSS, Binary_reduced_FvFm=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.1,250), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_y_log10(limits = c(1,100), breaks=c(1,10,100),
                  label=c("1","10","100")) +
    scale_color_manual(name = "Reduced photosynthetic\nefficiency due to\nsuspended sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Reduced photosynthetic\nefficiency due to\nsuspended sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#P/R ratio, plotted by exposure concentration (x) and exposure duration (y)
PR_ratioSS <- photoSS %>% 
  filter(!is.na(Binary_reduced_PR_ratio)) #remove NAs (studies that did not describe P/R ratio)
#PR_ratioSS %>% tally() #n=49 datapoints, tally() returns same result as count(PR_ratioSS)
#PR_ratioSS %>% count(Ref, sort=T) #n=3 studies
#PR_ratioSS %>% count(Ref_name, sort=T) #n=3 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#PR_ratioSS %>% count(Gsp, sort=T) #n=4 species
#PR_ratioSS %>% count(Updated_Genus, sort=T) #n=4 genera, top four: Merulina n=16, Pachyseris n=16, Platygyra n=16, Montipora n=1

PR_ratioSS_plot <- ggplot(data=PR_ratioSS, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_reduced_PR_ratio),
      shape = factor(Binary_reduced_PR_ratio),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(PR_ratioSS, Binary_reduced_PR_ratio=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_continuous(limits = c(0,250)) +
    scale_y_continuous(limits = c(0,60)) +
    scale_color_manual(name = "Reduced P/R ratio due\nto suspended sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Reduced P/R ratio due\nto suspended sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#PLOTS:
photo_eff_plot + geom_point(data = subset(photo_eff, Binary_reduced_FvFm=="1")) +
  labs(title = "Reduced Photosynthetic Efficiency from Deposited Sediment",
       subtitle = "n = 372 datapoints, n = 9 studies from 9 articles, n = 20 spp. from 12 genera")
photo_effSS_plot + geom_point(data = subset(photo_effSS, Binary_reduced_FvFm=="1")) +
  labs(title = "Reduced Photosynthetic Efficiency from Suspended Sediment",
       subtitle = "n = 238 datapoints, n = 6 studies from 5 articles, n = 8 spp. from 6 genera")

PR_ratio_plot + geom_point(data = subset(PR_ratio, Binary_reduced_PR_ratio=="1")) +
  labs(title = "Reduced P/R Ratio from Deposited Sediment", 
       subtitle = "n = 60 datapoints, n = 5 studies from 5 articles, n = 16 spp. from 15 genera")
PR_ratioSS_plot + geom_point(data = subset(PR_ratioSS, Binary_reduced_PR_ratio=="1")) +
  labs(title = "Reduced P/R Ratio from Suspended Sediment", 
       subtitle = "n = 49 datapoints, n = 3 studies from 3 articles, n = 4 spp. from 4 genera")
```
  
  
# Threshold Analyses with Binary Data 
Now let's calculate the thresholds for each category of photosynthesis, based on the binary data explored above.  

##### DEFINITIONS:  
* '**LOAEL**', or the 'lowest observed adverse effect level' is defined as the lowest dose at which there was an observed adverse effect.  
* '**NOAEL**', or the 'no observed adverse effect level' is defined as the highest dose at which there was NOT an observed adverse effect.  
* '**Adverse effect**' is defined here as any response of a coral individual, colony, or experimental treatment group that *may* negatively affect the coral’s fitness and/or survival. These adverse effects may include sublethal physiological changes (e.g., significantly reduced growth or photosynthetic rates when compared to coral in ambient/control conditions), bleaching/tissue loss, and mortality.  This definition of adverse effect is independent of its magnitude, so while the affect may have potentially reduced fitness, its magnitude may be sufficiently small that the fitness effect is not measureable.  
  
 
## DEPOSITED SEDIMENT
### Photosynthetic efficiency  
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_photo_eff <- photo_eff %>% 
  filter(Binary_reduced_FvFm=="1") %>%
  arrange(Sed_level_stand_mg) #minimum Sedimentation level is 25

#LOAEL
summarize(adverse_photo_eff, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 25 and comes from Flores et al. (2012).
loaelDS1 <- adverse_photo_eff %>% summarize(min(Sed_level_stand_mg))
loaelDS1 <- as.numeric(loaelDS1)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_photo_eff <- photo_eff %>%
  filter(Binary_reduced_FvFm=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=25) #less than or equal to the LOAEL, which = 25

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_photo_eff, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 25

#PLOT
ggplot(data = photoDS) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_FvFm)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Reduced photosynthetic efficiency\ndue to sedimentation?") +
    scale_x_continuous(trans='log10', breaks=c(0.01,0.1,1,10,100,1000), label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=25, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_photo_eff2 <- photo_eff %>% 
  filter(Binary_reduced_FvFm=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>% 
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_photo_eff2, LOAEL=min(Sed_exposure_days)) #LOAEL is 0.5 days = 12 h

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_photo_eff2 <- photo_eff %>%
  filter(Binary_reduced_FvFm=="0") %>%
  filter(Sed_exposure_days<=0.5) #less than or equal to the LOAEL, which = 0.5

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_photo_eff2, NOAEL=max(Sed_exposure_days)) #NOAEL is 0.5 days

#PLOT LOAELs
photo_eff_plot + geom_point(data = subset(photo_eff, Binary_reduced_FvFm=="1")) +
  labs(title = "Reduced Photosynthetic efficiency from Deposited Sediment", 
       subtitle = "n = 372 datapoints, n = 9 studies from 9 articles, n = 20 spp. from 12 genera", 
       caption = "LOAEL concentration = 25, duration = 12 h\nNOAEL concentration = 25, duration = 12 h\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=25, xmax=Inf, ymin=0.5, ymax=Inf, fill = "red", alpha=0.2)

photo_eff_plot + geom_point(data = subset(photo_eff, Binary_reduced_FvFm=="1")) +
  labs(caption = "LOAEL concentration = 25, duration = 12 h\nNOAEL concentration = 25, duration = 12 h\nShaded box represents 'risky' exposure area\nn = 372 datapoints, n = 9 studies from 9 articles, n = 20 spp. from 12 genera") +
    annotate("rect", xmin=25, xmax=Inf, ymin=0.5, ymax=Inf, fill = "red", alpha=0.2)
```


### P/R ratio
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_PR_ratio <- PR_ratio %>% 
  filter(Binary_reduced_PR_ratio=="1") %>%
  arrange(Sed_level_stand_mg)

#LOAEL
summarize(adverse_PR_ratio, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 26.4 and comes from Hodgson (1989b) Chapter IV - field component.
loaelDS2 <- adverse_PR_ratio %>% summarize(min(Sed_level_stand_mg))
loaelDS2 <- as.numeric(loaelDS2)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_PR_ratio <- PR_ratio %>%
  filter(Binary_reduced_PR_ratio=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=26.4) #less than or equal to the LOAEL, which = 26.4

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_PR_ratio, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 26.4

#PLOT
ggplot(data = photoDS) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_PR_ratio)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Presence/absence (1/0) of large necroses\ndue to sedimentation?") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=26.4, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```

#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_PR_ratio2 <- PR_ratio %>% 
  filter(Binary_reduced_PR_ratio=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>% 
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_PR_ratio2, LOAEL=min(Sed_exposure_days)) #LOAEL is 2 days

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_PR_ratio2 <- PR_ratio %>%
  filter(Binary_reduced_PR_ratio=="0") %>%
  filter(Sed_exposure_days<=2) #less than or equal to the LOAEL, which = 2

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_PR_ratio2, NOAEL=max(Sed_exposure_days)) #NOAEL is 2 days

#PLOT LOAELs
PR_ratio_plot + geom_point(data = subset(PR_ratio, Binary_reduced_PR_ratio=="1")) +
  labs(title = "Reduced P/R Ratio from Deposited Sediment", 
       subtitle = "n = 60 datapoints, n = 5 studies from 5 articles, n = 16 spp. from 15 genera",
       caption = "LOAEL concentration = 26.4, duration = 2 d\nNOAEL concentration = 26.4, duration = 2 d\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=26.4, xmax=Inf, ymin=2, ymax=Inf, fill = "red", alpha=0.2)

PR_ratio_plot + geom_point(data = subset(PR_ratio, Binary_reduced_PR_ratio=="1")) +
  labs(caption = "LOAEL concentration = 26.4, duration = 2 d\nNOAEL concentration = 26.4, duration = 2 d\nShaded box represents 'risky' exposure area\nn = 60 datapoints, n = 5 studies from 5 articles, n = 16 spp. from 15 genera") +
    annotate("rect", xmin=26.4, xmax=Inf, ymin=2, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
## SUSPENDED SEDIMENT  
### Photosynthetic efficiency  
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_photoSS <- photo_effSS %>% 
  filter(Binary_reduced_FvFm=="1") %>%
  arrange(Sed_level_stand_mg)

#LOAEL
summarize(adverse_photoSS, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 35.8 and is from Browne et al. (2015) with Merulina ampliata for 56 days
loaelSS1 <- adverse_photoSS %>% summarize(min(Sed_level_stand_mg))
loaelSS1 <- as.numeric(loaelSS1)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_photoSS <- photo_effSS %>%
  filter(Binary_reduced_FvFm=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=35.8) #less than or equal to the LOAEL, which = 35.8

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_photoSS, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 35.8

#PLOT
ggplot(data = photoSS) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_FvFm)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Reduced photosynthetic efficiency\ndue to suspended sediment?") +
    scale_x_log10(limits = c(0.1,100), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    theme_bw() +
    annotate("rect", xmin=35.8, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_photoSS2 <- photo_effSS %>% 
  filter(Binary_reduced_FvFm=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>%
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_photoSS2, LOAEL=min(Sed_exposure_days)) #LOAEL is 56 days from Browne et al. (2015) with Merulina ampliata at 35.8 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_photoSS2 <- photo_effSS %>%
  filter(Binary_reduced_FvFm=="0") %>%
  filter(Sed_exposure_days<=56) #less than or equal to the LOAEL, which = 56

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_photoSS2, NOAEL=max(Sed_exposure_days)) #NOAEL is 56 days

#PLOT LOAELs
photo_effSS_plot + geom_point(data = subset(photo_effSS, Binary_reduced_FvFm=="1")) +
  labs(title = "Reduced Photosynthetic Efficiency from Suspended Sediment", 
       subtitle = "n = 238 datapoints, n = 6 studies from 5 articles, n = 8 spp. from 6 genera",
       caption = "LOAEL concentration = 35.8, duration = 56 d\nNOAEL concentration = 35.8, duration = 56 d\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=35.8, xmax=Inf, ymin=56, ymax=Inf, fill = "red", alpha=0.2)

photo_effSS_plot + geom_point(data = subset(photo_effSS, Binary_reduced_FvFm=="1")) +
  labs(caption = "LOAEL concentration = 35.8, duration = 56 d\nNOAEL concentration = 35.8, duration = 56 d\nShaded box represents 'risky' exposure area\nn = 238 datapoints, n = 6 studies from 5 articles, n = 8 spp. from 6 genera") +
    annotate("rect", xmin=35.8, xmax=Inf, ymin=56, ymax=Inf, fill = "red", alpha=0.2)
```

### P/R Ratio 
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_pr_ratioSS <- PR_ratioSS %>% 
  filter(Binary_reduced_PR_ratio=="1") %>%
  arrange(Sed_level_stand_mg)

#LOAEL
summarize(adverse_pr_ratioSS, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 35.8 and is from Browne et al. (2015) with Merulina ampliata for 56 days
loaelSS2 <- adverse_pr_ratioSS %>% summarize(min(Sed_level_stand_mg))
loaelSS2 <- as.numeric(loaelSS2)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_pr_ratioSS <- PR_ratioSS %>%
  filter(Binary_reduced_PR_ratio=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=35.8) #less than or equal to the LOAEL, which = 35.8

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_pr_ratioSS, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 35.8

#PLOT
ggplot(data = photoSS) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_PR_ratio)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Reduced photosynthetic efficiency\ndue to suspended sediment?") +
    scale_x_log10(limits = c(10,1000), breaks=c(10,100,1000),
                  label=c("10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=35.8, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_pr_ratioSS2 <- PR_ratioSS %>% 
  filter(Binary_reduced_PR_ratio=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>%
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_pr_ratioSS2, LOAEL=min(Sed_exposure_days)) #LOAEL is 0.083 days = 2h from Browne et al. (2014) with Merulina ampliata at 174.2 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_pr_ratioSS2 <- PR_ratioSS %>%
  filter(Binary_reduced_PR_ratio=="0") %>%
  filter(Sed_exposure_days<=0.083) #less than or equal to the LOAEL, which = 0.083 days

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_pr_ratioSS2, NOAEL=max(Sed_exposure_days)) #NOAEL is 0.083 days

#PLOT LOAELs
PR_ratioSS_plot + geom_point(data = subset(PR_ratioSS, Binary_reduced_PR_ratio=="1")) +
  labs(title = "Reduced P/R Ratio from Suspended Sediment",
       subtitle = "n = 49 datapoints, n = 3 studies from 3 articles, n = 4 spp. from 4 genera",
       caption = "LOAEL concentration = 35.8, duration = 2 h\nNOAEL concentration = 35.8, duration = 2 h\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=35.8, xmax=Inf, ymin=0.083, ymax=Inf, fill = "red", alpha=0.2)

PR_ratioSS_plot + geom_point(data = subset(PR_ratioSS, Binary_reduced_PR_ratio=="1")) +
  labs(caption = "LOAEL concentration = 35.8, duration = 2 h\nNOAEL concentration = 35.8, duration = 2 h\nShaded box represents 'risky' exposure area\nn = 49 datapoints, n = 3 studies from 3 articles, n = 4 spp. from 4 genera") +
    annotate("rect", xmin=35.8, xmax=Inf, ymin=0.083, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
# Logistic Regression Model Fitting 

## DEPOSITED SEDIMENT   
### Photosynthetic efficiency
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
photo_effDS2 <- photo_eff %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg)) %>% 
  filter(Control_code=="0")
photo_effDS2 %>% tally()

#Models with fixed effect(s) only
modDS1 <- glm(Binary_reduced_FvFm ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = photo_effDS2)
modDS2 <- glm(Binary_reduced_FvFm ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = photo_effDS2)
modDS3 <- glm(Binary_reduced_FvFm ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = photo_effDS2)

#models with random effect for coral species or study
modDS4 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = photo_effDS2)
modDS5 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = photo_effDS2)
modDS6 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = photo_effDS2)
modDS7 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = photo_effDS2)
modDS8 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = photo_effDS2)
modDS9 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = photo_effDS2)
modDS10 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = photo_effDS2)
modDS11 <- glmer(Binary_reduced_FvFm ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = photo_effDS2)
modDS12 <- glmer(Binary_reduced_FvFm ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = photo_effDS2)

#Model comparison and summary
anova(modDS6,modDS9,modDS12) #compare full fixed effects models -- mod9 or 12 are best
anova(modDS7,modDS8,modDS9) #No evidence against reduced model (mod7)
anova(modDS10,modDS11,modDS12) #No evidence against reduced model (mod10)
anova(modDS4,modDS7,modDS10,modDS11) #compare reduced fixed effects models -- mod7 is best
print(summary(modDS7), correlation=FALSE) #no errors
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDS7, type="response")>0.5)
#proportion correct:
mean(p==photo_effDS2$Binary_reduced_FvFm) #[1] 0.6706827
#predicted-vs-observed table:
table(p,photo_effDS2$Binary_reduced_FvFm)
#ROC and area under the curve:
pred_modDS7 <- predict(modDS7, newdata = photo_effDS2, type = "response")
auc(roc(photo_effDS2$Binary_reduced_FvFm, pred_modDS7)) #AUC: 0.7535
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDS7) #The fixed effect of sediment level explains ~0.3% of variation of the total variation. If the random intercepts for studies are also included, then 55.8% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDS7))
dotplot(ranef(modDS7, condVar = T)) #residual variation at the level of studies -- variation among studies is large
qqnorm(ranef(modDS7)$Ref[,1])
qqline(ranef(modDS7)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDS7) #SD=2.0307 
exp(sqrt(VarCorr(modDS7)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
modDS7_noSed <- glmer(Binary_reduced_FvFm ~ 1 + (1 | Ref), 
                    family = binomial, data = photo_effDS2)
random.intercepts <- ranef(modDS7)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDS7)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDS7)["Sed_level_stand_mg"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS7)["Sed_level_stand_mg"]*x)), 
                    from = min(photo_effDS2$Sed_level_stand_mg), to = max(photo_effDS2$Sed_level_stand_mg), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDS7)["Sed_level_stand_mg"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS7)["Sed_level_stand_mg"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Main effects are not significant, only interaction...
#se <- sqrt(diag(vcov(modDS10)))
#tab <- cbind(Est = fixef(modDS10), 
#             LL = fixef(modDS10) - 1.96 * se, 
#             UL = fixef(modDS10) + 1.96 * se)
#2^(tab)
```
    
There is no significant relationship between deposited sediment exposure and the odds of reduced photosynthetic efficiency (GLMM z = -0.388, p = 0.698).
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDS10 <- predict(modDS10, newdata=photo_effDS2, type="response")
photo_effDS3 <- cbind(photo_effDS2, pred_modDS10)

photo_effDS_plot <- ggplot(data = photo_effDS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_FvFm)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Reduced photosynthetic efficiency\ndue to sediment exposure?") +
    scale_x_log10(limits=c(0.01,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modDS10), inherit.aes=FALSE) +
    theme_bw()

photo_effDS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
```{r}
jvalues <- with(photo_effDS2, seq(from = min(Sed_level_stand_mg), to = max(Sed_level_stand_mg), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    photo_effDS2$Sed_level_stand_mg <- j
    predict(modDS10, newdata = photo_effDS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_stand_mg values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
photo_effDS_plot2 <- ggplot() +
    geom_point(data = photo_effDS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_FvFm,
      color=Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of reduced photosynthetic\nefficiency due to sediment exposure",
         color = "Binary data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000,loaelDS1),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelDS1,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelDS1, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

photo_effDS_plot2
```
  
### P/R Ratio
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
PR_ratioDS2 <- PR_ratio %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg)) %>% 
  mutate(log10_dur=log10(Sed_exposure_days)) %>% 
  filter(Control_code=="0")
PR_ratioDS2 %>% tally()
PR_ratioDS2 %>% count(Ref)
unique(PR_ratioDS2[c("Ref","Gsp")])

#Models with fixed effect(s) only
modDSb1 <- glm(Binary_reduced_PR_ratio ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = PR_ratioDS2)
modDSb2 <- glm(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = PR_ratioDS2)
modDSb3 <- glm(Binary_reduced_PR_ratio ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = PR_ratioDS2)

#models with random effect for coral species or study
modDSb4 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = PR_ratioDS2)
modDSb5 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = PR_ratioDS2)
modDSb6 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = PR_ratioDS2)
modDSb7 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = PR_ratioDS2)
modDSb8 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = PR_ratioDS2)
modDSb9 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = PR_ratioDS2)
modDSb10 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = PR_ratioDS2)
modDSb11 <- glmer(Binary_reduced_PR_ratio ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = PR_ratioDS2)
modDSb12 <- glmer(Binary_reduced_PR_ratio ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = PR_ratioDS2)

#Model comparison and summary
anova(modDSb6,modDSb9,modDSb12) #compare full fixed effects models -- mod9 is best
anova(modDSb7,modDSb8,modDSb9) #mod8
anova(modDSb4,modDSb7,modDSb10) #compare reduced fixed effects models -- mod7 is best
print(summary(modDSb8), correlation=FALSE)
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDSb8, type="response")>0.5)
#proportion correct:
mean(p==PR_ratioDS2$Binary_reduced_PR_ratio) #[1] 1
#predicted-vs-observed table:
table(p,PR_ratioDS2$Binary_reduced_PR_ratio)
#ROC and area under the curve:
pred_modDSb8 <- predict(modDSb8, newdata = PR_ratioDS2, type = "response")
auc(roc(PR_ratioDS2$Binary_reduced_PR_ratio, pred_modDSb8)) #AUC: 1
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDSb8) #The fixed effect of sediment level explains ~0.3% of variation of the total variation. If the random intercepts for studies are also included, then 55.8% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDSb8))
dotplot(ranef(modDSb8, condVar = T)) #residual variation at the level of studies -- variation among studies is large
qqnorm(ranef(modDSb8)$Ref[,1])
qqline(ranef(modDSb8)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDSb8) #SD=2.0307 
exp(sqrt(VarCorr(modDSb8)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
modDSb8_noSed <- glmer(Binary_reduced_PR_ratio ~ 1 + (1 | Ref), 
                    family = binomial, data = PR_ratioDS2)
random.intercepts <- ranef(modDSb8)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDSb8)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDSb8)["Sed_level_stand_mg"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSb8)["Sed_level_stand_mg"]*x)), 
                    from = min(PR_ratioDS2$Sed_level_stand_mg), to = max(PR_ratioDS2$Sed_level_stand_mg), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDSb8)["Sed_level_stand_mg"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSb8)["Sed_level_stand_mg"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modDSb8)))
tab <- cbind(Est = fixef(modDSb8), 
             LL = fixef(modDSb8) - 1.96 * se, 
             UL = fixef(modDSb8) + 1.96 * se)
2^(tab)
```
    
For every doubling in exposure duration of deposited sediment, the odds of reduced P/R ratio increases by 21.1 times (95% CI 4.2, 106.8; GLMM z = 3.685, p = 0.0002), after accounting for exposure concentration. There is no significant relationship between sediment exposure concentration and the odds of reduced P/R ratio (GLMM z = -0.138, p = 0.890). However, all the variability in the model that describes this relationship is attributable to study (R2 = 0.017 with fixed effects only, R2 = 1.000 with fixed effects + random effect of study).
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDSb8 <- predict(modDSb8, newdata=PR_ratioDS2, type="response")
PR_ratioDS3 <- cbind(PR_ratioDS2, pred_modDSb8)

PR_ratioDS_plot <- ggplot(data = PR_ratioDS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_PR_ratio,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Reduced P/R ratio due to sediment exposure?",
         color = "Study") +
    scale_x_continuous(limits=c(0,200)) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modDSb8), inherit.aes=FALSE) +
    theme_bw()

PR_ratioDS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By exposure concentration
```{r}
jvalues <- with(PR_ratioDS2, seq(from = min(Sed_level_stand_mg), to = max(Sed_level_stand_mg), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    PR_ratioDS2$Sed_level_stand_mg <- j
    predict(modDSb8, newdata = PR_ratioDS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_stand_mg values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
PR_ratioDS_plot2 <- ggplot() +
    geom_point(data = PR_ratioDS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_PR_ratio,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of reduced\nP/R ratio due to sediment exposure",
         color = "Binary data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,200), breaks=c(0,50,100,150,200,loaelDS2),
                       labels=c("0","50","100","150","200",round(loaelDS2,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelDS2, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

PR_ratioDS_plot2
```
  
##### By exposure duration
```{r}
jvalues <- with(PR_ratioDS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    PR_ratioDS2$Sed_exposure_days <- j
    predict(modDSb8, newdata = PR_ratioDS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
PR_ratioDS_plot2 <- ggplot() +
    geom_point(data = PR_ratioDS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_reduced_PR_ratio,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of reduced\nP/R ratio due to sediment exposure",
         color = "Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,30)) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

PR_ratioDS_plot2
```
  
  
## SUSPENDED SEDIMENT
### Photosynthetic Efficiency
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
photo_effSS2 <- photo_effSS %>% 
  filter(Control_code=="0") %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg)) %>% 
  mutate(log10_dur=log10(Sed_exposure_days))
photo_effSS2 %>% tally()

#Models with fixed effect(s) only
modSS1 <- glm(Binary_reduced_FvFm ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = photo_effSS2)
modSS2 <- glm(Binary_reduced_FvFm ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = photo_effSS2)
modSS3 <- glm(Binary_reduced_FvFm ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = photo_effSS2)

#models with random effect for coral species or study
modSS4 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = photo_effSS2)
modSS5 <- glmer(Binary_reduced_FvFm ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = photo_effSS2)
modSS6 <- glmer(Binary_reduced_FvFm ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp),
                family = binomial, data = photo_effSS2)
modSS7 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = photo_effSS2)
modSS8 <- glmer(Binary_reduced_FvFm ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
                family = binomial, data = photo_effSS2)
modSS9 <- glmer(Binary_reduced_FvFm ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Ref),
                family = binomial, data = photo_effSS2)
modSS10 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = photo_effSS2)
modSS11 <- glmer(Binary_reduced_FvFm ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = photo_effSS2)
modSS12 <- glmer(Binary_reduced_FvFm ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = photo_effSS2)
modSS13 <- glmer(Binary_reduced_FvFm ~ Sed_level_stand_mg + (1 | Ref_name/Ref), 
              family = binomial, data = photo_effSS2)
modSS14 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = photo_effSS2)
modSS15 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = photo_effSS2)
modSS16 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = photo_effSS2)
modSS17 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = photo_effSS2)
modSS18 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = photo_effSS2)
modSS19 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = photo_effSS2)
modSS20 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = photo_effSS2)
modSS21 <- glmer(Binary_reduced_FvFm ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = photo_effSS2)

#model comparison and summary
anova(modSS6,modSS9,modSS12,modSS15,modSS18,modSS21) #compare full fixed effects models -- mod6 is best (12 and 18 close)
anova(modSS4,modSS5,modSS6) #mod5
anova(modSS4,modSS7,modSS10,modSS13,modSS16,modSS19) #compare reduced fixed effects models -- mod4 is best
print(summary(modSS5), correlation=FALSE) #no error
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSS5, type="response")>0.5)
#proportion correct:
mean(p==photo_effSS2$Binary_reduced_FvFm) #[1] 0.9777778
#predicted-vs-observed table:
table(p,photo_effSS2$Binary_reduced_FvFm)
#ROC and area under the curve:
pred_modSS5 <- predict(modSS5, newdata = photo_effSS2, type = "response")
auc(roc(photo_effSS2$Binary_reduced_FvFm, pred_modSS5)) #AUC: 0.9859
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSS5) #The fixed effect of sediment level explains ~10% of variation of the total variation. If the random intercepts for studies are also included, then 97% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modSS5))
dotplot(ranef(modSS5, condVar = T)) #residual variation at the level of studies -- variation among studies is large
qqnorm(ranef(modSS5)$Gsp[,1])
qqline(ranef(modSS5)$Gsp[,1]) #distribution of random effects looks good
VarCorr(modSS5) #SD=2.0307 
exp(sqrt(VarCorr(modSS5)$Gsp[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
modSS5_noSed <- glmer(Binary_reduced_FvFm ~ 1 + (1 | Gsp), 
                    family = binomial, data = photo_effSS2)
random.intercepts <- ranef(modSS5)$Gsp[["(Intercept)"]]
Gsp.intercepts <- fixef(modSS5)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Gsp.intercepts[i] + fixef(modSS5)["Sed_level_stand_mg"]*x)/(1 + exp(Gsp.intercepts[i] + fixef(modSS5)["Sed_level_stand_mg"]*x)), 
                    from = min(photo_effSS2$Sed_level_stand_mg), to = max(photo_effSS2$Sed_level_stand_mg), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Gsp.intercepts[i] + fixef(modSS5)["Sed_level_stand_mg"]*x)/(1 + exp(Gsp.intercepts[i] + fixef(modSS5)["Sed_level_stand_mg"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Not significant
se <- sqrt(diag(vcov(modSS5)))
tab <- cbind(Est = fixef(modSS5), 
             LL = fixef(modSS5) - 1.96 * se, 
             UL = fixef(modSS5) + 1.96 * se)
2^(tab)
```
    
There is no significant relationship between exposure concentration of suspended sediment and the odds of reduced photosynthetic efficiency (GLMM z = 0.976, p = 0.329), though there is suggestive, but non-significant evidence that for every doubling of exposure duration that the odds of reduced photosynthetic efficiency increase by 1.1 times (95% CI 1.0, 1.2; GLMM z = 1.732, p = 0.083).
  
#### Prediction figures  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSS5 <- predict(modSS5, newdata=photo_effSS2, type="response")
photo_effSS3 <- cbind(photo_effSS2, pred_modSS5)

photo_effSS_plot <- ggplot(data = photo_effSS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_FvFm,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Reduced photosynthetic efficiency due to sediment exposure",
         color = "Study") +
    scale_x_log10(limits=c(1,250),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modSS5), inherit.aes=FALSE) +
    theme_bw()

photo_effSS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By sediment exposure concentration
```{r}
jvalues <- with(photo_effSS2, seq(from = min(Sed_level_stand_mg), to = max(Sed_level_stand_mg), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    photo_effSS2$Sed_level_stand_mg <- j
    predict(modSS5, newdata = photo_effSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_stand_mg values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
photo_effSS_plot2 <- ggplot() +
    geom_point(data = photo_effSS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_FvFm,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of reduced photosynthetic\nefficiency due to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(1,max(photo_effSS2$Sed_level_stand_mg)), 
                  breaks=c(0.01,0.1,1,10,100,1000,loaelSS1),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelSS1,digits = 1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS1, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

photo_effSS_plot2
```
  
##### By sediment exposure duration
```{r}
jvalues <- with(photo_effSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    photo_effSS2$Sed_exposure_days <- j
    predict(modSS5, newdata = photo_effSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
photo_effSS_plot3 <- ggplot() +
    geom_point(data = photo_effSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_reduced_FvFm,
      color = Ref)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of reduced photosynthetic\nefficiency due to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(photo_effSS2$Sed_exposure_days))) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

photo_effSS_plot3
```
  
### P/R Ratio
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
PR_ratioSS2 <- PR_ratioSS %>% 
  filter(Control_code=="0") %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg)) %>% 
  mutate(log10_dur=log10(Sed_exposure_days))
PR_ratioSS2 %>% tally()

#Models with fixed effect(s) only
modSSb1 <- glm(Binary_reduced_PR_ratio ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = PR_ratioSS2)
modSSb2 <- glm(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = PR_ratioSS2)
modSSb3 <- glm(Binary_reduced_PR_ratio ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = PR_ratioSS2)

#models with random effect for coral species or study
modSSb4 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = PR_ratioSS2)
modSSb5 <- glmer(Binary_reduced_PR_ratio ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = PR_ratioSS2)
modSSb6 <- glmer(Binary_reduced_PR_ratio ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp),
                family = binomial, data = PR_ratioSS2)
modSSb7 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = PR_ratioSS2)
modSSb8 <- glmer(Binary_reduced_PR_ratio ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
                family = binomial, data = PR_ratioSS2)
modSSb9 <- glmer(Binary_reduced_PR_ratio ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Ref),
                family = binomial, data = PR_ratioSS2)
modSSb10 <- glmer(Binary_reduced_PR_ratio ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = PR_ratioSS2)
modSSb11 <- glmer(Binary_reduced_PR_ratio ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = PR_ratioSS2)
modSSb12 <- glmer(Binary_reduced_PR_ratio ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = PR_ratioSS2)

#model comparison and summary
anova(modSSb6,modSSb9,modSSb12) #compare full fixed effects models -- mod6 or 9 is best
anova(modSSb7,modSSb8,modSSb9) #No evidence against reduced model (mod7)
anova(modSSb4,modSSb7,modSSb10) #compare reduced fixed effects models -- mod4 or 7
print(summary(modSSb7), correlation=FALSE) #singular
print(summary(modSSb4), correlation=FALSE) #no error
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSSb4, type="response")>0.5)
#proportion correct:
mean(p==PR_ratioSS2$Binary_reduced_PR_ratio) #[1] 0.8529412
#predicted-vs-observed table:
table(p,PR_ratioSS2$Binary_reduced_PR_ratio)
#ROC and area under the curve:
pred_modSSb4 <- predict(modSSb4, newdata = PR_ratioSS2, type = "response")
auc(roc(PR_ratioSS2$Binary_reduced_PR_ratio, pred_modSSb4)) #AUC: 0.6655
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSSb4) #The fixed effect of sediment level explains 5% of variation of the total variation. If the random intercepts for studies are also included, then 8% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modSSb4))
dotplot(ranef(modSSb4, condVar = T)) #residual variation at the level of studies
qqnorm(ranef(modSSb4)$Gsp[,1])
qqline(ranef(modSSb4)$Gsp[,1]) #distribution of random effects looks good
VarCorr(modSSb4) #SD=2.0307 
exp(sqrt(VarCorr(modSSb4)$Gsp[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
modSSb4_noSed <- glmer(Binary_reduced_PR_ratio ~ 1 + (1 | Gsp), 
                    family = binomial, data = PR_ratioSS2)
random.intercepts <- ranef(modSSb4)$Gsp[["(Intercept)"]]
Gsp.intercepts <- fixef(modSSb4)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Gsp.intercepts[i] + fixef(modSSb4)["Sed_level_stand_mg"]*x)/(1 + exp(Gsp.intercepts[i] + fixef(modSSb4)["Sed_level_stand_mg"]*x)), 
                    from = min(PR_ratioSS2$Sed_level_stand_mg), to = max(PR_ratioSS2$Sed_level_stand_mg), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Gsp.intercepts[i] + fixef(modSSb4)["Sed_level_stand_mg"]*x)/(1 + exp(Gsp.intercepts[i] + fixef(modSSb4)["Sed_level_stand_mg"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Not significant
#se <- sqrt(diag(vcov(modSSb4)))
#tab <- cbind(Est = fixef(modSSb4), 
#             LL = fixef(modSSb4) - 1.96 * se, 
#             UL = fixef(modSSb4) + 1.96 * se)
#exp(tab)
```
  
There is no significant relationship between exposure concentration of suspended sediment and the odds of a reduced P/R ratio (GLMM z = 0.929, p = 0.353), but the best-fit model to explain this relationship explains only 8% of the variance, indicating that more data is needed.
  
#### Prediction figures  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSSb4 <- predict(modSSb4, newdata=PR_ratioSS2, type="response")
PR_ratioSS3 <- cbind(PR_ratioSS2, pred_modSSb4)

PR_ratioSS_plot <- ggplot(data = PR_ratioSS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_PR_ratio,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Reduced P/R ratio due to sediment exposure",
         color = "Study") +
    scale_x_log10(limits=c(10,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modSSb4), inherit.aes=FALSE) +
    theme_bw()

PR_ratioSS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By sediment exposure concentration
```{r}
jvalues <- with(PR_ratioSS2, seq(from = min(Sed_level_stand_mg), to = max(Sed_level_stand_mg), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    PR_ratioSS2$Sed_level_stand_mg <- j
    predict(modSSb4, newdata = PR_ratioSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_stand_mg values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
PR_ratioSS_plot2 <- ggplot() +
    geom_point(data = PR_ratioSS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_reduced_PR_ratio,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of reduced\nP/R ratio to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(10,max(PR_ratioSS2$Sed_level_stand_mg)), 
                  breaks=c(0.01,0.1,1,10,100,1000,loaelSS2),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelSS2,digits = 1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS2, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

PR_ratioSS_plot2
```
  
##### By sediment exposure duration
```{r}
jvalues <- with(PR_ratioSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    PR_ratioSS2$Sed_exposure_days <- j
    predict(modSSb4, newdata = PR_ratioSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
PR_ratioSS_plot3 <- ggplot() +
    geom_point(data = PR_ratioSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_reduced_PR_ratio,
      color = Ref)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of reduced\nP/R ratio to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(PR_ratioSS2$Sed_exposure_days))) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

PR_ratioSS_plot3
```
