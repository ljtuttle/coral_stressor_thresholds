---
title: "Binary effects of sediment on bleaching of adult corals"
author: "Lillian J. Tuttle"
date: "9/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(lme4)
library(pROC)
library(effects)
library(lattice)
library(MuMIn)
binary <- read.csv("data/binary_ALL.csv", header=T)

#keyboard shortcuts to remember: 
#command-option-I inserts new code chunk
#command-shift-M inserts pipeline symbols
#command-enter runs line of code where cursor is (or highlighted portion)
```

#### Here I will explore how DEPOSITED AND SUSPENDED sediment affects the BLEACHING of tropical, scleractinean coral ADULTS. The database to be used is comprised of data extracted from studies deemed relevant during the systematic literature review process.

# The Dataset
  
## Deposited Sediment 
Specifically, we will explore the results of 523 datapoints from 21 studies conducted in 3 oceans on 52 species within 32 genera (shown below only the top 10 species and genera, by number of datapoints).

```{r, echo=FALSE, warning=FALSE}
#head(bleach)
bleachingDS <- binary %>%
  filter(DS_SS=="DS") %>% 
  filter(!is.na(Binary_bleaching_or_reduced_chla)) %>% 
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_"))
  
bleachingDS %>% tally() #n=523 datapoints, tally() returns same result as count(bleachingDS)
bleachingDS %>% count(Ref, sort=T) #n=21 studies,
bleachingDS %>% count(Ref_name, sort=T) #n=21 articles, count(Ref_name) = group_by(Ref_name) %>% tally()
bleachingDS %>% count(Ocean, sort=T) #n=3 oceans
bleachingDS %>% count(Gsp, sort=T) %>% #n=52 species
  top_n(10)
bleachingDS %>% count(Updated_Genus, sort=T) %>% #n=32 genera
  top_n(10)
```
  
## Suspended Sediment  
Specifically, we will explore the results of 92 datapoints from 7 studies conducted in 2 oceans on 10 species within 6 genera.

```{r, echo=FALSE, warning=FALSE}
#head(binarySS)
bleachingSS <- binary %>%
  filter(DS_SS=="SS") %>% 
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(Coral_age_class=="adult") %>% #only adult corals
  filter(!is.na(Binary_bleaching_or_reduced_chla))
bleachingSS %>% tally() #n=92 datapoints, tally() returns same result as count(bleachingSS)
bleachingSS %>% count(Ref, sort=T) #n=7 studies
bleachingSS %>% count(Ref_name, sort=T) #n=7 articles, count(Ref_name) = group_by(Ref_name) %>% tally()
bleachingSS %>% count(Ocean, sort=T) #n=2 oceans (another is the "Indo-Pacific", e.g. Singapore)
bleachingSS %>% count(Gsp, sort=T) #n=10 species
bleachingSS %>% count(Updated_Genus, sort=T) #n=6 genera
```

# Exploratory plots

First let's explore all data from all species for which there is binary data about the presence of a reduction in 'bleaching' as a result of exposure to deposited/suspended sediment.  

##### DEFINITIONS:  
* '**Bleaching**' is defined within each study, and reflects any bleaching of any tissue with respect to a control.

```{r, echo=FALSE, warning=FALSE}
#DEPOSITED SEDIMENT
#bleaching, plotted by exposure concentration (x) and exposure duration (y)
bleach <- bleachingDS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Binary_bleaching_or_reduced_chla, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Binary_sed_burial) %>% 
  filter(Binary_sed_burial=="0") %>% #remove all studies that buried corals instead of giving them a specific dosage (in mg/cm2/day)
  filter(!is.na(Binary_bleaching_or_reduced_chla)) #remove NAs (studies that did not describe photosynthetic efficiency)
#bleach %>% tally() #n=497 datapoints, tally() returns same result as count(bleach)
#bleach %>% count(Ref_name, sort=T) #n=20 articles, count(Ref_name) = group_by(Ref_name) %>% tally()
#bleach %>% count(Ref, sort=T) #n=20 studies
#bleach %>% count(Gsp) #n=52 species
#bleach %>% count(Updated_Genus, sort=T) #n=32 genera, top four: Porites n=150, Montipora n=65, Acropora n=59, Leptoria n=42
#head(bleach)

bleach_plot <- ggplot(data=bleach, mapping=aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_bleaching_or_reduced_chla),
      shape = factor(Binary_bleaching_or_reduced_chla),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(bleach, Binary_bleaching_or_reduced_chla=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000), 
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(0.1,100), breaks=c(0.1,1,10,100), 
                  label=c("0.1","1","10","100")) +
    scale_color_manual(name = "Bleaching due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Bleaching due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#SUSPENDED SEDIMENT
#bleaching, plotted by exposure concentration (x) and exposure duration (y)
bleachSS <- bleachingSS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Binary_bleaching_or_reduced_chla, Updated_Genus, Gsp, Ocean, Sed_exposure_days)
#bleachSS %>% tally() #n=92 datapoints, tally() returns same result as count(bleach)
#bleachSS %>% count(Ref_name, sort=T) #n=7 articles, count(Ref_name) = group_by(Ref_name) %>% tally()
#bleachSS %>% count(Ref, sort=T) #n=8 studies
#bleachSS %>% count(Gsp) #n=10 species
#bleachSS %>% count(Updated_Genus, sort=T) #n=6 genera, top four: Acropora n=49, Montipora n=26, Dichocoenia n=6, Meandrina n=6
#head(bleach)

bleachSS_plot <- ggplot(data=bleachSS, mapping=aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_bleaching_or_reduced_chla),
      shape = factor(Binary_bleaching_or_reduced_chla),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(bleachSS, Binary_bleaching_or_reduced_chla=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_continuous(trans='log10', limits = c(0.1,1000), 
                       breaks=c(0.1,1,10,100,1000), 
                       label=c("0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(1,100), breaks=c(1,10,100), 
                  label=c("1","10","100")) +
    scale_color_manual(name = "Bleaching due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Bleaching due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#PLOTS:
bleach_plot + geom_point(data = subset(bleach, Binary_bleaching_or_reduced_chla=="1")) +
  labs(title = "Bleaching from Deposited Sediment",
  subtitle = "n = 497 datapoints, n = 20 studies from 20 articles, n = 52 spp. from 32 genera")
bleachSS_plot + geom_point(data = subset(bleachSS, Binary_bleaching_or_reduced_chla=="1")) +
  labs(title = "Bleaching from Suspended Sediment",
  subtitle = "n = 92 datapoints, n = 8 studies from 7 articles, n = 10 spp. from 6 genera")
```
  
  
# Threshold Analyses with Binary Data 
Now let's calculate thresholds based on the binary data explored above.  

##### DEFINITIONS:  
* '**LOAEL**', or the 'lowest observed adverse effect level' is defined as the lowest dose at which there was an observed adverse effect.  
* '**NOAEL**', or the 'no observed adverse effect level' is defined as the highest dose at which there was NOT an observed adverse effect.  
* '**Adverse effect**' is defined here as any response of a coral individual, colony, or experimental treatment group that *may* negatively affect the coralâ€™s fitness and/or survival. These adverse effects may include sublethal physiological changes (e.g., significantly reduced growth or photosynthetic rates when compared to coral in ambient/control conditions), bleaching/tissue loss, and mortality.  This definition of adverse effect is independent of its magnitude, so while the affect may have potentially reduced fitness, its magnitude may be sufficiently small that the fitness effect is not measureable.  
  
  
## DEPOSITED SEDIMENT 
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_bleach <- bleach %>% 
  filter(Binary_bleaching_or_reduced_chla=="1") %>%
  arrange(Sed_level_stand_mg) %>% #minimum Sedimentation level is 0! --> Looked at this particular row, and it is from Hodel 2007 who studied the recovery period post-exposure (hence sed level is 0 but still experiencing mortality). Therefore, this will not be an accurate LOAEL
  filter(Sed_level_stand_mg>0) #removed Hodel sample described above

#LOAEL
summarize(adverse_bleach, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 4.9 and comes from Sofonia (2006) PhD Chapter 4
loael <- adverse_bleach %>% summarize(min(Sed_level_stand_mg))
loael <- as.numeric(loael)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_bleach <- bleach %>%
  filter(Binary_bleaching_or_reduced_chla=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=4.9) #less than or equal to the LOAEL, which = 4.9

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_bleach, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 4.9

#PLOT
#bleaching %>% 
#  select(Ocean, Region, Genus, species, Binary_sed_burial, Sed_level_stand_mg, #Binary_bleaching_or_reduced_chla) %>% 
#  filter(Binary_sed_burial=="0") %>% #remove all studies that buried corals instead of #giving them a specific dosage (in mg/cm2/day)
#  ggplot() +
#    geom_point(mapping = aes(
#      x = Sed_level_stand_mg, 
#      y = Binary_bleaching_or_reduced_chla)) + 
#    labs(x = "Sedimentation rate (mg/cm2/d)", 
#         y = "Bleaching due\nto sedimentation?") +
#    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
#                  label=c("0.01","0.1","1","10","100","1000")) +
#    theme_bw() +
#    annotate("rect", xmin=4.9, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_bleach2 <- bleach %>% 
  filter(Binary_bleaching_or_reduced_chla=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>% 
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_bleach2, LOAEL=min(Sed_exposure_days)) #LOAEL is 0.92 days = 22h

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_bleach2 <- bleach %>%
  filter(Binary_bleaching_or_reduced_chla=="0") %>%
  filter(Sed_exposure_days<=0.92) #less than or equal to the LOAEL, which = 21

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_bleach2, NOAEL=max(Sed_exposure_days)) #NOAEL is 0.92 days

#PLOT LOAELs
#bleach_plot + labs(title = "Bleaching from Deposited Sediment", 
#                   subtitle = "n=497 datapoints, n=20 studies, n=32 genera", 
#                   caption = "LOAEL concentration = 4.9 mg/cm2/day, duration = 22 hours\nNOAEL #concentration = 4.9 mg/cm2/day, duration =  22 hours\nShaded box represents 'risky' exposure area") +
#    annotate("rect", xmin=4.9, xmax=Inf, ymin=0.92, ymax=Inf, fill = "red", alpha=0.2)

bleach_plot + geom_point(data = subset(bleach, Binary_bleaching_or_reduced_chla=="1")) +
  labs(caption = "LOAEL concentration = 4.9, duration = 22 h\nNOAEL concentration = 4.9, duration =  22 h\nShaded box represents 'risky' exposure area\nn = 497 datapoints, n = 20 studies from 20 articles, n = 52 spp. from 32 genera") +
    annotate("rect", xmin=4.9, xmax=Inf, ymin=0.92, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
## SUSPENDED SEDIMENT 
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_bleachSS <- bleachSS %>% 
  filter(Binary_bleaching_or_reduced_chla=="1") %>%
  arrange(Sed_level_stand_mg)

#LOAEL
summarize(adverse_bleachSS, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 3.22 and comes from Flores et al. (2012) with Acropora millepora for 84 days exposure
loaelSS <- adverse_bleachSS %>% summarize(min(Sed_level_stand_mg))
loaelSS <- as.numeric(loaelSS)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_bleachSS <- bleachSS %>%
  filter(Binary_bleaching_or_reduced_chla=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=3.22) #less than or equal to the LOAEL, which = 3.22

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_bleachSS, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 3.22

#PLOT
bleachingSS %>% 
  select(Ocean, Gsp, Sed_level_stand_mg, Binary_bleaching_or_reduced_chla) %>% 
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg,
      y = Binary_bleaching_or_reduced_chla)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Bleaching due\nto sedimentation?") +
    scale_x_continuous(trans='log10', breaks=c(0.01,0.1,1,10,100,1000), label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_bleachSS2 <- bleachSS %>% 
  filter(Binary_bleaching_or_reduced_chla=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>% 
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_bleachSS2, LOAEL=min(Sed_exposure_days)) #LOAEL is 1 day

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_bleachSS2 <- bleachSS %>%
  filter(Binary_bleaching_or_reduced_chla=="0") %>%
  filter(Sed_exposure_days<=1) #less than or equal to the LOAEL, which = 1

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_bleachSS2, NOAEL=max(Sed_exposure_days)) #NOAEL is 0 days

#PLOT LOAELs
#bleachSS_plot + labs(title = "Bleaching from Suspended Sediment",
#                     subtitle = "All species, n=92 datapoints, n=7 studies, n=6 genera",
#                     caption = "LOAEL concentration = 3.22 mg/L, duration = 1 day\nNOAEL #concentration = 3.22 mg/L, duration =  1 day\nShaded box represents 'risky' exposure area") +
#  annotate("rect", xmin=3.22, xmax=Inf, ymin=1, ymax=Inf, fill = "red", alpha=0.2)

bleachSS_plot + geom_point(data = subset(bleachSS, Binary_bleaching_or_reduced_chla=="1")) +
  labs(caption = "LOAEL concentration = 3.22, duration = 1 d\nNOAEL concentration = 3.22, duration =  1 d\nShaded box represents 'risky' exposure area\nn = 92 datapoints, n = 8 studies from 7 articles, n = 10 spp. from 6 genera") +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=1, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
# Logistic Regression Model Fitting  
## Deposited Sediment
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
bleachDS2 <- bleach %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg)) %>% 
  filter(Control_code=="0")
bleachDS2 %>% tally() 

#Models with fixed effect(s) only
modDS1 <- glm(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = bleachDS2)
modDS2 <- glm(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = bleachDS2)
modDS3 <- glm(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = bleachDS2)

#models with random effect for coral species or study
modDS4 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = bleachDS2)
modDS5 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = bleachDS2)
modDS6 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = bleachDS2)
modDS7 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = bleachDS2)
modDS8 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = bleachDS2)
modDS9 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = bleachDS2)
modDS10 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = bleachDS2)
modDS11 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = bleachDS2)
modDS12 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = bleachDS2)

#Model comparison and summary
anova(modDS6,modDS9,modDS12) #compare full fixed effects models -- mod12 is best
anova(modDS10,modDS11,modDS12) #No evidence against reduced model (mod10)
anova(modDS4,modDS7,modDS10) #compare reduced fixed effects models -- mod10 is best
#print(summary(modDS10), correlation=FALSE) #No errors
#Model is nearly unidentifiable: very large eigenvalue - Rescale variables?
#Model is nearly unidentifiable: large eigenvalue ratio - Rescale variables?

#Trying out a log transformation of predictor...
modDS10_log <- glmer(Binary_bleaching_or_reduced_chla ~ log10_conc + (1 | Gsp) + (1 | Ref), 
                     family = binomial, data = bleachDS2)
print(summary(modDS10_log), correlation=FALSE)
#No errors!
```
  
### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDS10_log, type="response")>0.5)
#proportion correct:
mean(p==bleachDS2$Binary_bleaching_or_reduced_chla) #[1] 0.9488636
#predicted-vs-observed table:
table(p,bleachDS2$Binary_bleaching_or_reduced_chla)
#ROC and area under the curve:
pred_modDS10_log <- predict(modDS10_log, newdata = bleachDS2, type = "response")
auc(roc(bleachDS2$Binary_bleaching_or_reduced_chla, pred_modDS10_log)) #AUC: 0.9888
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDS10_log) #The fixed effect of sediment level explains ~0.7% of variation of the total variation. If the random intercepts for studies are also included, then 94% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDS10_log))
dotplot(ranef(modDS10_log, condVar = T)) #residual variation at the level of studies/species -- variation is large!
qqnorm(ranef(modDS10_log)$Ref[,1])
qqline(ranef(modDS10_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDS10_log) #SD=4.8,5.3
exp(sqrt(VarCorr(modDS10_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(sd) = x (?)
modDS10_log_noSed <- glmer(Binary_bleaching_or_reduced_chla ~ 1 + (1 | Gsp) + (1 | Ref), 
                           family = binomial, data = bleachDS2)
random.intercepts <- ranef(modDS10_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDS10_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDS10_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS10_log)["log10_conc"]*x)), 
                    from = min(bleachDS2$log10_conc), to = max(bleachDS2$log10_conc), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "log10(exposure concentration, mg/cm2/d)")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDS10_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS10_log)["log10_conc"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modDS10_log)))
tab <- cbind(Est = fixef(modDS10_log), 
             LL = fixef(modDS10_log) - 1.96 * se, 
             UL = fixef(modDS10_log) + 1.96 * se)
exp(tab)
#                     Est           LL         UL
#(Intercept) 0.0002897729 5.395869e-07  0.1556159
#log10_conc  3.6741180168 1.256104e+00 10.7468337

```
    
For every 10-fold increase in sediment exposure, the odds of bleaching increase by 3.7 times (95% CI 1.3, 10.7, GLMM z = 2.376, p = 0.018), after accounting for variation among studies and species. 
  
### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDS10_log <- predict(modDS10_log, newdata=bleachDS2, type="response")
bleachDS3 <- cbind(bleachDS2, pred_modDS10_log)

bleachDS_plot <- ggplot(data = bleachDS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_bleaching_or_reduced_chla,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Bleaching due to sediment exposure?",
         color = "Study") +
    scale_x_log10(limits=c(1,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modDS10_log), inherit.aes=FALSE) +
    theme_bw()

bleachDS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
```{r}
jvalues <- with(bleachDS2, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    bleachDS2$log10_conc <- j
    predict(modDS10_log, newdata = bleachDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## 
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))
plotdat <- plotdat %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_conc", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
bleachDS_plot2 <- ggplot() +
    geom_point(data = bleachDS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_bleaching_or_reduced_chla)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of bleaching\ndue to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(1,1000), breaks=c(0.01,0.1,1,10,100,1000,loael),
                  label=c("0.01","0.1","1","10","100","1000",round(loael,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loael, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))# +
#    guides(color = guide_legend(override.aes = list(size = 0.5))) + 
#    theme(legend.title = element_text(size = 3), 
#          legend.text = element_text(size = 3))

bleachDS_plot2
```
  
## Suspended Sediment
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
bleachSS2 <- bleachSS %>% 
  filter(Control_code=="0") %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg))
bleachSS2 %>% tally()

#Models with fixed effect(s) only
modSS1 <- glm(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = bleachSS2)
modSS2 <- glm(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = bleachSS2)
modSS3 <- glm(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = bleachSS2)

#models with random effect for coral species or study
modSS4 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = bleachSS2)
modSS5 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = bleachSS2)
#modSS6 <- glmer(Binary_bleaching_or_reduced_chla ~ 
#                  Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp),
#                family = binomial, data = bleachSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : Downdated VtV is not positive definite
modSS7 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = bleachSS2)
modSS8 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
                family = binomial, data = bleachSS2)
#modSS9 <- glmer(Binary_bleaching_or_reduced_chla ~ 
#                  Sed_level_stand_mg*Sed_exposure_days + (1 | Ref),
#                family = binomial, data = bleachSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : Downdated VtV is not positive definite
modSS10 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = bleachSS2)
modSS11 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = bleachSS2)
#modSS12 <- glmer(Binary_bleaching_or_reduced_chla ~ 
#                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
#              family = binomial, data = bleachSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSS13 <- glmer(Binary_bleaching_or_reduced_chla ~ Sed_level_stand_mg + (1 | Ref_name/Ref), 
              family = binomial, data = bleachSS2)
modSS14 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = bleachSS2)
modSS15 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = bleachSS2)
modSS16 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = bleachSS2)
modSS17 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = bleachSS2)
#modSS18 <- glmer(Binary_bleaching_or_reduced_chla ~ 
#                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
#              family = binomial, data = bleachSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSS19 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = bleachSS2)
modSS20 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = bleachSS2)
modSS21 <- glmer(Binary_bleaching_or_reduced_chla ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = bleachSS2)

#model comparison and summary
anova(modSS15,modSS21) # only 2 truly "full" fixed effects models -- modSS15 best
anova(modSS5,modSS8,modSS11,modSS14,modSS17,modSS20) #compare full fixed effects models -- mod8
anova(modSS8,modSS15) #modSS8
anova(modSS4,modSS7,modSS10,modSS13,modSS16,modSS19) #compare reduced fixed effects models -- mod7
anova(modSS7,modSS8) #modSS8
#print(summary(modSS8), correlation=FALSE) #boundary (singular) fit: see ?isSingular

#Trying out a log transformation of predictor...
modSS8_log <- glmer(Binary_bleaching_or_reduced_chla ~ 
                      log10_conc + Sed_exposure_days + (1 | Ref),
                    family = binomial, data = bleachSS2)
#print(summary(modSS8_log), correlation=FALSE) #boundary (singular) fit: see ?isSingular

print(summary(modSS2), correlation=FALSE)
#AIC is 32.1, two less than modSS8, and there are no errors
```
  
### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSS2, type="response")>0.5)
#proportion correct:
mean(p==bleachSS2$Binary_bleaching_or_reduced_chla) #[1] 0.8518519
#predicted-vs-observed table:
table(p,bleachSS2$Binary_bleaching_or_reduced_chla)
#ROC and area under the curve:
pred_modSS2 <- predict(modSS2, newdata = bleachSS2, type = "response")
auc(roc(bleachSS2$Binary_bleaching_or_reduced_chla, pred_modSS2)) #AUC: 0.921
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSS2) #The fixed effect of sediment level explains 63.5% of variation of the total variation.

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

tab <- cbind(Est = coef(modSS2), confint(modSS2))
2^(tab)
#                          Est        2.5 %     97.5 %
#(Intercept)       0.004901321 5.775157e-06 0.08160971
#Sed_level_stand_mg    1.012222478 1.004126e+00 1.02563852
#Sed_exposure_days 1.052858904 1.017483e+00 1.13621778

```
    
For every doubling of exposure concentration of suspended sediment, the odds of bleaching increase by 1.2% (95% CI 0.4, 2.6; GLMM z = 2.386, p = 0.017), while holding exposure duration constant. For every doubling of exposure duration of suspended sediment, the odds of bleaching increase by 5.3% (95% CI 1.7, 13.6, GLMM z = 2.050, p = 0.040), while holding exposure concentration constant.
  
### Prediction figures  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSS2 <- predict(modSS2, newdata=bleachSS2, type="response")
bleachSS3 <- cbind(bleachSS2, pred_modSS2)

bleachSS_plot <- ggplot(data = bleachSS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_bleaching_or_reduced_chla,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Bleaching due to sediment exposure",
         color = "Study") +
    scale_x_log10(limits=c(1,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modSS2), inherit.aes=FALSE) +
    theme_bw()

bleachSS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
#### By sediment exposure concentration
```{r}
jvalues <- with(bleachSS2, seq(from = min(Sed_level_stand_mg), to = max(Sed_level_stand_mg), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    bleachSS2$Sed_level_stand_mg <- j
    predict(modSS2, newdata = bleachSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_stand_mg values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
bleachSS_plot2 <- ggplot() +
    geom_point(data = bleachSS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_bleaching_or_reduced_chla,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of bleaching\ndue to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(1,max(bleachSS2$Sed_level_stand_mg)), 
                  breaks=c(0.01,0.1,1,10,100,1000,loaelSS),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelSS,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

bleachSS_plot2
```
  
#### By sediment exposure duration
```{r}
jvalues <- with(bleachSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    bleachSS2$Sed_exposure_days <- j
    predict(modSS2, newdata = bleachSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
bleachSS_plot3 <- ggplot() +
    geom_point(data = bleachSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_bleaching_or_reduced_chla,
      color = Ref)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of bleaching\ndue to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(bleachSS2$Sed_exposure_days))) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

bleachSS_plot3
```
