---
title: "Sediment-induced mortality of adult corals"
author: "Lillian J. Tuttle"
date: "6/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(lme4)
library(pROC)
library(effects)
library(lattice)
library(MuMIn)
binaryDS <- read.csv("/Volumes/GoogleDrive/My Drive/iScience/Code/thresholds/sedimentation/binary/binaryDS.csv", header=T)
binarySS <- read.csv("/Volumes/GoogleDrive/My Drive/iScience/Code/thresholds/sedimentation/binary/binarySS.csv", header=T)

#keyboard shortcuts to remember: 
#command-option-I inserts new code chunk
#command-shift-M inserts pipeline symbols
#command-enter runs line of code where cursor is (or highlighted portion)
```

#### Here I will explore how DEPOSITED AND SUSPENDED sediment affects the MORTALITY of tropical, scleractinean coral ADULTS. The database to be used is comprised of data extracted from studies deemed relevant during the systematic literature review process.

# The Dataset
  
## Deposited Sediment 
Specifically, we will explore the results of 1040 datapoints from 34 studies conducted in 3 oceans on 109 species within 57 genera.

```{r, echo=FALSE, warning=FALSE}
#head(mortalityDS)
mortalityDS <- binaryDS %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(Binary_sed_burial=="0") %>% 
  filter(!is.na(Binary_effect_mortality))
  
mortalityDS %>% tally() #n=1040 datapoints, tally() returns same result as count(mortalityDS)
mortalityDS %>% count(Ref, sort=T) #n=34 studies
mortalityDS %>% count(Ref_name, sort=T) #n=34 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
mortalityDS %>% count(Ocean, sort=T) #n=3 oceans
mortalityDS %>% count(Gsp) %>% #n=109 species
  top_n(10)
mortalityDS %>% count(Updated_Genus, sort=T) %>% #n=57 genera
  top_n(10)
```
  
## Suspended Sediment  
Specifically, we will explore the results of 272 datapoints from 6 studies conducted in 3 oceans on 19 species within 14 genera (shown below only the top 10 species and genera, by number of datapoints).

```{r, echo=FALSE, warning=FALSE}
#head(binarySS)
mortalitySS <- binarySS %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(Coral_age_class=="adult") %>% #only adult corals
  filter(!is.na(Binary_effect_mortality)) %>% 
  filter(!is.na(Sed_level_mg_L)) #removes studies that only report NTU and not mg/L
mortalitySS %>% tally() #n=272 datapoints, tally() returns same result as count(mortalitySS)
mortalitySS %>% count(Ref, sort=T) #n=8 studies
mortalitySS %>% count(Ref_name, sort=T) #n=6 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
mortalitySS %>% count(Ocean, sort=T) #n=3 oceans
mortalitySS %>% count(Gsp, sort=T) %>% #n=17 species
  top_n(10)
mortalitySS %>% count(Updated_Genus, sort=T) %>% #n=14 genera
  top_n(10)
```

# Exploratory plots

First let's explore all data from all species for which there is binary data about the presence of 'small necroses', 'large necroses', and 'total mortality' as a result of exposure to deposited sediment.  

##### DEFINITIONS:  
* '**Small necroses**' are defined as areas of tissue mortality that encompass between 0% and 50% of the coral's surface area.  
* '**Large necroses**' are defined as areas of tissue mortality that encompass greater than or equal to 50% of the coral's surface area, but less than 100% (total mortality).  
* '**Total mortality**' is defined as 100% of coral's surface area experiencing necrosis. In other words, it is the death of an entire coral entity (e.g., colony, branch, fragment, other experimental unit).

```{r, echo=FALSE, warning=FALSE}
#DEPOSITED SEDIMENT
#small necroses, plotted by exposure concentration (x) and exposure duration (y)
smallDS <- mortalityDS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_mg_cm2_d, Binary_small_necroses, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Sed_days, Sed_origin, Sed_grain_class) %>% 
  filter(!is.na(Binary_small_necroses)) #remove NAs (studies that did not describe small necroses)
#smallDS %>% tally() #n=750 datapoints, tally() returns same result as count(small)
#smallDS %>% count(Ref, sort=T) #n=21 studies
#smallDS %>% count(Ref_name, sort=T) #n=21 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#smallDS %>% count(Gsp, sort=T) #n=76 species
#smallDS %>% count(Updated_Genus, sort=T) #n=39 genera, top four: Porites n=142, Montipora n=132, Acropora n=80, Leptoria n=40

smallDS_plot <- ggplot(data=smallDS, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      color = factor(Binary_small_necroses),
      shape = factor(Binary_small_necroses),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(smallDS, Binary_small_necroses=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Exposure duration (days)") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits=c(0.1,200), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_color_manual(name = "Small necroses\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Small necroses\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#large necroses, plotted by exposure concentration (x) and exposure duration (y)
largeDS <- mortalityDS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_mg_cm2_d, Binary_large_necroses, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Sed_days, Sed_origin, Sed_grain_class) %>% 
  filter(!is.na(Binary_large_necroses)) #remove NAs (studies that did not describe large necroses)
#largeDS %>% tally() #n=657 datapoints, tally() returns same result as count(large)
#largeDS %>% count(Ref_name, sort=T) #n=17 studies
#largeDS %>% count(Ref_name, sort=T) #n=17 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#largeDS %>% count(Gsp, sort=T) #n=75 species
#largeDS %>% count(Updated_Genus, sort=T) #n=39 genera
#head(large)
        
largeDS_plot <- ggplot(data=largeDS, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      color = factor(Binary_large_necroses),
      shape = factor(Binary_large_necroses),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(largeDS, Binary_large_necroses=="0")) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
         y = "Exposure duration (days)") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits=c(0.1,200), breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_color_manual(name = "Large necroses\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Large necroses\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#total mortality, plotted by exposure concentration (x) and exposure duration (y)
totalDS <- mortalityDS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_mg_cm2_d, Binary_death_total, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Sed_days, Sed_origin, Sed_grain_class) %>%
  filter(!is.na(Binary_death_total)) #remove NAs (studies that did not describe total mortality)
totalDS %>% tally() #n=678 datapoints, tally() returns same result as count(total)
totalDS %>% count(Ref, sort=T) #n=24 studies
totalDS %>% count(Ref_name, sort=T) #n=23 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
totalDS %>% count(Gsp, sort=T) #n=84 species
totalDS %>% count(Updated_Genus) #n=46 genera, top four: Montipora n=121, Acropora n=78, Porites n=63, Leptoria n=42 
#head(total)
        
totalDS_plot <- ggplot(data=totalDS, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      color = factor(Binary_death_total),
      shape = factor(Binary_death_total),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(totalDS, Binary_death_total=="0")) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
         y = "Exposure duration (days)") +
    scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000),
                  label=c("0.1","1","10","100","1000")) +
    scale_y_log10(limits=c(0.1,200), breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_color_manual(name = "Total colony mortality\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Total colony mortality\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#SUSPENDED SEDIMENT
#small necroses, plotted by exposure concentration (x) and exposure duration (y)
smallSS <- mortalitySS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_mg_L, Binary_small_necroses, Updated_Genus, Gsp, Ocean, Sed_exposure_days) %>% 
  filter(!is.na(Binary_small_necroses)) #remove NAs (studies that did not describe small necroses)
#smallSS %>% tally() #n=210 datapoints, tally() returns same result as count(smallSS)
#smallSS %>% count(Ref, sort=T) #n=4 studies
#smallSS %>% count(Ref_name, sort=T) #n=4 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#smallSS %>% count(Gsp, sort=T) #n=8 species
#smallSS %>% count(Updated_Genus, sort=T) #n=6 genera, top four: Merulina n=50, Pachyseris n=50, Platygyra n=50, Montipora n=36

smallSS_plot <- ggplot(data=smallSS, mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      color = factor(Binary_small_necroses),
      shape = factor(Binary_small_necroses),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(smallSS, Binary_small_necroses=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.1,200), breaks=c(0.1,1,10,100,1000),
                  label=c("0.1","1","10","100","1000")) +
    scale_y_continuous(limits = c(0,100)) +
    scale_color_manual(name = "Small necroses due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Small necroses due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#large necroses, plotted by exposure concentration (x) and exposure duration (y)
largeSS <- mortalitySS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_mg_L, Binary_large_necroses, Updated_Genus, Gsp, Ocean, Sed_exposure_days) %>% 
  filter(!is.na(Binary_large_necroses)) #remove NAs (studies that did not describe large necroses)
#largeSS %>% tally() #n=210 datapoints, tally() returns same result as count(largeSS)
#largeSS %>% count(Ref, sort=T) #n=4 studies
#largeSS %>% count(Ref_name, sort=T) #n=4 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#largeSS %>% count(Gsp, sort=T) #n=8 species
#largeSS %>% count(Updated_Genus, sort=T) #n=6 genera, top four: Merulina n=50, Pachyseris n=50, Platygyra n=50, Montipora n=36
#head(largeSS)
        
largeSS_plot <- ggplot(data=largeSS, mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      color = factor(Binary_large_necroses),
      shape = factor(Binary_large_necroses),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(largeSS, Binary_large_necroses=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.1,200), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_y_continuous(limits = c(0,100)) +
    scale_color_manual(name = "Large necroses due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Large necroses due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#total mortality, plotted by exposure concentration (x) and exposure duration (y)
totalSS <- mortalitySS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_mg_L, Binary_death_total, Updated_Genus, Gsp, Ocean, Sed_exposure_days) %>% 
  filter(!is.na(Binary_death_total)) #remove NAs (studies that did not describe total mortality)
#totalSS %>% tally() #n=272 datapoints, tally() returns same result as count(totalSS)
#totalSS %>% count(Ref, sort=T) #n=8 studies
#totalSS %>% count(Ref_name, sort=T) #n=6 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#totalSS %>% count(Gsp, sort=T) #n=17 species
#totalSS %>% count(Updated_Genus, sort=T) #n=14 genera, top four: Merulina n=50, Pachyseris n=50, Platygyra n=50, Acropora n=37
#head(totalSS)
        
totalSS_plot <- ggplot(data=totalSS, mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      color = factor(Binary_death_total),
      shape = factor(Binary_death_total),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(totalSS, Binary_death_total=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)",  
         y = "Exposure duration (days)") +
    scale_x_log10(limits = c(0.1,200), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_y_continuous(limits = c(0,100)) +
    scale_color_manual(name = "Total colony mortality\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Total colony mortality\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()


#PLOTS:
smallDS_plot + geom_point(data = subset(smallDS, Binary_small_necroses=="1")) +
  labs(title = "Small Necroses from Deposited Sediment", 
       subtitle = "n = 750 datapoints, n = 21 studies from 20 articles, n = 76 spp. from 39 genera")
smallSS_plot + geom_point(data = subset(smallSS, Binary_small_necroses=="1")) +
  labs(title = "Small Necroses from Suspended Sediment", 
       subtitle = "n = 210 datapoints, n = 4 studies from 4 articles, n = 8 spp. from 6 genera")

largeDS_plot + geom_point(data = subset(largeDS, Binary_large_necroses=="1")) +
  labs(title = "Large Necroses from Deposited Sediment", 
       subtitle = "n = 657 datapoints, n = 17 studies from 17 articles, n = 75 spp. from 39 genera")
largeSS_plot + geom_point(data = subset(largeSS, Binary_large_necroses=="1")) +
  labs(title = "Large Necroses from Suspended Sediment", 
       subtitle = "n = 210 datapoints, n = 4 studies from 4 articles, n = 8 spp. from 6 genera")

totalDS_plot + geom_point(data = subset(totalDS, Binary_death_total=="1")) +
  labs(title = "Total Colony Mortality from Deposited Sediment", 
       subtitle = "n = 678 datapoints, n = 24 studies from 24 articles, n = 84 spp. from 46 genera")
totalSS_plot + geom_point(data = subset(totalSS, Binary_death_total=="1")) +
  labs(title = "Total Colony Mortality from Suspended Sediment", 
       subtitle = "n = 272 datapoints, n = 8 studies from 6 articles, n = 17 spp. from 14 genera")
```
  
  
### Exploring the same plots with PLOTLY...  

##### Small necroses
**Legend**: Small necroses due to sedimentation? Empty circles are no (0), and filled squares are yes (1). Colors are for different genera.
  
**Deposited sediment**: All species, n=737 datapoints, n=20 studies, n=39 genera
```{r, echo=FALSE, warning=FALSE}
small_plot2 <- ggplot(data=smallDS) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      shape = factor(Binary_small_necroses),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Exposure duration (days)",
         shape = "Small necroses due\nto sedimentation?",
         color = "Genus") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
small_plotly <- ggplotly(small_plot2, tooltip="text")
small_plotly #plot where I can hover over points and get species, but legend cut-off
```
  
**Suspended sediment**: All species, n=210 datapoints, n=4 studies, n=6 genera
```{r, echo=FALSE, warning=FALSE}
smallSS_plot2 <- ggplot(data=smallSS) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      shape = factor(Binary_small_necroses),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Exposure duration (days)",
         shape = "Small necroses due\nto sedimentation?",
         color = "Genus") +
    scale_x_log10(limits = c(0.1,200), breaks=c(0.1,1,10,100,1000),
                  label=c("0.1","1","10","100","1000")) +
    scale_y_log10(limits = c(1,300), breaks=c(1,10,100),
                  label=c("1","10","100")) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
smallSS_plotly <- ggplotly(smallSS_plot2, tooltip="text")
smallSS_plotly #plot where I can hover over points and get species, but legend cut-off
```
  
  
##### Large necroses
**Legend**: Large necroses due to sedimentation? Empty circles are no (0), and filled squares are yes (1). Colors are for different genera.
  
**Deposited sediment**: All species, n=644 datapoints, n=17 studies, n=39 genera
```{r, echo=FALSE, warning=FALSE}
large_plot2 <- ggplot(data=largeDS) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      shape = factor(Binary_large_necroses),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Exposure duration (days)",
         shape = "Large necroses due\nto sedimentation?",
         color = "Genus") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
large_plotly <- ggplotly(large_plot2, tooltip="text")
large_plotly #plot where I can hover over points and get species, but legend cut-off
```
  
**Suspended sediment**: All species, n=210 datapoints, n=4 studies, n=6 genera
```{r, echo=FALSE, warning=FALSE}
largeSS_plot2 <- ggplot(data=largeSS) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      shape = factor(Binary_large_necroses),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Exposure duration (days)",
         shape = "Large necroses due\nto sedimentation?",
         color = "Genus") +
    scale_x_log10(limits = c(0.1,200), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_y_continuous(limits = c(0,100)) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
largeSS_plotly <- ggplotly(largeSS_plot2, tooltip="text")
largeSS_plotly #plot where I can hover over points and get species, but legend cut-off
```
  
  
##### Total mortality
**Legend**: Total mortality due to sedimentation? Empty circles are no (0), and filled squares are yes (1). Colors are for different genera.
  
**Deposited sediment**: All species, n=666 datapoints, n=23 studies, n=46 genera
```{r, echo=FALSE, warning=FALSE}
total_plot2 <- ggplot(data=totalDS) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      shape = factor(Binary_death_total),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Exposure duration (days)",
         shape = "Total mortality due\nto sedimentation?",
         color = "Genus") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
total_plotly <- ggplotly(total_plot2, tooltip="text")
total_plotly #plot where I can hover over points and get species, but legend cut-off
```
    
**Suspended sediment**: All species, n=272 datapoints, n=6 studies, n=14 genera
```{r, echo=FALSE, warning=FALSE}
totalSS_plot2 <- ggplot(data=totalSS) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Sed_exposure_days,
      shape = factor(Binary_death_total),
      color = Updated_Genus,
      position = "jitter",
      text = Gsp)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Exposure duration (days)",
         shape = "Total mortality due\nto sedimentation?",
         color = "Genus") +
    scale_x_log10(limits = c(0.1,200), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_y_log10(limits = c(1,300), breaks=c(1,10,100),
                  label=c("1","10","100")) +
    scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
    theme_bw()
totalSS_plotly <- ggplotly(totalSS_plot2, tooltip="text")
totalSS_plotly #plot where I can hover over points and get species, but legend cut-off
```
  
  
### *Montipora* spp. only for Deposited Sediment 
*Montipora* is the genus with the most data and appears to be among the most sensitive, so let's explore it individually:

```{r, echo=FALSE, warning=FALSE}
sm_montipora <- smallDS %>% 
  filter(Updated_Genus=="Montipora")
#sm_montipora %>% tally() #n=132 datapoints, tally() returns same result as count(sm_montipora)
#sm_montipora %>% count(Ref_name, sort=T) #n=8 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#sm_montipora %>% count(Gsp, sort=T) #n=11 species, same as nlevels(as.factor(sm_montipora$Gsp))
  
sm_mont_plot <- ggplot(data=sm_montipora) +
  geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      shape = factor(Binary_small_necroses),
      color = Gsp,
      position = "jitter",
      text = Gsp)) + 
  labs(x = "Sedimentation rate (mg/cm2/d)", 
       y = "Exposure duration (days)",
       color = "Species",
       shape = "Small necroses due\nto sedimentation?") +
  scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                label=c("0.01","0.1","1","10","100","1000")) +
  scale_y_log10(breaks=c(0.01,0.1,1,10,100),
                label=c("0.01","0.1","1","10","100")) +
  scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
  theme_bw()


lg_montipora <- largeDS %>% 
  filter(Updated_Genus=="Montipora")
#lg_montipora %>% tally() #n=112 datapoints, tally() returns same result as count(sm_montipora)
#lg_montipora %>% count(Ref_name, sort=T) #n=7 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#lg_montipora %>% count(Gsp, sort=T) #n=10 species, same as nlevels(as.factor(sm_montipora$Gsp)) #n=10

lg_mont_plot <- ggplot(data=lg_montipora) +
  geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      shape = factor(Binary_large_necroses),
      color = Gsp,
      position = "jitter",
      text = Gsp)) + 
  labs(x = "Sedimentation rate (mg/cm2/d)", 
       y = "Exposure duration (days)",
       color = "Species",
       shape = "Large necroses due\nto sedimentation?") +
  scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                label=c("0.01","0.1","1","10","100","1000")) +
  scale_y_log10(breaks=c(0.01,0.1,1,10,100),
                label=c("0.01","0.1","1","10","100")) +
  scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
  theme_bw()


tot_montipora <- totalDS %>% 
  filter(Updated_Genus=="Montipora")
#tot_montipora %>% tally() #n=121 datapoints, tally() returns same result as count(sm_montipora)
#tot_montipora %>% count(Ref_name, sort=T) #n=9 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#tot_montipora %>% count(Gsp, sort=T) #n=11 species, same as nlevels(as.factor(sm_montipora$Gsp))

tot_mont_plot <- ggplot(data=tot_montipora) +
  geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Sed_days,
      shape = factor(Binary_death_total),
      color = Gsp,
      position = "jitter",
      text = Gsp)) + 
  labs(x = "Sedimentation rate (mg/cm2/d)", 
       y = "Exposure duration (days)",
       color = "Species",
       shape = "Total colony mortality \ndue to sedimentation?") +
  scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                label=c("0.01","0.1","1","10","100","1000")) +
  scale_y_log10(breaks=c(0.01,0.1,1,10,100),
                label=c("0.01","0.1","1","10","100")) +
  scale_shape_manual(breaks = c("0","1"), values = c(21,15)) +
  theme_bw()


#PLOTS:
#sm_mont_plot + ggtitle("Small necroses, Montipora spp. only,\nn=132 datapoints, n=8 studies, n=11 spp.")
#lg_mont_plot + ggtitle("Large necroses, Montipora spp. only,\nn=112 datapoints, n=7 studies, n=10 spp.")
#tot_mont_plot + ggtitle("Total mortality, Montipora spp. only,\nn=121 datapoints, n=9 studies, n=11 spp.")
```

##### Small necroses, Montipora spp. only, n=132 datapoints, n=8 studies, n=11 spp.
**Legend**: Small necroses due to sedimentation? Empty circles are no (0), and filled squares are yes (1). Colors are for different species.
```{r, echo=FALSE, warning=FALSE}
#PLOTS:
sm_mont_plotly <- ggplotly(sm_mont_plot, tooltip= c("x", "y", "text"))
sm_mont_plotly
```

##### Large necroses, Montipora spp. only, n=112 datapoints, n=7 studies, n=10 spp.
**Legend**: Large necroses due to sedimentation? Empty circles are no (0), and filled squares are yes (1). Colors are for different species.
```{r, echo=FALSE, warning=FALSE}
#PLOTS:
lg_mont_plotly <- ggplotly(lg_mont_plot, tooltip= c("x", "y", "text"))
lg_mont_plotly
```

##### Total mortality, Montipora spp. only, n=121 datapoints, n=9 studies, n=11 spp.
**Legend**: Small necroses due to sedimentation? Empty circles are no (0), and filled squares are yes (1). Colors are for different species.
```{r, echo=FALSE, warning=FALSE}
#PLOTS:
tot_mont_plotly <- ggplotly(tot_mont_plot, tooltip= c("x", "y", "text"))
tot_mont_plotly
```
   
  
# Threshold Analyses with Binary Data 
Now let's calculate the thresholds for each category of mortality, based on the binary data explored above.  

##### DEFINITIONS:  
* '**LOAEL**', or the 'lowest observed adverse effect level' is defined as the lowest dose at which there was an observed adverse effect.  
* '**NOAEL**', or the 'no observed adverse effect level' is defined as the highest dose at which there was NOT an observed adverse effect.  
* '**Adverse effect**' is defined here as any response of a coral individual, colony, or experimental treatment group that *may* negatively affect the coral’s fitness and/or survival. These adverse effects may include sublethal physiological changes (e.g., significantly reduced growth or photosynthetic rates when compared to coral in ambient/control conditions), bleaching/tissue loss, and mortality.  This definition of adverse effect is independent of its magnitude, so while the affect may have potentially reduced fitness, its magnitude may be sufficiently small that the fitness effect is not measureable.  
  
 
## DEPOSITED SEDIMENT
### Small Necroses  
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_small <- smallDS %>% 
  filter(Binary_small_necroses=="1") %>%
  arrange(Sed_level_mg_cm2_d) %>% #minimum Sedimentation level is 0! --> Looked at this particular row, and it is from Hodel 2007 who studied the recovery period post-exposure (hence sed level is 0 but still experiencing mortality). Therefore, this will not be an accurate LOAEL
  filter(Sed_level_mg_cm2_d>0) #removed Hodel sample described above

#LOAEL
summarize(adverse_small, LOAEL=min(Sed_level_mg_cm2_d)) #LOAEL is 4.9 and comes from study that was based on regression design (Sofonia (2006) PhD Chapter 4) -- in fact, all of the lowest values come from this study, ranging from 4.9 to 18.9. If for some reason we were to exclude this study, the LOAEL would be 20.8.
loaelDS1 <- adverse_small %>% summarize(min(Sed_level_mg_cm2_d))
loaelDS1 <- as.numeric(loaelDS1)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_small <- smallDS %>%
  filter(Binary_small_necroses=="0") %>%
  arrange(desc(Sed_level_mg_cm2_d)) %>%
  filter(Sed_level_mg_cm2_d<=4.9) #less than or equal to the LOAEL, which = 4.9

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_small, NOAEL=max(Sed_level_mg_cm2_d)) #NOAEL is 4.4

#PLOT
mortalityDS %>% 
  select(Ocean, Region, Genus, species, Binary_sed_burial, Sed_level_mg_cm2_d, Binary_small_necroses) %>% 
  filter(Binary_sed_burial=="0") %>% #remove all studies that buried corals instead of giving them a specific dosage (in mg/cm2/day)
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_small_necroses)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Presence/absence (1/0) of small necroses\ndue to sedimentation?") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=4.9, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_small2 <- smallDS %>% 
  filter(Binary_small_necroses=="1") %>% 
  filter(!is.na(Sed_days))

#LOAEL
summarize(adverse_small2, LOAEL=min(Sed_days)) #LOAEL is 0.917 days = 22h

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_small2 <- smallDS %>%
  filter(Binary_small_necroses=="0") %>%
  filter(Sed_days<=0.917) #less than or equal to the LOAEL, which = 0.917

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_small2, NOAEL=max(Sed_days)) #NOAEL is 0.917 days

#PLOT LOAELs
smallDS_plot + geom_point(data = subset(smallDS, Binary_small_necroses=="1")) +
  labs(title = "Small Necroses from Deposited Sediment", 
       subtitle = "n = 750 datapoints, n = 21 studies from 21 articles, n = 76 spp. from 39 genera",
       caption = "LOAEL concentration = 4.9, duration = 22 h\nNOAEL concentration = 4.4, duration = 22 h\nShaded box represents 'risky' exposure area") +
  annotate("rect", xmin=4.9, xmax=Inf, ymin=0.917, ymax=Inf, fill = "red", alpha=0.2)

smallDS_plot + geom_point(data = subset(smallDS, Binary_small_necroses=="1")) +
  labs(caption = "LOAEL concentration = 4.9, duration = 22 h\nNOAEL concentration = 4.4, duration = 22 h\nShaded box represents 'risky' exposure area\nn = 750 datapoints, n = 21 studies from 21 articles, n = 76 spp. from 39 genera") +
  annotate("rect", xmin=4.9, xmax=Inf, ymin=0.917, ymax=Inf, fill = "red", alpha=0.2)
```


### Large Necroses
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_large <- largeDS %>% 
  filter(Binary_large_necroses=="1") %>%
  arrange(Sed_level_mg_cm2_d)

#LOAEL
summarize(adverse_large, LOAEL=min(Sed_level_mg_cm2_d)) #LOAEL is 20.8 and comes from Hodgson (1989b) Chapter IV - field component.
loaelDS2 <- adverse_large %>% summarize(min(Sed_level_mg_cm2_d))
loaelDS2 <- as.numeric(loaelDS2)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_large <- largeDS %>%
  filter(Binary_large_necroses=="0") %>%
  arrange(desc(Sed_level_mg_cm2_d)) %>%
  filter(Sed_level_mg_cm2_d<=20.8) #less than or equal to the LOAEL, which = 20.8

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_large, NOAEL=max(Sed_level_mg_cm2_d)) #NOAEL is 20.8

#PLOT
mortalityDS %>% 
  select(Ocean, Region, Genus, species, Binary_sed_burial, Sed_level_mg_cm2_d, Binary_large_necroses) %>% 
  filter(Binary_sed_burial=="0") %>% #remove all studies that buried corals instead of giving them a specific dosage (in mg/cm2/day)
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_large_necroses)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Presence/absence (1/0) of large necroses\ndue to sedimentation?") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=20.8, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```

#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_large2 <- largeDS %>% 
  filter(Binary_large_necroses=="1") %>% 
  filter(!is.na(Sed_days))

#LOAEL
summarize(adverse_large2, LOAEL=min(Sed_days)) #LOAEL is 3 days

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_large2 <- largeDS %>%
  filter(Binary_large_necroses=="0") %>%
  filter(Sed_days<=3) #less than or equal to the LOAEL, which = 3

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_large2, NOAEL=max(Sed_days)) #NOAEL is 3 days

#PLOT LOAELs
largeDS_plot + geom_point(data = subset(largeDS, Binary_large_necroses=="1")) +
  labs(title = "Large necroses from Deposited Sediment", 
                   subtitle = "n = 657 datapoints, n = 18 studies from 18 articles, n = 75 spp. from 39 genera", 
                   caption = "LOAEL concentration = 20.8, duration = 3 d\nNOAEL concentration = 20.8, duration = 3 d\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=20.8, xmax=Inf, ymin=3, ymax=Inf, fill = "red", alpha=0.2)

largeDS_plot + geom_point(data = subset(largeDS, Binary_large_necroses=="1")) +
  labs(caption = "LOAEL concentration = 20.8, duration = 3 d\nNOAEL concentration = 20.8, duration = 3 d\nShaded box represents 'risky' exposure area\nn = 657 datapoints, n = 18 studies from 18 articles, n = 75 spp. from 39 genera") +
    annotate("rect", xmin=20.8, xmax=Inf, ymin=3, ymax=Inf, fill = "red", alpha=0.2)
```

### Total mortality
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_total <- totalDS %>% 
  filter(Binary_death_total=="1") %>%
  arrange(Sed_level_mg_cm2_d)

#LOAEL
summarize(adverse_total, LOAEL=min(Sed_level_mg_cm2_d)) #LOAEL is 20.8 and comes from Hodgson (1989b) Chapter IV - field component.
loaelDS3 <- adverse_total %>% summarize(min(Sed_level_mg_cm2_d))
loaelDS3 <- as.numeric(loaelDS3)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_total <- totalDS %>%
  filter(Binary_death_total=="0") %>%
  arrange(desc(Sed_level_mg_cm2_d)) %>%
  filter(Sed_level_mg_cm2_d<=20.8) #less than or equal to the LOAEL, which = 20.8

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_total, NOAEL=max(Sed_level_mg_cm2_d)) #NOAEL is 20.8

#PLOT
mortalityDS %>% 
  select(Ocean, Region, Genus, species, Binary_sed_burial, Sed_level_mg_cm2_d, Binary_death_total) %>% 
  filter(Binary_sed_burial=="0") %>% #remove all studies that buried corals instead of giving them a specific dosage (in mg/cm2/day)
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_death_total)) + 
    labs(x = "Sedimentation rate (mg/cm2/d)", 
         y = "Presence/absence (1/0) of total mortality\ndue to sedimentation?") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=20.8, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```

#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_total2 <- totalDS %>% 
  filter(Binary_death_total=="1") %>% 
  filter(!is.na(Sed_days)) %>% 
  arrange(Sed_days)

#LOAEL
summarize(adverse_total2, LOAEL=min(Sed_days)) #LOAEL is 1 day

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_total2 <- totalDS %>%
  filter(Binary_death_total=="0") %>%
  filter(Sed_days<=1) #less than or equal to the LOAEL, which = 1

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_total2, NOAEL=max(Sed_days)) #NOAEL is 1 day

#PLOT LOAELs
totalDS_plot + geom_point(data = subset(totalDS, Binary_death_total=="1")) +
  labs(title = "Total Colony Mortality from Deposited Sediment", 
       subtitle = "n = 678 datapoints, n = 24 studies from 24 articles, n = 84 spp. from 46 genera", 
       caption = "LOAEL concentration = 20.8, duration = 1 d\nNOAEL concentration = 20.8, duration = 1 d\nShaded box represents 'risky' exposure area")  +
    annotate("rect", xmin=20.8, xmax=Inf, ymin=1, ymax=Inf, fill = "red", alpha=0.2)

totalDS_plot + geom_point(data = subset(totalDS, Binary_death_total=="1")) +
  labs(caption = "LOAEL concentration = 20.8, duration = 1 d\nNOAEL concentration = 20.8, duration = 1 d\nShaded box represents 'risky' exposure area\nn = 678 datapoints, n = 24 studies from 24 articles, n = 84 spp. from 46 genera")  +
    annotate("rect", xmin=20.8, xmax=Inf, ymin=1, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
## SUSPENDED SEDIMENT
### Small Necroses  
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_smallSS <- smallSS %>% 
  filter(Binary_small_necroses=="1") %>%
  arrange(Sed_level_mg_L)

#LOAEL
summarize(adverse_smallSS, LOAEL=min(Sed_level_mg_L)) #LOAEL is 3.22 and is from Flores et al. (2012) with Montipora aequituberculata for 84 days
loaelSS1 <- adverse_smallSS %>% summarize(min(Sed_level_mg_L))
loaelSS1 <- as.numeric(loaelSS1)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_smallSS <- smallSS %>%
  filter(Binary_small_necroses=="0") %>%
  arrange(desc(Sed_level_mg_L)) %>%
  filter(Sed_level_mg_L<=3.22) #less than or equal to the LOAEL, which = 3.22

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_smallSS, NOAEL=max(Sed_level_mg_L)) #NOAEL is 3.22

#PLOT
mortalitySS %>% 
  select(Ocean, Gsp, Sed_level_mg_L, Binary_small_necroses) %>% 
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_small_necroses)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Presence/absence (1/0) of small necroses\ndue to sedimentation?") +
    scale_x_log10(limits=c(0.1,150), breaks=c(0.1,1,10,100), label=c("0.1","1","10","100")) +
    theme_bw() +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_smallSS2 <- smallSS %>% 
  filter(Binary_small_necroses=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>%
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_smallSS2, LOAEL=min(Sed_exposure_days)) #LOAEL is 14 days from Browne et al. 2015 with Pachyseris speciosa at 92.4 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_smallSS2 <- smallSS %>%
  filter(Binary_small_necroses=="0") %>%
  filter(Sed_exposure_days<=14) #less than or equal to the LOAEL, which = 14

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_smallSS2, NOAEL=max(Sed_exposure_days)) #NOAEL is 14 days

#PLOT LOAELs
smallSS_plot + geom_point(data = subset(smallSS, Binary_small_necroses=="1")) +
  labs(title = "Small Necroses from Suspended Sediment", 
       subtitle = "n = 210 datapoints, n = 4 studies from 4 articles, n = 8 spp. from 6 genera", 
       caption = "LOAEL concentration = 3.2, duration = 14 d\nNOAEL concentration = 3.2, duration = 14 d\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=14, ymax=Inf, fill = "red", alpha=0.2)

smallSS_plot + geom_point(data = subset(smallSS, Binary_small_necroses=="1")) +
  labs(caption = "LOAEL concentration = 3.2, duration = 14 d\nNOAEL concentration = 3.2, duration = 14 d\nShaded box represents 'risky' exposure area\nn = 210 datapoints, n = 4 studies from 4 articles, n = 8 spp. from 6 genera") +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=14, ymax=Inf, fill = "red", alpha=0.2)
```


### Large Necroses
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_largeSS <- largeSS %>% 
  filter(Binary_large_necroses=="1") %>%
  arrange(Sed_level_mg_L)

#LOAEL
summarize(adverse_largeSS, LOAEL=min(Sed_level_mg_L)) #LOAEL is 29.1 and is from Flores et al. (2012) with Montipora aequituberculata for 84 days
loaelSS2 <- adverse_largeSS %>% summarize(min(Sed_level_mg_L))
loaelSS2 <- as.numeric(loaelSS2)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_largeSS <- largeSS %>%
  filter(Binary_large_necroses=="0") %>%
  arrange(desc(Sed_level_mg_L)) %>%
  filter(Sed_level_mg_L<=29.1) #less than or equal to the LOAEL, which = 29.1

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_largeSS, NOAEL=max(Sed_level_mg_L)) #NOAEL is 29.1

#PLOT
mortalitySS %>% 
  select(Ocean, Gsp, Sed_level_mg_L, Binary_large_necroses) %>% 
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_large_necroses)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Presence/absence (1/0) of large necroses\ndue to sedimentation?") +
    scale_x_log10(limits=c(0.1,150), breaks=c(0.1,1,10,100), label=c("0.1","1","10","100")) +
    theme_bw() +
    annotate("rect", xmin=29.1, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_totalSS2 <- largeSS %>% 
  filter(Binary_large_necroses=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>%
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_totalSS2, LOAEL=min(Sed_exposure_days)) #LOAEL is 84 days from Flores et al. 2012 with Montipora aequituberculata at 29.1 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_totalSS2 <- largeSS %>%
  filter(Binary_large_necroses=="0") %>%
  filter(Sed_exposure_days<=84) #less than or equal to the LOAEL, which = 84

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_totalSS2, NOAEL=max(Sed_exposure_days)) #NOAEL is 84 days

#PLOT LOAELs
largeSS_plot + geom_point(data = subset(largeSS, Binary_large_necroses=="1")) +
  labs(title = "Large Necroses from Suspended Sediment", 
       subtitle = "n = 210 datapoints, n = 4 studies from 4 articles, n = 8 spp. from 6 genera", 
       caption = "LOAEL concentration = 29.1, duration = 84 d\nNOAEL concentration = 29.1, duration = 84 d\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=29.1, xmax=Inf, ymin=84, ymax=Inf, fill = "red", alpha=0.2)

largeSS_plot + geom_point(data = subset(largeSS, Binary_large_necroses=="1")) +
  labs(caption = "LOAEL concentration = 29.1, duration = 84 d\nNOAEL concentration = 29.1, duration = 84 d\nShaded box represents 'risky' exposure area\nn = 210 datapoints, n = 4 studies from 4 articles, n = 8 spp. from 6 genera") +
    annotate("rect", xmin=29.1, xmax=Inf, ymin=84, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
### Total mortality
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_totalSS <- totalSS %>% 
  filter(Binary_death_total=="1") %>%
  arrange(Sed_level_mg_L)

#LOAEL
summarize(adverse_totalSS, LOAEL=min(Sed_level_mg_L)) #LOAEL is 29.1 and is from Flores et al. (2012) with Montipora_aequituberculata for 84 days
loaelSS3 <- adverse_totalSS %>% summarize(min(Sed_level_mg_L))
loaelSS3 <- as.numeric(loaelSS3)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_totalSS <- totalSS %>%
  filter(Binary_death_total=="0") %>%
  arrange(desc(Sed_level_mg_L)) %>%
  filter(Sed_level_mg_L<=29.1) #less than or equal to the LOAEL, which = 29.1

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_totalSS, NOAEL=max(Sed_level_mg_L)) #NOAEL is 29.1

#PLOT
mortalitySS %>% 
  select(Ocean, Gsp, Sed_level_mg_L, Binary_death_total) %>% 
  ggplot() +
    geom_point(mapping = aes(
      x = Sed_level_mg_L,
      y = Binary_death_total)) + 
    labs(x = "Total suspended sediment (mg/L)", 
         y = "Presence/absence (1/0) of small necroses\ndue to sedimentation?") +
    scale_x_log10(limits=c(0.1,200), breaks=c(0.1,1,10,100), label=c("0.1","1","10","100")) +
    theme_bw() +
    annotate("rect", xmin=29.1, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```
   
#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_totalSS2 <- totalSS %>% 
  filter(Binary_death_total=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>%
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverse_totalSS2, LOAEL=min(Sed_exposure_days)) #LOAEL is 84 days from Flores et al. 2012 with Montipora aequituberculata at 29.1 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_totalSS2 <- totalSS %>%
  filter(Binary_death_total=="0") %>%
  filter(Sed_exposure_days<=84) #less than or equal to the LOAEL, which = 84

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_totalSS2, NOAEL=max(Sed_exposure_days)) #NOAEL is 84 days

#PLOT LOAELs
totalSS_plot + geom_point(data = subset(totalSS, Binary_death_total=="1")) +
  labs(title = "Total Mortality from Suspended Sediment", 
       subtitle = "n = 272 datapoints, n = 8 studies from 6 articles, n = 17 spp. from 14 genera", 
       caption = "LOAEL concentration = 29.1 mg/L, duration = 84 days\nNOAEL concentration = 29.1 mg/L, duration = 84 days\nShaded box represents 'risky' exposure area") +
    annotate("rect", xmin=29.1, xmax=Inf, ymin=84, ymax=Inf, fill = "red", alpha=0.2)

totalSS_plot + geom_point(data = subset(totalSS, Binary_death_total=="1")) +
  labs(caption = "LOAEL concentration = 29.1 mg/L, duration = 84 days\nNOAEL concentration = 29.1 mg/L, duration = 84 days\nShaded box represents 'risky' exposure area\nn = 272 datapoints, n = 8 studies from 6 articles, n = 17 spp. from 14 genera") +
    annotate("rect", xmin=29.1, xmax=Inf, ymin=84, ymax=Inf, fill = "red", alpha=0.2)
```
  
  
# Logistic Regression Model Fitting 

## DEPOSITED SEDIMENT   
### Small Necroses
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
smallDS2 <- small %>% 
  mutate(log10_conc=log10(Sed_level_mg_cm2_d)) %>% 
  mutate(log10_dur=log10(Sed_days)) %>% 
  filter(Control_code=="0")
smallDS2 %>% tally()

#Models with fixed effect(s) only
modDS1 <- glm(Binary_small_necroses ~ Sed_level_mg_cm2_d, 
            family = binomial(link = "logit"), data = smallDS2)
modDS2 <- glm(Binary_small_necroses ~ Sed_level_mg_cm2_d + Sed_days, 
            family = binomial(link = "logit"), data = smallDS2)
modDS3 <- glm(Binary_small_necroses ~ Sed_level_mg_cm2_d*Sed_days, 
            family = binomial(link = "logit"), data = smallDS2)

#models with random effect for coral species or study
modDS4 <- glmer(Binary_small_necroses ~ Sed_level_mg_cm2_d + (1 | Gsp), 
              family = binomial, data = smallDS2)
modDS5 <- glmer(Binary_small_necroses ~ Sed_level_mg_cm2_d + Sed_days + (1 | Gsp), 
              family = binomial, data = smallDS2)
modDS6 <- glmer(Binary_small_necroses ~ Sed_level_mg_cm2_d*Sed_days + (1 | Gsp), 
              family = binomial, data = smallDS2)
modDS7 <- glmer(Binary_small_necroses ~ Sed_level_mg_cm2_d + (1 | Ref), 
              family = binomial, data = smallDS2)
modDS8 <- glmer(Binary_small_necroses ~ Sed_level_mg_cm2_d + Sed_days + (1 | Ref), 
              family = binomial, data = smallDS2)
modDS9 <- glmer(Binary_small_necroses ~ Sed_level_mg_cm2_d*Sed_days + (1 | Ref), 
              family = binomial, data = smallDS2)
modDS10 <- glmer(Binary_small_necroses ~ Sed_level_mg_cm2_d + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = smallDS2)
modDS11 <- glmer(Binary_small_necroses ~ 
                Sed_level_mg_cm2_d + Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = smallDS2)
modDS12 <- glmer(Binary_small_necroses ~ 
                Sed_level_mg_cm2_d*Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = smallDS2)

#Model comparison and summary
anova(modDS6,modDS9,modDS12) #compare full fixed effects models -- mod12 is best
anova(modDS10,modDS11,modDS12) #mod11 best
print(summary(modDS11), correlation=FALSE)
#Model is nearly unidentifiable: very large eigenvalue - Rescale variables?

#Trying out a log transformation of predictor...
modDS11_log <- glmer(Binary_small_necroses ~ 
                       log10_conc + log10_dur + (1 | Gsp) + (1 | Ref), 
                     family = binomial, data = smallDS2)
print(summary(modDS11_log), correlation=FALSE)
#No errors
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDS11_log, type="response")>0.5)
#proportion correct:
mean(p==smallDS2$Binary_small_necroses) #[1] 0.8272425
#predicted-vs-observed table:
table(p,smallDS2$Binary_small_necroses)
#ROC and area under the curve:
pred_modDS11_log <- predict(modDS11_log, newdata = smallDS2, type = "response")
auc(roc(smallDS2$Binary_small_necroses, pred_modDS11_log)) #AUC: 0.9049
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDS11_log) #The fixed effect of sediment level explains ~8% of variation of the total variation. If the random intercepts for studies are also included, then 71% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDS11_log))
dotplot(ranef(modDS11_log, condVar = T)) #residual variation at the level of studies -- variation among studies is large
qqnorm(ranef(modDS11_log)$Ref[,1])
qqline(ranef(modDS11_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDS11_log) #SD=2.0307 
exp(sqrt(VarCorr(modDS11_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
modDS11_log_noSed <- glmer(Binary_small_necroses ~ 1 + (1 | Ref), 
                    family = binomial, data = smallDS2)
#Explained_var_Ref <- (1-VarCorr(modDS11_log)$Ref[1]/VarCorr(modDS11_log_noSed)$Ref[1]) #not returning a proportion of variance explained, so not sure how to interpret.
random.intercepts <- ranef(modDS11_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDS11_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)), 
                    from = min(smallDS2$log10_conc), to = max(smallDS2$log10_conc), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Main effects are not significant, only interaction...
se <- sqrt(diag(vcov(modDS11_log)))
tab <- cbind(Est = fixef(modDS11_log), 
             LL = fixef(modDS11_log) - 1.96 * se, 
             UL = fixef(modDS11_log) + 1.96 * se)
exp(tab)
#                        Est           LL          UL
#(Intercept)     0.004141512 0.0004515197  0.03798754
#log10_conc      3.688788053 1.7279975250  7.87452360
#log10_dur       4.783110717 2.1103679520 10.84083376

```
    
For every 10-fold increase in exposure concentration of deposited sediment, the odds of developing small necroses (<50% of coral tissue surface area) increase by 3.7 times (95% CI 1.7, 7.9; GLMM z = 3.374, p = 0.0007), after accounting for exposure duration and variability among studies and species. For every 10-fold increase in exposure duration of deposited sediment, the odds of developing small necroses increase by 4.8 times (95% CI 2.1, 10.8; GLMM z = 3.749, p = 0.0002), after accounting for exposure concentration and variability among studies and species.
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDS11_log <- predict(modDS11_log, newdata=smallDS2, type="response")
smallDS3 <- cbind(smallDS2, pred_modDS11_log)

smallDS_plot <- ggplot(data = smallDS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_small_necroses)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Small necroses due to sediment exposure?") +
    scale_x_log10(limits=c(1,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_mg_cm2_d, y = pred_modDS11_log), inherit.aes=FALSE) +
    theme_bw()

smallDS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By sediment exposure concentration
```{r}
jvalues <- with(smallDS2, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    smallDS2$log10_conc <- j
    predict(modDS11_log, newdata = smallDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## 
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))
plotdat <- plotdat %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_conc", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
smallDS_plot2 <- ggplot() +
    geom_point(data = smallDS2, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_small_necroses,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of small\nnecroses due to sediment exposure",
         color = "\nBinary Data by Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(1,1000), breaks=c(0.01,0.1,1,10,100,1000,loaelDS1),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelDS1,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelDS1, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

smallDS_plot2
```
  
##### By sediment exposure duration
```{r}
jvalues <- with(smallDS2, seq(from = min(log10_dur), to = max(log10_dur), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    smallDS2$log10_dur <- j
    predict(modDS11_log, newdata = smallDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))
plotdat <- plotdat %>% mutate(Sed_dur_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_dur","Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = log10_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = log10_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
smallDS_plot3 <- ggplot() +
    geom_point(data = smallDS2, mapping = aes(
      x = Sed_days, 
      y = Binary_small_necroses,
      color = Ref)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of small\nnecroses to sediment exposure",
         color = "\nBinary Data by Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.1,200), breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

smallDS_plot3
```
  

### Large Necroses
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
largeDS2 <- large %>% 
  mutate(log10_conc=log10(Sed_level_mg_cm2_d)) %>% 
  mutate(log10_dur=log10(Sed_days)) %>% 
  filter(Control_code=="0")
largeDS2 %>% tally()

#Models with fixed effect(s) only
modDSb1 <- glm(Binary_death_total ~ Sed_level_mg_cm2_d, 
            family = binomial(link = "logit"), data = largeDS2)
modDSb2 <- glm(Binary_death_total ~ Sed_level_mg_cm2_d + Sed_days, 
            family = binomial(link = "logit"), data = largeDS2)
modDSb3 <- glm(Binary_death_total ~ Sed_level_mg_cm2_d*Sed_days, 
            family = binomial(link = "logit"), data = largeDS2)

#models with random effect for coral species or study
modDSb4 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + (1 | Gsp), 
              family = binomial, data = largeDS2)
modDSb5 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + Sed_days + (1 | Gsp), 
              family = binomial, data = largeDS2)
modDSb6 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d*Sed_days + (1 | Gsp), 
              family = binomial, data = largeDS2)
modDSb7 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + (1 | Ref), 
              family = binomial, data = largeDS2)
modDSb8 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + Sed_days + (1 | Ref), 
              family = binomial, data = largeDS2)
modDSb9 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d*Sed_days + (1 | Ref), 
              family = binomial, data = largeDS2)
modDSb10 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = largeDS2)
modDSb11 <- glmer(Binary_death_total ~ 
                Sed_level_mg_cm2_d + Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = largeDS2)
modDSb12 <- glmer(Binary_death_total ~ 
                Sed_level_mg_cm2_d*Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = largeDS2)

#Model comparison and summary
anova(modDSb6,modDSb9,modDSb12) #compare full fixed effects models -- mod12 (or 6) is best
anova(modDSb6,modDSb12)
anova(modDSb4,modDSb5,modDSb6) #mod5
anova(modDSb10,modDSb11,modDSb12) #mod11
anova(modDSb5,modDSb11) #both good but 11 slightly better
print(summary(modDSb11), correlation=FALSE)
#Model is nearly unidentifiable: very large eigenvalue - Rescale variables?
#Model is nearly unidentifiable: large eigenvalue ratio - Rescale variables?

#Trying out a log transformation of predictor...
modDSb11_log <- glmer(Binary_death_total ~ 
                        log10_conc + log10_dur + (1 | Gsp) + (1 | Ref), 
                     family = binomial, data = largeDS2)
print(summary(modDSb11_log), correlation=FALSE)
#No errors!
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDSb11_log, type="response")>0.5)
#proportion correct:
mean(p==largeDS2$Binary_death_total) #[1] 0.9099617
#predicted-vs-observed table:
table(p,largeDS2$Binary_death_total)
#ROC and area under the curve:
pred_modDSb11_log <- predict(modDSb11_log, newdata = largeDS2, type = "response")
auc(roc(largeDS2$Binary_death_total, pred_modDSb11_log)) #AUC: 0.9494
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDSb11_log) #The fixed effect of sediment level explains ~9% of variation of the total variation. If the random intercepts for studies are also included, then 91% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDSb11_log))
dotplot(ranef(modDSb11_log, condVar = T)) #residual variation at the level of studies -- variation among studies is large
qqnorm(ranef(modDSb11_log)$Ref[,1])
qqline(ranef(modDSb11_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDSb11_log) #SD=2.0307 
exp(sqrt(VarCorr(modDSb11_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
modDSb11_log_noSed <- glmer(Binary_death_total ~ 1 + (1 | Gsp) + (1 | Ref), 
                            family = binomial, data = largeDS2)
#Explained_var_Ref <- (1-VarCorr(modDSb11_log)$Ref[1]/VarCorr(modDSb11_log_noSed)$Ref[1]) #not returning a proportion of variance explained, so not sure how to interpret.
random.intercepts <- ranef(modDSb11_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDSb11_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)), 
                    from = min(largeDS2$log10_conc), to = max(largeDS2$log10_conc), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modDSb11_log)))
tab <- cbind(Est = fixef(modDSb11_log), 
             LL = fixef(modDSb11_log) - 1.96 * se, 
             UL = fixef(modDSb11_log) + 1.96 * se)
exp(tab)
```
    
For every 10-fold increase in exposure concentration of deposited sediment, the odds of any tissue mortality increase by 13.1 times (95% CI 4.2, 40.5; GLMM z = 4.460, p < 0.00001), while holding exposure duration constant and accounting for variability among studies and species. For every 10-fold change in exposure duration, the odds of any tissue mortality increase by 15.9 times (95% CI 2.7, 9.2; GLMM z = 3.077, p = 0.002), while holding exposure concentration constant and accounting for variability among studies and species.
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDSb11_log <- predict(modDSb11_log, newdata=largeDS2, type="response")
largeDS3 <- cbind(largeDS2, pred_modDSb11_log)

largeDS_plot <- ggplot(data = largeDS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Large necroses due to sediment exposure?",
         color = "Study") +
    scale_x_log10(limits=c(1,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_mg_cm2_d, y = pred_modDSb11_log), inherit.aes=FALSE) +
    theme_bw()

largeDS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By exposure concentration
```{r}
jvalues <- with(largeDS2, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    largeDS2$log10_conc <- j
    predict(modDSb11_log, newdata = largeDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## 
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))
plotdat <- plotdat %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_conc", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
largeDS_plot2 <- ggplot() +
    geom_point(data = largeDS2, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_death_total)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of large\nnecroses due to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(1,1000), breaks=c(0.01,0.1,1,10,100,1000,loaelDS2),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelDS2,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelDS2, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

largeDS_plot2
```
  
##### By exposure duration
```{r}
jvalues <- with(largeDS2, seq(from = min(log10_dur), to = max(log10_dur), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    largeDS2$log10_dur <- j
    predict(modDSb11_log, newdata = largeDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## 
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_dur values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))
plotdat <- plotdat %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_dur", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = log10_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = log10_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
largeDS_plot2 <- ggplot() +
    geom_point(data = largeDS2, mapping = aes(
      x = Sed_days, 
      y = Binary_death_total)) +
    labs(x = expression("Sediment exposure duration (days)"), 
         y = "Predicted probability of large\nnecroses due to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.1,max(largeDS2$Sed_days)), breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

largeDS_plot2
```
  
### Total mortality
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
totalDS2 <- total %>% 
  mutate(log10_conc=log10(Sed_level_mg_cm2_d)) %>% 
  mutate(log10_dur=log10(Sed_days)) %>% 
  filter(Control_code=="0")
totalDS2 %>% tally()

#Models with fixed effect(s) only
modDSc1 <- glm(Binary_death_total ~ Sed_level_mg_cm2_d, 
            family = binomial(link = "logit"), data = totalDS2)
modDSc2 <- glm(Binary_death_total ~ Sed_level_mg_cm2_d + Sed_days, 
            family = binomial(link = "logit"), data = totalDS2)
modDSc3 <- glm(Binary_death_total ~ Sed_level_mg_cm2_d*Sed_days, 
            family = binomial(link = "logit"), data = totalDS2)

#models with random effect for coral species or study
modDSc4 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + (1 | Gsp), 
              family = binomial, data = totalDS2)
modDSc5 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + Sed_days + (1 | Gsp), 
              family = binomial, data = totalDS2)
modDSc6 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d*Sed_days + (1 | Gsp), 
              family = binomial, data = totalDS2)
modDSc7 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + (1 | Ref), 
              family = binomial, data = totalDS2)
modDSc8 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + Sed_days + (1 | Ref), 
              family = binomial, data = totalDS2)
modDSc9 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d*Sed_days + (1 | Ref), 
              family = binomial, data = totalDS2)
modDSc10 <- glmer(Binary_death_total ~ Sed_level_mg_cm2_d + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = totalDS2)
modDSc11 <- glmer(Binary_death_total ~ 
                Sed_level_mg_cm2_d + Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = totalDS2)
modDSc12 <- glmer(Binary_death_total ~ 
                Sed_level_mg_cm2_d*Sed_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = totalDS2)

#Model comparison and summary
anova(modDSc6,modDSc9,modDSc12) #compare full fixed effects models -- mod12 is best
anova(modDSc10,modDSc11,modDSc12) #mod11 or 12
anova(modDSc4,modDSc7,modDSc10) #compare reduced fixed effects models -- mod10 is best
#print(summary(modDSc11), correlation=FALSE)
#Model is nearly unidentifiable: large eigenvalue ratio - Rescale variables?

#Trying out a log transformation of predictor...
modDSc11_log <- glmer(Binary_death_total ~ 
                        log10_conc + log10_dur + (1 | Gsp) + (1 | Ref), 
                     family = binomial, data = totalDS2)
print(summary(modDSc11_log), correlation=FALSE)
#No errors!
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDSc11_log, type="response")>0.5)
#proportion correct:
mean(p==totalDS2$Binary_death_total) #[1] 0.9685658
#predicted-vs-observed table:
table(p,totalDS2$Binary_death_total)
#ROC and area under the curve:
pred_modDSc11_log <- predict(modDSc11_log, newdata = totalDS2, type = "response")
auc(roc(totalDS2$Binary_death_total, pred_modDSc11_log)) #AUC: 0.9905
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDSc11_log) #The fixed effect of sediment level explains ~7% of variation of the total variation. If the random intercepts for studies are also included, then 91% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDSc11_log))
dotplot(ranef(modDSc11_log, condVar = T)) #residual variation at the level of studies -- variation among studies is large
qqnorm(ranef(modDSc11_log)$Ref[,1])
qqline(ranef(modDSc11_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDSc11_log) #SD=2.0307 
exp(sqrt(VarCorr(modDSc11_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(2.0307) = 7.619567
modDSc11_log_noSed <- glmer(Binary_death_total ~ 1 + (1 | Gsp) + (1 | Ref), 
                    family = binomial, data = totalDS2)
#Explained_var_Ref <- (1-VarCorr(modDSc11_log)$Ref[1]/VarCorr(modDSc11_log_noSed)$Ref[1]) #not returning a proportion of variance explained, so not sure how to interpret.
random.intercepts <- ranef(modDSc11_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDSc11_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDSc11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSc11_log)["log10_conc"]*x)), 
                    from = min(totalDS2$log10_conc), to = max(totalDS2$log10_conc), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/cm2/d")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDSc11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSc11_log)["log10_conc"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modDSc11_log)))
tab <- cbind(Est = fixef(modDSc11_log), 
             LL = fixef(modDSc11_log) - 1.96 * se, 
             UL = fixef(modDSc11_log) + 1.96 * se)
exp(tab)
```
    
For every 10-fold increase in exposure concentration of deposited sediment, the odds of total colony mortality increase by 447 times (95% CI 24, 8459; GLMM z = 4.069, p < 0.0001), after accounting for exposure duration and variability among studies and species. For every 10-fold change in exposure duration, the odds of total colony mortality increase by 2577 times (95% CI 90, 73,784; GLMM z = 4.590, p = 0.00001), after accounting for exposure concentration and variability among studies and species.
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDSc11_log <- predict(modDSc11_log, newdata=totalDS2, type="response")
totalDS3 <- cbind(totalDS2, pred_modDSc11_log)

totalDS_plot <- ggplot(data = totalDS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Total mortality due to sediment exposure?",
         color = "Study") +
    scale_x_log10(limits=c(0.01,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_mg_cm2_d, y = pred_modDSc11_log), inherit.aes=FALSE) +
    theme_bw()

totalDS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By exposure concentration
```{r}
jvalues <- with(totalDS2, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    totalDS2$log10_conc <- j
    predict(modDSc11_log, newdata = totalDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## 
# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))
plotdat <- plotdat %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_conc", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = log10_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
totalDS_plot2 <- ggplot() +
    geom_point(data = totalDS2, mapping = aes(
      x = Sed_level_mg_cm2_d, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of total colony\nmortality due to sediment exposure",
         color = "Study",
         linetype = "Predicted Probability") +
    scale_x_log10(limits=c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000,loaelDS3),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelDS3,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelDS3, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

totalDS_plot2
```
  
##### By exposure duration
```{r}
jvalues <- with(totalDS2, seq(from = min(log10_dur), to = max(log10_dur), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    totalDS2$log10_dur <- j
    predict(modDSc11_log, newdata = totalDS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_dur values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))
plotdat <- plotdat %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_dur", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = log10_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = log10_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
totalDS_plot2 <- ggplot() +
    geom_point(data = totalDS2, mapping = aes(
      x = Sed_days, 
      y = Binary_death_total)) +
    labs(x = expression("Sediment exposure duration (days)"), 
         y = "Predicted probability of total colony\nmortality due to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.1,max(totalDS2$Sed_days)), breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

totalDS_plot2
```
  
  
## SUSPENDED SEDIMENT
### Small Necroses
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
smallSS2 <- smallSS %>% 
  mutate(log10_conc=log10(Sed_level_mg_L)) %>% 
  mutate(log10_dur=log10(Sed_exposure_days)) %>% 
  filter(Control_code=="0")
smallSS2 %>% tally()

#Models with fixed effect(s) only
modSS1 <- glm(Binary_small_necroses ~ Sed_level_mg_L, 
            family = binomial(link = "logit"), data = smallSS2)
modSS2 <- glm(Binary_small_necroses ~ Sed_level_mg_L + Sed_exposure_days, 
            family = binomial(link = "logit"), data = smallSS2)
modSS3 <- glm(Binary_small_necroses ~ Sed_level_mg_L*Sed_exposure_days, 
            family = binomial(link = "logit"), data = smallSS2)

#models with random effect for coral species or study
modSS4 <- glmer(Binary_small_necroses ~ Sed_level_mg_L + (1 | Gsp), 
              family = binomial, data = smallSS2)
modSS5 <- glmer(Binary_small_necroses ~ Sed_level_mg_L + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = smallSS2)
modSS6 <- glmer(Binary_small_necroses ~ Sed_level_mg_L*Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = smallSS2)
modSS7 <- glmer(Binary_small_necroses ~ Sed_level_mg_L + (1 | Ref), 
              family = binomial, data = smallSS2)
modSS8 <- glmer(Binary_small_necroses ~ Sed_level_mg_L + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = smallSS2)
modSS9 <- glmer(Binary_small_necroses ~ Sed_level_mg_L*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = smallSS2)
modSS10 <- glmer(Binary_small_necroses ~ Sed_level_mg_L + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = smallSS2)
modSS11 <- glmer(Binary_small_necroses ~ 
                Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = smallSS2)
modSS12 <- glmer(Binary_small_necroses ~ 
                Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = smallSS2)
modSS13 <- glmer(Binary_small_necroses ~ Sed_level_mg_L + (1 | Ref_name/Ref), 
              family = binomial, data = smallSS2)
modSS14 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = smallSS2)
modSS15 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = smallSS2)
modSS16 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = smallSS2)
modSS17 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = smallSS2)
modSS18 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = smallSS2)
modSS19 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = smallSS2)
modSS20 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = smallSS2)
modSS21 <- glmer(Binary_small_necroses ~ 
                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = smallSS2)

#Model comparison and summary
anova(modSS6,modSS9,modSS12,modSS15,modSS18,modSS21) #compare full fixed effects models -- mod6 (12 and 18 within 2 AIC)
anova(modSS6,modSS12,modSS18) #mod6
anova(modSS4,modSS5,modSS6) #mod5
anova(modSS10,modSS11,modSS12) #mod11
anova(modSS16,modSS17,modSS18) #mod17
anova(modSS5,modSS11,modSS17) #mod5 but 11 includes Ref, which I prefer, and is within 2 AIC
print(summary(modSS5), correlation=FALSE) #no error
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSS5, type="response")>0.5)
#proportion correct:
mean(p==smallSS2$Binary_small_necroses) #[1] 0.8707483
#predicted-vs-observed table:
table(p,smallSS2$Binary_small_necroses)
#ROC and area under the curve:
pred_modSS5 <- predict(modSS5, newdata = smallSS2, type = "response")
auc(roc(smallSS2$Binary_small_necroses, pred_modSS5)) #AUC: 0.9189
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSS5) #The fixed effect of sediment level explains ~1.6% of variation of the total variation. If the random intercepts for studies are also included, then 100% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modSS5))
dotplot(ranef(modSS5, condVar = T)) #residual variation at the level of studies -- variation among studies is enormous
qqnorm(ranef(modSS5)$Ref[,1])
qqline(ranef(modSS5)$Ref[,1])
VarCorr(modSS5)
exp(sqrt(VarCorr(modSS5)$Ref[1]))
modSS5_noSed <- glmer(Binary_small_necroses ~ 1 + (1 | Gsp), 
                  family = binomial, data = smallSS2)
#Explained_var_Ref <- (1-VarCorr(modSS5)$Ref[1]/VarCorr(modSS5_noSed)$Ref[1]) #not returning a proportion of variance explained, so not sure how to interpret.
random.intercepts <- ranef(modSS5)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modSS5)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modSS5)["Sed_level_mg_L"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSS5)["Sed_level_mg_L"]*x)), 
                    from = min(smallSS2$Sed_level_mg_L), to = max(smallSS2$Sed_level_mg_L), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "Exposure concentration, mg/L")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modSS5)["Sed_level_mg_L"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSS5)["Sed_level_mg_L"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modSS5)))
tab <- cbind(Est = fixef(modSS5), 
             LL = fixef(modSS5) - 1.96 * se, 
             UL = fixef(modSS5) + 1.96 * se)
2^(tab)
10^(tab)
#                          Est           LL         UL
#(Intercept)       0.003743975 0.0003457821 0.04053811
#Sed_level_mg_L    1.023311817 1.0095310571 1.03728069
#Sed_exposure_days 1.056033682 1.0304395187 1.08226356

```
  
For every 10-fold increase in exposure concentration of suspended sediment, the odds of developing small tissue necroses increase by 1.08 times (95% CI 1.03, 1.13; GLMM z = 3.331, p = 0.0008), while holding exposure duration constant and after accounting for variability among species. For every 10-fold increase in exposure duration, the odds of small tissue necroses increase by 1.20 times (95% CI 1.10, 1.30; GLMM z = 4.355, p < 0.0001), while holding exposure concentration constant and after accounting for variability among species.  
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSS5 <- predict(modSS5, newdata=smallSS2, type="response")
smallSS3 <- cbind(smallSS2, pred_modSS5)

smallSS_plot <- ggplot(data = smallSS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_small_necroses,
      color = Gsp)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Small necroses due to sediment exposure?",
         color = "Species") +
    scale_x_log10(limits=c(1,max(smallSS2$Sed_level_mg_L)),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_mg_L, y = pred_modSS5), inherit.aes=FALSE) +
    theme_bw()

smallSS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By sediment exposure concentration
```{r}
jvalues <- with(smallSS2, seq(from = min(Sed_level_mg_L), to = max(Sed_level_mg_L), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    smallSS2$Sed_level_mg_L <- j
    predict(modSS5, newdata = smallSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_mg_L values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
smallSS_plot2 <- ggplot() +
    geom_point(data = smallSS2, mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_small_necroses)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of small\nnecroses due to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,125), breaks=c(0,25,50,75,100,125,loaelSS1), 
                       labels=c("0","25","50","75","100","125",round(loaelSS1,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS1, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

smallSS_plot2
```
  
##### By sediment exposure duration
```{r}
jvalues <- with(smallSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    smallSS2$Sed_exposure_days <- j
    predict(modSS5, newdata = smallSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
smallSS_plot3 <- ggplot() +
    geom_point(data = smallSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_small_necroses,
      color = Gsp)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of small\nnecroses to sediment exposure",
         color = "Species",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(smallSS2$Sed_exposure_days))) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

smallSS_plot3
```
  

### Large Necroses
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
totalSS2 <- largeSS %>% 
  mutate(log10_conc=log10(Sed_level_mg_L)) %>% 
  mutate(log10_dur=log10(Sed_exposure_days)) %>% 
  filter(Control_code=="0")
totalSS2 %>% tally()

#Models with fixed effect(s) only
modSSb1 <- glm(Binary_death_total ~ Sed_level_mg_L, 
            family = binomial(link = "logit"), data = totalSS2)
modSSb2 <- glm(Binary_death_total ~ Sed_level_mg_L + Sed_exposure_days, 
            family = binomial(link = "logit"), data = totalSS2)
modSSb3 <- glm(Binary_death_total ~ Sed_level_mg_L*Sed_exposure_days, 
            family = binomial(link = "logit"), data = totalSS2)

#models with random effect for coral species or study
modSSb4 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Gsp), 
              family = binomial, data = totalSS2)
#modSSb5 <- glmer(Binary_death_total ~ Sed_level_mg_L + Sed_exposure_days + (1 | Gsp), 
#              family = binomial, data = totalSS2)
#modSSb6 <- glmer(Binary_death_total ~ Sed_level_mg_L*Sed_exposure_days + (1 | Gsp), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSSb7 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Ref), 
              family = binomial, data = totalSS2)
modSSb8 <- glmer(Binary_death_total ~ Sed_level_mg_L + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = totalSS2)
modSSb9 <- glmer(Binary_death_total ~ Sed_level_mg_L*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = totalSS2)
modSSb10 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = totalSS2)
#modSSb11 <- glmer(Binary_death_total ~ 
#                Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
#              family = binomial, data = totalSS2)
#modSSb12 <- glmer(Binary_death_total ~ 
#                Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSSb13 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Ref_name/Ref), 
              family = binomial, data = totalSS2)
modSSb14 <- glmer(Binary_death_total ~ 
                 Sed_level_mg_L + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = totalSS2)
modSSb15 <- glmer(Binary_death_total ~ 
                 Sed_level_mg_L*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = totalSS2)
modSSb16 <- glmer(Binary_death_total ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = totalSS2)
#modSSb17 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
#              family = binomial, data = totalSS2)
#modSSb18 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS #step-halvings failed to reduce deviance in pwrssUpdate
modSSb19 <- glmer(Binary_death_total ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = totalSS2)
#modSSb20 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
#              family = binomial, data = totalSS2)
#modSSb21 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate

#Model comparison and summary
AIC(modSSb1,modSSb2,modSSb3) #modSSb2
anova(modSSb7,modSSb8,modSSb9) #modSSb8
anova(modSSb13,modSSb14,modSSb15) #modSSb14
anova(modSSb4,modSSb8,modSSb10,modSSb14,modSSb16,modSSb19) #modSSb5 and 11
anova(modSSb8,modSSb14) #modSSb8
print(summary(modSSb8), correlation=FALSE) #boundary (singular) fit: see ?isSingular

#Trying out a log transformation of predictor...
modSSb8_log <- glmer(Binary_death_total ~ 
                        log10_conc + log10_dur + (1 | Ref), 
                     family = binomial, data = totalSS2)
print(summary(modSSb8_log), correlation=FALSE) #boundary (singular) fit: see ?isSingular

print(summary(modSSb2), correlation=FALSE) #no errors
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSSb2, type="response")>0.5)
#proportion correct:
mean(p==totalSS2$Binary_death_total) #[1] 0.9863946
#predicted-vs-observed table:
table(p,totalSS2$Binary_death_total)
#ROC and area under the curve:
pred_modSSb2 <- predict(modSSb2, newdata = totalSS2, type = "response")
auc(roc(totalSS2$Binary_death_total, pred_modSSb2)) #AUC: 0.9976
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSSb2) #The fixed effect of sediment level explains ~1.6% of variation of the total variation. If the random intercepts for studies are also included, then 100% of variation is explained.

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Not significant
##se <- sqrt(diag(vcov(modSSb2)))
#tab <- cbind(Est = coef(modSSb2), 
#             LL = coef(modSSb2) - 1.96 * se, 
#             UL = coef(modSSb2) + 1.96 * se)
#exp(tab)
```
    
There is no significant relationship between sediment exposure and the odds of developing large tissue necroses (concentration: GLMM z = 0.003, p = 0.997; duration: GLMM  z = 0.004, p = 0.997).
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSSb2 <- predict(modSSb2, newdata=totalSS2, type="response")
largeSS3 <- cbind(totalSS2, pred_modSSb2)

largeSS_plot <- ggplot(data = largeSS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Large necroses due to sediment exposure?",
         color = "Study") +
    scale_x_continuous(limits=c(0,max(totalSS2$Sed_level_mg_L))) +
    geom_line(aes(x = Sed_level_mg_L, y = pred_modSSb2), inherit.aes=FALSE) +
    theme_bw()

largeSS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By exposure concentration
```{r}
jvalues <- with(totalSS2, seq(from = min(Sed_level_mg_L), to = max(Sed_level_mg_L), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    totalSS2$Sed_level_mg_L <- j
    predict(modSSb2, newdata = totalSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_mg_L values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
largeSS_plot2 <- ggplot() +
    geom_point(data = totalSS2, mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of large\nnecroses due to sediment exposure",
         color = "Binary data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(totalSS2$Sed_level_mg_L)),
                       breaks = c(0,25,50,75,100,125,loaelSS2),
                       labels = c("0","25","50","75","100","125",round(loaelSS2,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS2, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

largeSS_plot2
```
  
##### By exposure duration
```{r}
jvalues <- with(totalSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    totalSS2$Sed_exposure_days <- j
    predict(modSSb2, newdata = totalSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
largeSS_plot2 <- ggplot() +
    geom_point(data = totalSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_death_total)) +
    labs(x = expression("Sediment exposure duration (days)"), 
         y = "Predicted probability of large\nnecroses due to sediment exposure",
         linetype = "Predicted\nProbability") +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

largeSS_plot2
```
  
### Total mortality
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
totalSS2 <- totalSS %>% 
  mutate(log10_conc=log10(Sed_level_mg_L)) %>% 
  mutate(log10_dur=log10(Sed_exposure_days)) %>% 
  filter(Control_code=="0")
totalSS2 %>% tally()

#Models with fixed effect(s) only
modSSc1 <- glm(Binary_death_total ~ Sed_level_mg_L, 
            family = binomial(link = "logit"), data = totalSS2)
modSSc2 <- glm(Binary_death_total ~ Sed_level_mg_L + Sed_exposure_days, 
            family = binomial(link = "logit"), data = totalSS2)
modSSc3 <- glm(Binary_death_total ~ Sed_level_mg_L*Sed_exposure_days, 
            family = binomial(link = "logit"), data = totalSS2)

#models with random effect for coral species or study
modSSc4 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Gsp), 
              family = binomial, data = totalSS2)
#modSSc5 <- glmer(Binary_death_total ~ Sed_level_mg_L + Sed_exposure_days + (1 | Gsp), 
#              family = binomial, data = totalSS2)
#modSSc6 <- glmer(Binary_death_total ~ Sed_level_mg_L*Sed_exposure_days + (1 | Gsp), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSSc7 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Ref), 
              family = binomial, data = totalSS2)
modSSc8 <- glmer(Binary_death_total ~ Sed_level_mg_L + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = totalSS2)
modSSc9 <- glmer(Binary_death_total ~ Sed_level_mg_L*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = totalSS2)
modSSc10 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = totalSS2)
#modSSc11 <- glmer(Binary_death_total ~ 
#                Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
#              family = binomial, data = totalSS2)
#modSSc12 <- glmer(Binary_death_total ~ 
#                Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSSc13 <- glmer(Binary_death_total ~ Sed_level_mg_L + (1 | Ref_name/Ref), 
              family = binomial, data = totalSS2)
#modSSc14 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L + Sed_exposure_days + (1 | Ref_name/Ref), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSSc15 <- glmer(Binary_death_total ~ 
                 Sed_level_mg_L*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = totalSS2)
modSSc16 <- glmer(Binary_death_total ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = totalSS2)
#modSSc17 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
#              family = binomial, data = totalSS2)
#modSSc18 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate
modSSc19 <- glmer(Binary_death_total ~ 
                 Sed_level_mg_L + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = totalSS2)
#modSSc20 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
#              family = binomial, data = totalSS2)
#modSSc21 <- glmer(Binary_death_total ~ 
#                 Sed_level_mg_L*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
#              family = binomial, data = totalSS2)
#Error in pwrssUpdate(pp, resp, tol = tolPwrss, GQmat = GQmat, compDev = compDev, : (maxstephalfit) PIRLS step-halvings failed to reduce deviance in pwrssUpdate

#Model comparison and summary
AIC(modSSc1,modSSc2,modSSc3) #modSSc2
anova(modSSc7,modSSc8,modSSc9) #modSSc8
anova(modSSc13,modSSc15) #modSSc15
anova(modSSc4,modSSc8,modSSc10,modSSc15) #modSSc8 and 15
anova(modSSc8,modSSc15) #modSSc8
print(summary(modSSc8), correlation=FALSE) #boundary (singular) fit: see ?isSingular

#Trying out a log transformation of predictor...
modSSc8_log <- glmer(Binary_death_total ~ 
                        log10_conc + log10_dur + (1 | Ref), 
                     family = binomial, data = totalSS2)
print(summary(modSSc8_log), correlation=FALSE) #boundary (singular) fit: see ?isSingular

print(summary(modSSc2), correlation=FALSE) 
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSSc2, type="response")>0.5)
#proportion correct:
mean(p==totalSS2$Binary_death_total) #[1] 0.9886364
#predicted-vs-observed table:
table(p,totalSS2$Binary_death_total)
#ROC and area under the curve:
pred_modSSc2 <- predict(modSSc2, newdata = totalSS2, type = "response")
auc(roc(totalSS2$Binary_death_total, pred_modSSc2)) #AUC: 0.998
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSSc2) #The fixed effect of sediment level explains ~100% of variation of the total variation. If the random intercepts for studies are also included, then 100% of variation is explained.

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Not significant
##se <- sqrt(diag(vcov(modSSc2)))
#tab <- cbind(Est = coef(modSSc2), 
#             LL = coef(modSSc2) - 1.96 * se, 
#             UL = coef(modSSc2) + 1.96 * se)
#exp(tab)
```
    
There is no significant relationship between sediment exposure and the odds of total colony mortality (concentration: GLMM z = 0.004, p = 0.997; duration: GLMM  z = 0.004, p = 0.997).
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSSc2 <- predict(modSSc2, newdata=totalSS2, type="response")
totalSS3 <- cbind(totalSS2, pred_modSSc2)

totalSS_plot <- ggplot(data = totalSS3) +
    geom_point(mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Total mortality due to sediment exposure?",
         color = "Study") +
    scale_x_log10(limits=c(1,200),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_mg_L, y = pred_modSSc2), inherit.aes=FALSE) +
    theme_bw()

totalSS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By exposure concentration
```{r}
jvalues <- with(totalSS2, seq(from = min(Sed_level_mg_L), to = max(Sed_level_mg_L), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    totalSS2$Sed_level_mg_L <- j
    predict(modSSc2, newdata = totalSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_level_mg_L values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_conc")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
totalSS_plot2 <- ggplot() +
    geom_point(data = totalSS2, mapping = aes(
      x = Sed_level_mg_L, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of total colony\nmortality due to sediment exposure",
         color = "Binary data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(1,200), breaks=c(0.01,0.1,1,10,100,1000,loaelSS3),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelSS3,digits=1))) +
    geom_ribbon(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS3, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

totalSS_plot2
```
  
##### By exposure duration
```{r}
jvalues <- with(totalSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    totalSS2$Sed_exposure_days <- j
    predict(modSSc2, newdata = totalSS2, type = "response")
})

# get the means with lower and upper quartiles
plotdat <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows
colnames(plotdat) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat)

# plot average marginal predicted probabilities
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
totalSS_plot2 <- ggplot() +
    geom_point(data = totalSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_death_total,
      color = Ref)) +
    labs(x = expression("Sediment exposure duration (days)"), 
         y = "Predicted probability of total colony\nmortality due to sediment exposure",
         color = "Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(totalSS2$Sed_exposure_days))) +
    geom_ribbon(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

totalSS_plot2
```
  