---
title: "Binary responses of corals to sediment stress"
author: "Lillian J. Tuttle"
date: "9/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(lme4)
library(pROC)
library(effects)
library(lattice)
library(MuMIn)
binary <- read.csv("data/binary_ALL.csv", header=T)

#keyboard shortcuts to remember: 
#command-option-I inserts new code chunk
#command-shift-M inserts pipeline symbols
#command-enter runs line of code where cursor is (or highlighted portion)
```

#### Here I will explore how DEPOSITED AND SUSPENDED sediment affects the PRESENCE/ABSENCE OF NON-ADVERSE AND ADVERSE EFFECTS of tropical, scleractinean coral of all life-history stages. The database to be used is comprised of data extracted from studies deemed relevant during the systematic literature review process.

# The Dataset
  
## Deposited Sediment  
Specifically, we will explore the results of 1644 datapoints from 45 studies conducted in 3 oceans on 113 species within 53 genera (shown below only the top 10 species and genera, by number of datapoints).

```{r, echo=FALSE, warning=FALSE}
#head(binaryDS)
binaryDS <- binary %>%
  filter(DS_SS=="DS") %>% 
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(Binary_sed_burial=="0") #remove all studies that buried corals instead of giving them a specific dosage (in mg/cm2/day)
binaryDS %>% tally() #n=1644 datapoints, tally() returns same result as count(binaryDS)
binaryDS %>% count(Ref) #n=45 studies
unique(binaryDS[c("Ref", "Ref_name")])
binaryDS %>% count(Ref_name) #n=44 articles, count(Ref_name) = group_by(Ref_name) %>% tally()
binaryDS %>% count(Ocean, sort=T) #n=3 oceans (another is the "Indo-Pacific", a.k.a. Singapore)
binaryDS %>% count(Gsp, sort=T) %>% #n=113 species
  top_n(10)
binaryDS %>% count(Updated_Genus, sort=T) %>%  #n=53 genera
  top_n(10)
```
  
## Suspended Sediment  
Specifically, we will explore the results of 661 datapoints from 41 studies conducted in 3 oceans on 29 species within 18 genera (shown below only the top 10 species and genera, by number of datapoints).

```{r, echo=FALSE, warning=FALSE}
 #head(binarySS)
binarySS <- binary %>%
  filter(DS_SS=="SS") %>% 
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(!str_detect(Ref, "SS03b")) %>% #removes only study that looked at auto/heterotrophy (Anthony & Fabricius 2000)
  filter(!is.na(Sed_level_stand_mg)) #removes studies that only report NTU and not mg/L
binarySS %>% tally() #n=661 datapoints, tally() returns same result as count(binarySS)
binarySS %>% count(Ref, sort=T) #n=41 studies
binarySS %>% count(Ref_name, sort=T) #n=22 articles, count(Ref_name) = group_by(Ref_name) %>% tally()
binarySS %>% count(Ocean, sort=T) #n=3 oceans (another is the "Indo-Pacific", e.g. Singapore)
binarySS %>% count(Gsp, sort=T) %>% #n=29 species
  top_n(10)
binarySS %>% count(Updated_Genus, sort=T) %>% #n=18 genera
  top_n(10)
```


# Exploratory plots

First let's explore all data from all species for which there is binary data about the presence of 'non-adverse effects', 'adverse effects', and 'any mortality' as a result of exposure to deposited and suspended sediment.  

##### DEFINITIONS:  
* '**Non-adverse effects**' are defined as hydrostatic inflation, tentacular activity, increased mucus production, and/or congealed sediment.  
* '**Adverse effects**' are defined as a shift from auto- to hetero-trophy, reduced photosynthetic efficiency, reduced P/R ratio, reduced growth rate, bleaching (or reduced chlorophyll A content), algal overgrowth, smothering, and any degree of tissue/colony mortality. Here we consider only adult corals.  
* '**Any mortality**' is defined as the presence of small, large, or total necroses of coral's surface area.  

```{r, echo=FALSE, warning=FALSE}
#NON-ADVERSE EFFECTS, plotted by exposure concentration (x) and exposure duration (y)

#DEPOSITED SEDIMENT
non_adverse <- binaryDS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Binary_effect_non_adverse) %>% 
  filter(!is.na(Binary_effect_non_adverse)) #remove NAs (studies that did not describe non-adverse effects)
#non_adverse %>% tally() #n=605 datapoints, tally() returns same result as count(non_adverse)
#non_adverse %>% count(Ref_name, sort=T) #n=17 articles, count(Ref_name) = group_by(Ref_name) %>% tally()
#non_adverse %>% count(Ref, sort=T) #n=17 studies
#non_adverse %>% count(Gsp) #n=65 species
#non_adverse %>% count(Updated_Genus, sort=T) #n=39 genera
non_adverse_plot <- ggplot(data=non_adverse, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_effect_non_adverse),
      shape = factor(Binary_effect_non_adverse),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(non_adverse, Binary_effect_non_adverse=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Exposure duration (days)") +
    scale_x_log10(limits=c(0.1,1000), breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits=c(0.1,100), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_color_manual(name = "Non-adverse effects\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Non-adverse effects\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#SUSPENDED SEDIMENT
non_adverseSS <- binarySS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Binary_effect_non_adverse) %>% 
  filter(!is.na(Binary_effect_non_adverse)) #remove NAs (studies that did not describe non-adverse effects)
#non_adverseSS %>% tally() #n=125 datapoints, tally() returns same result as count(non_adverse)
#non_adverseSS %>% count(Ref, sort=T) #n=6 studies
#non_adverseSS %>% count(Ref_name, sort=T) #n=4 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#non_adverseSS %>% count(Gsp) #n=8 species
#non_adverseSS %>% count(Updated_Genus, sort=T) #n=6 genera, top four: Acropora n=77, Montipora n=33, Merulina n=4, Pachyseris n=4

non_adverseSS_plot <- ggplot(data=non_adverseSS, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_effect_non_adverse),
      shape = factor(Binary_effect_non_adverse),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(non_adverseSS, Binary_effect_non_adverse=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_log10(limits=c(0.1,1000), breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits=c(0.1,100), breaks=c(0.01,0.1,1,10,100), 
                  label=c("0.01","0.1","1","10","100")) +
    scale_color_manual(name = "Non-adverse effects due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Non-adverse effects due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()



#ADVERSE EFFECTS, plotted by exposure concentration (x) and exposure duration (y)

#DEPOSITED SEDIMENT
adverse <- binaryDS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Binary_effect_adverse, Coral_age_class) %>% 
  filter(!is.na(Binary_effect_adverse)) #remove NAs (studies that did not describe adverse effects)
#adverse %>% tally() #n=1256 datapoints, tally() returns same result as count(adverse)
#adverse %>% count(Ref, sort=T) #n=38 studies
#adverse %>% count(Ref_name, sort=T) #n=37 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#adverse %>% count(Gsp) #n=91 species
#adverse %>% count(Updated_Genus) #n=44 genera
adverse_plot <- ggplot(data=adverse, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_effect_adverse),
      shape = factor(Binary_effect_adverse),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(adverse, Binary_effect_adverse=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Exposure duration (days)") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000), 
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits=c(0.1,200), breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_color_manual(name = "Adverse effects\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Adverse effects\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#SUSPENDED SEDIMENT
adverseSS <- binarySS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Binary_effect_adverse, Coral_age_class) %>% 
  filter(!is.na(Binary_effect_adverse)) #remove NAs (studies that did not describe adverse effects)
#adverseSS %>% tally() #n=585 datapoints, tally() returns same result as count(adverse)
#adverseSS %>% count(Ref, sort=T) #n=37 studies,
#adverseSS %>% count(Ref_name, sort=T) #n=20 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#adverseSS %>% count(Gsp) #n=26 species
#adverseSS %>% count(Updated_Genus, sort=T) #n=18 genera, top four: Acropora n=87, Merulina n=54, Pachyseris n=54, Platygyra n=54	
adverseSS_plot <- ggplot(data=adverseSS, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_effect_adverse),
      shape = factor(Binary_effect_adverse),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(adverseSS, Binary_effect_adverse=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                  label=c("0.1","1","10","100","1000")) +
    scale_y_log10(breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_color_manual(name = "Adverse effects\ndue to sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Adverse effects\ndue to sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()



#ANY MORTALITY, plotted by exposure concentration (x) and exposure duration (y)

#DEPOSITED SEDIMENT
any_mort <- binaryDS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Binary_sed_burial, Binary_effect_mortality) %>% 
  filter(!is.na(Binary_effect_mortality)) #remove NAs (studies that did not describe total mortality)
#any_mort %>% tally() #n=906 datapoints, tally() returns same result as count(any_mort)
#any_mort %>% count(Ref, sort=T) #n=30 studies
#any_mort %>% count(Ref_name, sort=T) #n=29 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#any_mort %>% count(Gsp) #n=81 species
#any_mort %>% count(Updated_Genus, sort=T) #n=41 genera
any_mort_plot <- ggplot(data=any_mort, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_effect_mortality),
      shape = factor(Binary_effect_mortality),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(any_mort, Binary_effect_mortality=="0")) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Exposure duration (days)") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    scale_y_log10(limits=c(0.1,200), breaks=c(0.1,1,10,100),
                  label=c("0.1","1","10","100")) +
    scale_color_manual(name = "Partial or total\nmortality due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Partial or total\nmortality due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()

#SUSPENDED SEDIMENT
any_mortSS <- binarySS %>% 
  select(Ref, Ref_name, Control_code, Sed_level_stand_mg, Updated_Genus, Gsp, Ocean, Sed_exposure_days, Binary_effect_mortality) %>%
  filter(!is.na(Binary_effect_mortality)) #remove NAs (studies that did not describe total mortality)
#any_mortSS %>% tally() #n=376 datapoints, tally() returns same result as count(any_mort)
#any_mortSS %>% count(Ref, sort=T) #n=19 studies
#any_mortSS %>% count(Ref_name, sort=T) #n=11 studies, count(Ref_name) = group_by(Ref_name) %>% tally()
#any_mortSS %>% count(Gsp) #n=21 species
#any_mortSS %>% count(Updated_Genus, sort=T) #n=15 genera, top five: Merulina n=50, Pachyseris n=50, Platygyra n=50, Acropora n=37
any_mortSS_plot <- ggplot(data=any_mortSS, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Sed_exposure_days,
      color = factor(Binary_effect_mortality),
      shape = factor(Binary_effect_mortality),
      position = "jitter",
      text = Gsp)) +
    geom_point(data = subset(any_mortSS, Binary_effect_mortality=="0")) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Exposure duration (days)") +
    scale_x_log10(limits=c(0.1,200), breaks=c(0.01,0.1,1,10,100), 
                  label=c("0.01","0.1","1","10","100")) +
    scale_y_log10(limits=c(0.1,100), breaks=c(0.01,0.1,1,10,100),
                  label=c("0.01","0.1","1","10","100")) +
    scale_color_manual(name = "Partial or total\nmortality due\nto sediment?",
                       values = c("blue", "red"),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    scale_shape_manual(name = "Partial or total\nmortality due\nto sediment?",
                       values = c(16,15),
                       breaks = c("0","1"), labels = c("no", "yes")) +
    theme_bw()



#PLOTS with legend showing stats:
non_adverse_plot + geom_point(data = subset(non_adverse, Binary_effect_non_adverse=="1")) +
  labs(title = "Non-adverse Effects from Deposited Sediment",
       subtitle = "n = 605 datapoints, n = 17 studies from 17 articles, n = 65 spp. from 39 genera")
non_adverseSS_plot + geom_point(data = subset(non_adverseSS, Binary_effect_non_adverse=="1")) +
  labs(title = "Non-adverse Effects from Suspended Sediment",
       subtitle = "n = 125 datapoints, n = 6 studies from 4 articles, n = 8 spp. from 6 genera")

adverse_plot + geom_point(data = subset(adverse, Binary_effect_adverse=="1")) +
  labs(title = "Adverse Effects from Deposited Sediment", 
       subtitle = "n = 1256 datapoints, n = 38 studies from 37 articles, n = 91 spp. from 44 genera")
adverseSS_plot + geom_point(data = subset(adverseSS, Binary_effect_adverse=="1")) +
  labs(title = "Adverse Effects from Suspended Sediment", 
       subtitle = "n = 585 datapoints, n = 37 studies from 20 articles, n = 26 spp. from 18 genera")

any_mort_plot + geom_point(data = subset(any_mort, Binary_effect_mortality=="1")) +
  labs(title = "Any mortality from Deposited Sediment", 
       subtitle = "n = 906 datapoints, n = 31 studies from 30 articles, n = 81 spp. from 41 genera")
any_mortSS_plot + geom_point(data = subset(any_mortSS, Binary_effect_mortality=="1")) +
  labs(title = "Any mortality from Suspended Sediment", 
       subtitle = "n = 376 datapoints, n = 19 studies from 11 articles, n = 21 spp. from 15 genera")
```
  
  
# Threshold Analyses with Binary Data 
Now let's calculate thresholds based on the binary data explored above.  

##### DEFINITIONS:  
* '**LOAEL**', or the 'lowest observed adverse effect level' is defined as the lowest dose at which there was an observed adverse effect.  
* '**NOAEL**', or the 'no observed adverse effect level' is defined as the highest dose at which there was NOT an observed adverse effect.  
* '**Adverse effect**' is defined here as any response of a coral individual, colony, or experimental treatment group that *may* negatively affect the coralâ€™s fitness and/or survival. These adverse effects may include sublethal physiological changes (e.g., significantly reduced growth or photosynthetic rates when compared to coral in ambient/control conditions), bleaching/tissue loss, and mortality.  This definition of adverse effect is independent of its magnitude, so while the affect may have potentially reduced fitness, its magnitude may be sufficiently small that the fitness effect is not measurable.  
  
 
## DEPOSITED SEDIMENT   
### Adverse effect
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_adverse <- adverse %>% 
  filter(Binary_effect_adverse=="1") %>%
  arrange(Sed_level_stand_mg) %>% #minimum Sedimentation level is 0! --> Looked at this particular row, and it is from Hodel 2007 who studied the recovery period post-exposure (hence sed level is 0 but still experiencing mortality). Therefore, this will not be an accurate LOAEL
  filter(Sed_level_stand_mg>0) #removed Hodel sample described above

#LOAEL
summarize(adverse_adverse, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 1 and comes from Sofonia (2006) PhD Chapter 4: Montipora_tuberculosa, 15 days exposure
loael <- adverse_adverse %>% summarize(min(Sed_level_stand_mg))
loael <- as.numeric(loael)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_adverse <- adverse %>%
  filter(Binary_effect_adverse=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=1) #less than or equal to the LOAEL, which = 1

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_adverse, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 1

#PLOT
ggplot(data = adverse) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_adverse)) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Adverse effect due to sedimentation?\n(0 = no, 1 = yes)") +
    scale_x_continuous(trans='log10', breaks=c(0.01,0.1,1,10,100,1000), label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=1, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```

#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_adverse2 <- adverse %>% 
  filter(Binary_effect_adverse=="1") %>% 
  filter(!is.na(Sed_exposure_days))

#LOAEL
summarize(adverse_adverse2, LOAEL=min(Sed_exposure_days)) #LOAEL is 0.5 day

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_adverse2 <- adverse %>%
  filter(Binary_effect_adverse=="0") %>%
  filter(Sed_exposure_days<=0.5) #less than or equal to the LOAEL, which = 0.5

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_adverse2, NOAEL=max(Sed_exposure_days)) #NOAEL is 0.5 day

#PLOT LOAELs
adverse_plot + geom_point(data = subset(adverse, Binary_effect_adverse=="1")) +
    annotate("rect", xmin=1, xmax=Inf, ymin=0.5, ymax=Inf, fill = "red", alpha=0.2) +
    labs(caption = "LOAEL concentration = 1, duration = 12 h\nNOAEL concentration = 1, duration = 12 h\nShaded box represents 'risky' exposure area\nn = 1256 datapoints, n = 38 studies from 37 articles, n = 91 spp. from 44 genera")
```
  
  
### Any mortality
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_any_mort <- any_mort %>% 
  filter(Binary_effect_mortality=="1") %>%
  arrange(Sed_level_stand_mg) %>% #minimum Sedimentation level is 0! --> Looked at this particular row, and it is from Hodel 2007 who studied the recovery period post-exposure (hence sed level is 0 but still experiencing mortality). Therefore, this will not be an accurate LOAEL
  filter(Sed_level_stand_mg>0) #removed Hodel sample described above

#LOAEL
summarize(adverse_any_mort, LOAEL=min(Sed_level_stand_mg)) ##LOAEL is 4.9 and comes from Sofonia (2006) PhD Chapter 4: Montipora_tuberculosa, 15 days exposure
loael2 <- adverse_any_mort %>% summarize(min(Sed_level_stand_mg))
loael2 <- as.numeric(loael2)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_any_mort <- any_mort %>%
  filter(Binary_effect_mortality=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=4.9) #less than or equal to the LOAEL, which = 4.9

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_any_mort, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 4.4

#PLOT
ggplot(data = any_mort) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_mortality)) + 
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Any mortality\ndue to sedimentation?") +
    scale_x_continuous(trans='log10', breaks=c(0.01,0.1,1,10,100,1000), label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=4.9, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```

#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_any_mort2 <- any_mort %>% 
  filter(Binary_effect_mortality=="1") %>% 
  filter(!is.na(Sed_exposure_days)) %>% 
  arrange(Sed_exposure_days) 

#LOAEL
summarize(adverse_any_mort2, LOAEL=min(Sed_exposure_days)) #LOAEL is 0.917 day = 22h

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_any_mort2 <- any_mort %>%
  filter(Binary_effect_mortality=="0") %>%
  filter(Sed_exposure_days<=0.917) #less than or equal to the LOAEL, which = 0.917

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_any_mort2, NOAEL=max(Sed_exposure_days)) #NOAEL is 0.917 day

#PLOT LOAELs
any_mort_plot + geom_point(data = subset(any_mort, Binary_effect_mortality=="1")) +
    annotate("rect", xmin=4.9, xmax=Inf, ymin=0.917, ymax=Inf, fill = "red", alpha=0.2) + 
    labs(caption = "LOAEL concentration = 4.9, duration = 22 h\nNOAEL concentration = 4.4, duration = 22 h\nShaded box represents 'risky' exposure area\nn = 906 datapoints, n = 30 studies from 29 articles, n = 81 spp. from 41 genera")
```
  
  
## SUSPENDED SEDIMENT  
### Adverse effect
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_adverseSS <- adverseSS %>% 
  filter(Binary_effect_adverse=="1") %>%
  arrange(Sed_level_stand_mg) %>% 
  filter(!is.na(Sed_level_stand_mg))

#LOAEL
summarize(adverse_adverseSS, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 3.22 and comes from Flores et al. 2012: Montipora aequituberculata, 84 days exposure
loaelSS <- adverse_adverseSS %>% summarize(min(Sed_level_stand_mg))
loaelSS <- as.numeric(loaelSS)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_adverseSS <- adverseSS %>%
  filter(Binary_effect_adverse=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=3.22) #less than or equal to the LOAEL, which = 3.22

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_adverseSS, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 3.22

#PLOT
ggplot(data = adverseSS) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_adverse)) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Adverse effect due to suspended sediment?\n(0 = no, 1 = yes)") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000), label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```

#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverse_adverseSS3 <- adverseSS %>% 
  filter(Binary_effect_adverse=="1") %>%
  filter(!is.na(Sed_level_stand_mg)) %>%
  arrange(Sed_exposure_days) %>% 
  filter(Coral_age_class=='adult' | Coral_age_class=='juvenile')

#LOAEL
summarize(adverse_adverseSS3, LOAEL=min(Sed_exposure_days)) #LOAEL is 0.04167 d = 1 h and is from Humanes et al. 2017a, Acropora_tenuis @ 100 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverse_adverseSS3 <- adverseSS %>%
  filter(Binary_effect_adverse=="0") %>%
  arrange(desc(Sed_exposure_days)) %>%
  filter(Sed_exposure_days<=0.041666666667) #less than or equal to the LOAEL, which = 0.04167

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverse_adverseSS3, NOAEL=max(Sed_exposure_days)) #NOAEL is 0.0208333 d = 30 min

#PLOT LOAELs
adverseSS_plot + geom_point(data = subset(adverseSS, Binary_effect_adverse=="1")) +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=0.0104, ymax=Inf, fill = "red", alpha=0.2) +
    labs(caption = "LOAEL concentration = 3.2, duration = 1 h\nNOAEL concentration = 3.2, duration = 30 min\nShaded box represents 'risky' exposure area\nn = 585 datapoints, n = 37 studies from 20 articles, n = 26 spp. from 18 genera")
```
  
  
### Any mortality
#### NOAEL/LOAEL defined by exposure concentration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverseSS_any_mort <- any_mortSS %>% 
  filter(Binary_effect_mortality=="1") %>%
  arrange(Sed_level_stand_mg)

#LOAEL
summarize(adverseSS_any_mort, LOAEL=min(Sed_level_stand_mg)) #LOAEL is 3.22 and comes from Flores et al. 2012: Montipora aequituberculata, 84 days exposure
loaelSS2 <- adverseSS_any_mort %>% summarize(min(Sed_level_stand_mg))
loaelSS2 <- as.numeric(loaelSS2)

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverseSS_any_mort <- any_mortSS %>%
  filter(Binary_effect_mortality=="0") %>%
  arrange(desc(Sed_level_stand_mg)) %>%
  filter(Sed_level_stand_mg<=3.22) #less than or equal to the LOAEL, which = 3.22

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverseSS_any_mort, NOAEL=max(Sed_level_stand_mg)) #NOAEL is 3.22

#PLOT
ggplot(data = any_mortSS) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_mortality)) + 
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Any mortality\ndue to suspended sediment?") +
    scale_x_log10(breaks=c(0.01,0.1,1,10,100,1000), label=c("0.01","0.1","1","10","100","1000")) +
    theme_bw() +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=-Inf, ymax=Inf, fill = "red", alpha=0.2)
```

#### NOAEL/LOAEL defined by exposure duration  
```{r, echo=FALSE, warning=FALSE}
#Setting up for LOAEL by filtering for adverse effects (binary=1)
adverseSS_any_mort2 <- any_mortSS %>% 
  filter(Binary_effect_mortality=="1") %>%
  arrange(Sed_exposure_days)

#LOAEL
summarize(adverseSS_any_mort2, LOAEL=min(Sed_exposure_days)) #LOAEL is 0.5 day and is from Ricardo et al. 2016 with Acropora_millepora @ 962 mg/L

#Setting up for NOAEL by filtering for non-adverse effects (binary=0), and then by any sediment level less than or equal to the LOAEL
non_adverseSS_any_mort2 <- any_mortSS %>%
  filter(Binary_effect_mortality=="0") %>%
  arrange(desc(Sed_exposure_days)) %>% 
  filter(Sed_exposure_days<=0.5) #less than or equal to the LOAEL, which = 0.5

#NOAEL = maximum sediment level with no adverse effect
summarize(non_adverseSS_any_mort2, NOAEL=max(Sed_exposure_days)) #NOAEL is 0.5 days and is from Ricardo et al. 2016

#PLOT LOAELs
any_mortSS_plot + geom_point(data = subset(any_mortSS, Binary_effect_mortality=="1")) +
    annotate("rect", xmin=3.22, xmax=Inf, ymin=0.5, ymax=Inf, fill = "red", alpha=0.2) + 
    labs(caption = "LOAEL concentration = 3.2, duration = 12 h\nNOAEL concentration = 3.2, duration = 12 h\nShaded box represents 'risky' exposure area\nn = 376 datapoints, n = 19 studies from 11 articles, n = 21 spp. from 15 genera")
```
  
  
# Logistic Regression Model Fitting 

## DEPOSITED SEDIMENT   
### Adverse effect
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
adverseDS3 <- adverse %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg)) %>% 
  filter(Control_code=="0")
adverseDS3 %>% tally()
#adverseDS3 %>% count(Ref_name)
#adverseDS3 %>% count(Ref)
adverseDS3 <- adverseDS3 %>% filter(!is.na(Sed_exposure_days))

#Models with fixed effect(s) only
modDS1 <- glm(Binary_effect_adverse ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = adverseDS3)
modDS2 <- glm(Binary_effect_adverse ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = adverseDS3)
modDS3 <- glm(Binary_effect_adverse ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = adverseDS3)

#models with random effect for coral species or study
modDS4 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = adverseDS3)
modDS5 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = adverseDS3)
modDS6 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = adverseDS3)
modDS7 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = adverseDS3)
modDS8 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = adverseDS3)
modDS9 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = adverseDS3)
modDS10 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = adverseDS3)
modDS11 <- glmer(Binary_effect_adverse ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = adverseDS3)
modDS12 <- glmer(Binary_effect_adverse ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = adverseDS3)
modDS13 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Ref_name/Ref), 
              family = binomial, data = adverseDS3)
modDS14 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = adverseDS3)
modDS15 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = adverseDS3)
modDS16 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = adverseDS3)
modDS17 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = adverseDS3)
modDS18 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = adverseDS3)
modDS19 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = adverseDS3)
modDS20 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = adverseDS3)
modDS21 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = adverseDS3)

#Model comparison and summary
anova(modDS6,modDS9,modDS12,modDS15,modDS18,modDS21) #compare full fixed effects models -- mod12 is best
anova(modDS10,modDS11,modDS12) #mod12 is best, but 11 will be better to interpret
anova(modDS4,modDS7,modDS10,modDS13,modDS16,modDS19) #compare reduced fixed effects models -- mod16 is best
print(summary(modDS11), correlation=FALSE)
#Model is nearly unidentifiable: large eigenvalue ratio - Rescale variables?

#Trying out a log transformation of predictor...
modDS11_log <- glmer(Binary_effect_adverse ~ 
                       log10_conc + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
                     family = binomial, data = adverseDS3)
print(summary(modDS11_log), correlation=FALSE)
#No errors
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDS11_log, type="response")>0.5)
#proportion correct:
mean(p==adverseDS3$Binary_effect_adverse) #[1] 0.804878
#predicted-vs-observed table:
table(p,adverseDS3$Binary_effect_adverse)
#ROC and area under the curve:
pred_modDS11_log <- predict(modDS11_log, newdata = adverseDS3, type = "response")
auc(roc(adverseDS3$Binary_effect_adverse, pred_modDS11_log)) #AUC: 0.8877
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDS11_log) #The fixed effect of sediment level explains ~5% of variation of the total variation. If the random intercepts for studies are also included, then 78% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDS11_log))
dotplot(ranef(modDS11_log, condVar = T)) #residual variation at the level of studies/species -- variation is large!
qqnorm(ranef(modDS11_log)$Ref[,1])
qqline(ranef(modDS11_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDS11_log) 
exp(sqrt(VarCorr(modDS11_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(sd) = 
modDS11_log_noSed <- glmer(Binary_effect_adverse ~ 1 + (1 | Gsp) + (1 | Ref), 
                           family = binomial, data = adverseDS3)
random.intercepts <- ranef(modDS11_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDS11_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)), 
                    from = min(adverseDS3$log10_conc), to = max(adverseDS3$log10_conc), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "log10(exposure concentration, mg/cm2/d)")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDS11_log)["log10_conc"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modDS11_log)))
tab <- cbind(Est = fixef(modDS11_log), 
             LL = fixef(modDS11_log) - 1.96 * se, 
             UL = fixef(modDS11_log) + 1.96 * se)
exp(tab) #for log10_conc
10^(tab) #for Sed_exposure_days
```
    
For every 10-fold increase in exposure concentration of deposited sediment, the odds of an adverse effect increase by 3.4 times (95% CI 2.2, 5.5, GLMM z = 5.168, p < 0.0001), while holding exposure duration constant and accounting for variability among studies and species. For every 10-fold increase in exposure duration of deposited sediment, the odds of an adverse effect increase by 1.05 times (95% CI 1.03, 1.07, GLMM z = 4.559, p < 0.0001), while holding exposure concentration constant and accounting for variability among studies and species.
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDS11_log <- predict(modDS11_log, newdata=adverseDS3, type="response")
adverseDS3 <- cbind(adverseDS3, pred_modDS11_log)

adverseDS_plot <- ggplot(data = adverseDS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_adverse)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Adverse effects due to sediment exposure?") +
    scale_x_log10(limits=c(0.01,max(adverseDS3$Sed_level_stand_mg)),
                  breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modDS11_log), inherit.aes=FALSE) +
    theme_bw()

adverseDS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
```{r}
jvalues <- with(adverseDS3, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    adverseDS3$log10_conc <- j
    predict(modDS11_log, newdata = adverseDS3, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(0,1,2,3)], mean)
## 
# get the means with lower and upper quartiles
plotdat1_2 <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat1_2 <- as.data.frame(cbind(plotdat1_2, jvalues))
plotdat1_2 <- plotdat1_2 %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat1_2) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_conc", "Sed_conc")
#head(plotdat1_2)
#approx(plotdat1_2$Sed_conc, plotdat1_2$PredictedProbability, xout=1)
sed <- c(1,5,10,50,100,500,1000)
sed2 <- lapply(sed, function(x) approx(plotdat1_2$Sed_conc, plotdat1_2$PredictedProbability, xout=x))
unlist(sed2)

# plot average marginal predicted probabilities
ggplot(plotdat1_2, aes(x = log10_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat1_2, aes(x = log10_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat1_2, aes(x = Sed_conc, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
adverseDS_plot2 <- ggplot() +
    geom_point(data = adverseDS3, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_adverse)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of adverse\neffect due to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.01,max(adverseDS3$Sed_level_stand_mg)), 
                  breaks=c(0.01,0.1,1,10,100,1000,loael),
                  label=c("0.01","0.1","1","10","100","1000",round(loael,digits=1))) +
    geom_ribbon(data = plotdat1_2, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat1_2, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat1_2, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loael, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

adverseDS_plot2
```
  
### Any mortality
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
anymortDS2 <- any_mort %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg)) %>% 
  filter(Control_code=="0")
anymortDS2 %>% tally()
#anymortDS2 %>% count(Ref)
#anymortDS2 %>% count(Ref_name)

#Models with fixed effect(s) only
modDSb1 <- glm(Binary_effect_mortality ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = anymortDS2)
modDSb2 <- glm(Binary_effect_mortality ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = anymortDS2)
modDSb3 <- glm(Binary_effect_mortality ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = anymortDS2)

#models with random effect for coral species or study
modDSb4 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = anymortDS2)
modDSb5 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = anymortDS2)
modDSb6 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = anymortDS2)
modDSb7 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = anymortDS2)
modDSb8 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
              family = binomial, data = anymortDS2)
modDSb9 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg*Sed_exposure_days + (1 | Ref), 
              family = binomial, data = anymortDS2)
modDSb10 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = anymortDS2)
modDSb11 <- glmer(Binary_effect_mortality ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = anymortDS2)
modDSb12 <- glmer(Binary_effect_mortality ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = anymortDS2)
modDSb13 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Ref_name/Ref), 
              family = binomial, data = anymortDS2)
modDSb14 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = anymortDS2)
modDSb15 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = anymortDS2)
modDSb16 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = anymortDS2)
modDSb17 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = anymortDS2)
modDSb18 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = anymortDS2)
modDSb19 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = anymortDS2)
modDSb20 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = anymortDS2)
modDSb21 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = anymortDS2)

#Model comparison and summary
anova(modDSb6,modDSb9,modDSb12,modDSb15,modDSb18,modDSb21) #compare full fixed effects models -- mod12 is best
anova(modDSb10,modDSb11,modDSb12) #mod12 but 11 easier to interpret
anova(modDSb4,modDSb7,modDSb10,modDSb13,modDSb16,modDSb19) #compare reduced fixed effects models -- mod16 is best
#print(summary(modDSb12), correlation=FALSE)
#Model failed to converge with max|grad| = 0.20387 (tol = 0.002, component 1)
#Model is nearly unidentifiable: very large eigenvalue - Rescale variables?
#Model is nearly unidentifiable: large eigenvalue ratio - Rescale variables?

#Trying out a log transformation of predictor...
modDSb11_log <- glmer(Binary_effect_mortality ~ log10_conc + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
                      family = binomial, data = anymortDS2)
print(summary(modDSb11_log), correlation=FALSE)
#No errors!
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modDSb11_log, type="response")>0.5)
#proportion correct:
mean(p==anymortDS2$Binary_effect_mortality) #[1] 0.8484006
#predicted-vs-observed table:
table(p,anymortDS2$Binary_effect_mortality)
#ROC and area under the curve:
pred_modDSb11_log <- predict(modDSb11_log, newdata = anymortDS2, type = "response")
auc(roc(anymortDS2$Binary_effect_mortality, pred_modDSb11_log)) #AUC: 0.9317
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modDSb11_log) #The fixed effect of sediment level explains ~10% of variation of the total variation. If the random intercepts for studies are also included, then 83% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modDSb11_log))
dotplot(ranef(modDSb11_log, condVar = T)) #residual variation at the level of studies/species -- variation is large!
qqnorm(ranef(modDSb11_log)$Ref[,1])
qqline(ranef(modDSb11_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modDSb11_log) #SD=4.8,5.3
exp(sqrt(VarCorr(modDSb11_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(sd) = x (?)
modDSb11_log_noSed <- glmer(Binary_effect_mortality ~ 1 + (1 | Gsp) + (1 | Ref), 
                            family = binomial, data = anymortDS2)
random.intercepts <- ranef(modDSb11_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modDSb11_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)), 
                    from = min(anymortDS2$log10_conc), 
                    to = max(anymortDS2$log10_conc), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "log10(exposure concentration, mg/cm2/d)")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modDSb11_log)["log10_conc"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modDSb11_log)))
tab <- cbind(Est = fixef(modDSb11_log), 
             LL = fixef(modDSb11_log) - 1.96 * se, 
             UL = fixef(modDSb11_log) + 1.96 * se)
exp(tab)
10^(tab)
```
    
For every 10-fold increase in exposure concentration of deposited sediment, the odds of any tissue mortality increase by 8.5 times (95% CI 3.6, 20.3; GLMM z = 4.814, p < 0.0001), while holding exposure duration constant and accounting for variability among studies and species. For every 10-fold increase in exposure duration of deposited sediment, the odds of any tissue mortality increase by 1.08 times (95% CI 1.05, 1.11; GLMM z = 5.123, p < 0.0001), while holding exposure concentration constant and accounting for variability among studies and species. 
  
#### Prediction figure  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modDSb11_log <- predict(modDSb11_log, newdata=anymortDS2, type="response")
anymortDS3 <- cbind(anymortDS2, pred_modDSb11_log)

anymortDS_plot <- ggplot(data = anymortDS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_mortality,
      color = Ref)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Any mortality due to sediment exposure?",
         color = "Study") +
    scale_x_log10(limits=c(0.01,1000),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modDSb11_log), inherit.aes=FALSE) +
    theme_bw()

anymortDS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
```{r}
jvalues <- with(anymortDS2, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    anymortDS2$log10_conc <- j
    predict(modDSb11_log, newdata = anymortDS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## 
# get the means with lower and upper quartiles
plotdat2_2 <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat2_2 <- as.data.frame(cbind(plotdat2_2, jvalues))
plotdat2_2 <- plotdat2_2 %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat2_2) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_conc", "Sed_conc")
#head(plotdat2_2)
sed <- c(1,5,10,50,100,500,1000)
sed2 <- lapply(sed, function(x) approx(plotdat2_2$Sed_conc, plotdat2_2$PredictedProbability, xout=x))
print(unlist(sed2), digits = 3)

# plot average marginal predicted probabilities
ggplot(plotdat2_2, aes(x = log10_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat2_2, aes(x = log10_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat2_2, aes(x = Sed_conc, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
anymortDS_plot2 <- ggplot() +
    geom_point(data = anymortDS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_mortality)) +
    labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"), 
         y = "Predicted probability of any tissue\nmortality due to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.01,1000), breaks=c(0.01,0.1,1,10,100,1000,loael2),
                  label=c("0.01","0.1","1","10","100","1000",round(loael2,digits=1))) +
    geom_ribbon(data = plotdat2_2, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat2_2, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat2_2, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loael2, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

anymortDS_plot2
```
  
## Suspended Sediment
### Adverse Effect
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
adverseSS3 <- adverseSS %>% 
  filter(Control_code=="0") %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg))
adverseSS3 %>%  tally()
adverseSS3 %>%  count(Ref)
adverseSS3 %>%  count(Ref_name)

#Models with fixed effect(s) only
modSS1 <- glm(Binary_effect_adverse ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = adverseSS3)
modSS2 <- glm(Binary_effect_adverse ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = adverseSS3)
modSS3 <- glm(Binary_effect_adverse ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = adverseSS3)

#models with random effect for coral species or study
modSS4 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = adverseSS3)
modSS5 <- glmer(Binary_effect_adverse ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = adverseSS3)
modSS6 <- glmer(Binary_effect_adverse ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp),
                family = binomial, data = adverseSS3)
modSS7 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = adverseSS3)
modSS8 <- glmer(Binary_effect_adverse ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
                family = binomial, data = adverseSS3)
modSS9 <- glmer(Binary_effect_adverse ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Ref),
                family = binomial, data = adverseSS3)
modSS10 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = adverseSS3)
modSS11 <- glmer(Binary_effect_adverse ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = adverseSS3)
modSS12 <- glmer(Binary_effect_adverse ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = adverseSS3)
modSS13 <- glmer(Binary_effect_adverse ~ Sed_level_stand_mg + (1 | Ref_name/Ref), 
              family = binomial, data = adverseSS3)
modSS14 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = adverseSS3)
modSS15 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = adverseSS3)
modSS16 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = adverseSS3)
modSS17 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = adverseSS3)
modSS18 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = adverseSS3)
modSS19 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = adverseSS3)
modSS20 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = adverseSS3)
modSS21 <- glmer(Binary_effect_adverse ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = adverseSS3)

#model comparison and summary
anova(modSS6,modSS9,modSS12,modSS15,modSS18,modSS21) #compare full fixed effects models -- close call!
anova(modSS4,modSS5,modSS6) #mod6
anova(modSS10,modSS11,modSS12) #mod12
anova(modSS16,modSS17,modSS18) #mod18
anova(modSS6,modSS12,modSS18) #MOD6 but i like keeping ref in model...
anova(modSS6,modSS18) #either or...

#Trying out a log transformation of predictor...
modSS6_log <- glmer(Binary_effect_adverse ~ 
                      log10_conc*Sed_exposure_days + (1 | Gsp),
                    family = binomial, data = adverseSS3)
modSS18_log <- glmer(Binary_effect_adverse ~ 
                      log10_conc*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name),
                    family = binomial, data = adverseSS3)
print(summary(modSS18_log), correlation=FALSE)
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSS18_log, type="response")>0.5)
#proportion correct:
mean(p==adverseSS3$Binary_effect_adverse) #[1] 0.8534279
#predicted-vs-observed table:
table(p,adverseSS3$Binary_effect_adverse)
#ROC and area under the curve:
pred_modSS18_log <- predict(modSS18_log, newdata = adverseSS3, type = "response")
auc(roc(adverseSS3$Binary_effect_adverse, pred_modSS18_log)) #AUC: 0.9084
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSS18_log) #The fixed effect of sediment level explains ~14% of variation of the total variation. If the random intercepts for studies are also included, then 78% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modSS18_log))
dotplot(ranef(modSS18_log, condVar = T)) #residual variation at the level of studies/species -- variation is large!
qqnorm(ranef(modSS18_log)$Ref[,1])
qqline(ranef(modSS18_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modSS18_log) #SD
exp(sqrt(VarCorr(modSS18_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(sd) = x (?)
modSS18_log_noSed <- glmer(Binary_effect_adverse ~ 1 + (1 | Gsp) + (1 | Ref), 
                           family = binomial, data = adverseSS3)
random.intercepts <- ranef(modSS18_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modSS18_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modSS18_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSS18_log)["log10_conc"]*x)), 
                    from = min(adverseSS3$log10_conc), to = max(adverseSS3$log10_conc), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "log10(exposure concentration, mg/cm2/d)")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modSS18_log)["log10_conc"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSS18_log)["log10_conc"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

se <- sqrt(diag(vcov(modSS18_log)))
tab <- cbind(Est = fixef(modSS18_log), 
             LL = fixef(modSS18_log) - 1.96 * se, 
             UL = fixef(modSS18_log) + 1.96 * se)
exp(tab)
10^(tab)
```
    
For every 10-fold increase in exposure concentration of suspended sediment, the odds of experiencing an adverse effect increase by 7.4 times (95% CI 3.2, 17.0; GLMM z = 4.689, p < 0.0001), while holding constant exposure duration and the interaction between concentration and duration, and while accounting for variability among studies and species. For every 10-fold increase in exposure duration of suspended sediment, the odds of experiencing an adverse effect increase by 1.1 times (95% CI 1.0, 1.2; GLMM z = 2.539, p = 0.011), also while holding constant exposure concentration and the interaction between concentration and duration, and while accounting for variability among studies and species.
  
#### Prediction figures  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSS18_log <- predict(modSS18_log, newdata=adverseSS3, type="response")
adverseSS3 <- cbind(adverseSS3, pred_modSS18_log)

adverseSS_plot <- ggplot(data = adverseSS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_adverse,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Adverse effect due to sediment exposure",
         color = "Study") +
    scale_x_log10(limits=c(0.1,max(adverseSS3$Sed_level_stand_mg)),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modSS18_log), inherit.aes=FALSE) +
    theme_bw()

adverseSS_plot
```

That plot is confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By sediment exposure concentration
```{r}
jvalues <- with(adverseSS3, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    adverseSS3$log10_conc <- j
    predict(modSS18_log, newdata = adverseSS3, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat3_2 <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat3_2 <- as.data.frame(cbind(plotdat3_2, jvalues))
plotdat3_2 <- plotdat3_2 %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat3_2) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_conc", "Sed_conc")
#head(plotdat3_2)
sed <- c(1,5,10,50,100,500,1000)
sed2 <- lapply(sed, function(x) approx(plotdat3_2$Sed_conc, plotdat3_2$PredictedProbability, xout=x))
print(round(unlist(sed2), digits=3))

# plot average marginal predicted probabilities
ggplot(plotdat3_2, aes(x = log10_conc)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat3_2, aes(x = log10_conc)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat3_2, aes(x = Sed_conc, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
adverseSS_plot2 <- ggplot() +
    geom_point(data = adverseSS3, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_adverse)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of adverse\neffect due to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.1,max(adverseSS3$Sed_level_stand_mg)), 
                  breaks=c(0.01,0.1,1,10,100,1000,loaelSS),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelSS,digits=1))) +
    geom_ribbon(data = plotdat3_2, aes(x = Sed_conc, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat3_2, aes(x = Sed_conc, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat3_2, aes(x = Sed_conc, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

adverseSS_plot2
```
  
##### By sediment exposure duration
```{r}
jvalues <- with(adverseSS3, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    adverseSS3$Sed_exposure_days <- j
    predict(modSS18_log, newdata = adverseSS3, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat3_2b <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat3_2b <- as.data.frame(cbind(plotdat3_2b, jvalues))

# better names and show the first few rows
colnames(plotdat3_2b) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat3_2b)

# plot average marginal predicted probabilities
ggplot(plotdat3_2b, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat3_2b, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
adverseSS_plot3 <- ggplot() +
    geom_point(data = adverseSS3, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_effect_adverse,
      color = Ref)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of adverse\neffect due to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(adverseSS3$Sed_exposure_days))) +
    geom_ribbon(data = plotdat3_2b, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat3_2b, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat3_2b, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

adverseSS_plot3
```
  
### Any mortality
```{r, echo=FALSE, warning=FALSE}
#Let's add a log transformation of sediment level, in case it's needed
anymortSS2 <- any_mortSS %>% 
  filter(Control_code=="0") %>% 
  mutate(log10_conc=log10(Sed_level_stand_mg))
anymortSS2 %>% tally()
#anymortSS2 %>% count(Ref)
#anymortSS2 %>% count(Ref_name)

#Models with fixed effect(s) only
modSS1 <- glm(Binary_effect_mortality ~ Sed_level_stand_mg, 
            family = binomial(link = "logit"), data = anymortSS2)
modSS2 <- glm(Binary_effect_mortality ~ Sed_level_stand_mg + Sed_exposure_days, 
            family = binomial(link = "logit"), data = anymortSS2)
modSS3 <- glm(Binary_effect_mortality ~ Sed_level_stand_mg*Sed_exposure_days, 
            family = binomial(link = "logit"), data = anymortSS2)

#models with random effect for coral species or study
modSS4 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Gsp), 
              family = binomial, data = anymortSS2)
modSS5 <- glmer(Binary_effect_mortality ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp), 
              family = binomial, data = anymortSS2)
modSS6 <- glmer(Binary_effect_mortality ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp),
                family = binomial, data = anymortSS2)
modSS7 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Ref), 
              family = binomial, data = anymortSS2)
modSS8 <- glmer(Binary_effect_mortality ~ 
                  Sed_level_stand_mg + Sed_exposure_days + (1 | Ref), 
                family = binomial, data = anymortSS2)
modSS9 <- glmer(Binary_effect_mortality ~ 
                  Sed_level_stand_mg*Sed_exposure_days + (1 | Ref),
                family = binomial, data = anymortSS2)
modSS10 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = anymortSS2)
modSS11 <- glmer(Binary_effect_mortality ~ 
                Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = anymortSS2)
modSS12 <- glmer(Binary_effect_mortality ~ 
                Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref), 
              family = binomial, data = anymortSS2)
modSS13 <- glmer(Binary_effect_mortality ~ Sed_level_stand_mg + (1 | Ref_name/Ref), 
              family = binomial, data = anymortSS2)
modSS14 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = anymortSS2)
modSS15 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Ref_name/Ref), 
              family = binomial, data = anymortSS2)
modSS16 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = anymortSS2)
modSS17 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = anymortSS2)
modSS18 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name), 
              family = binomial, data = anymortSS2)
modSS19 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = anymortSS2)
modSS20 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg + Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = anymortSS2)
modSS21 <- glmer(Binary_effect_mortality ~ 
                 Sed_level_stand_mg*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name/Ref), 
              family = binomial, data = anymortSS2)

#model comparison and summary
anova(modSS6,modSS9,modSS12,modSS15,modSS18,modSS21) #compare full fixed effects models -- mod6 is best but 12 and 18 good
anova(modSS16,modSS17,modSS18) #mod18
#print(summary(modSS18), correlation=FALSE) 

#Trying out a log transformation of predictor...
modSSb18_log <- glmer(Binary_effect_mortality ~ 
                      log10_conc*Sed_exposure_days + (1 | Gsp) + (1 | Ref_name),
                    family = binomial, data = anymortSS2)
print(summary(modSSb18_log), correlation=FALSE) #no error
```
  
#### Effect estimates  
```{r, echo=FALSE, warning=FALSE}
##Diagnostics
#predicted probabilities, converted to 0 or 1 respectively:
p <- as.numeric(predict(modSSb18_log, type="response")>0.5)
#proportion correct:
mean(p==anymortSS2$Binary_effect_mortality) #[1] 0.8773946
#predicted-vs-observed table:
table(p,anymortSS2$Binary_effect_mortality)
#ROC and area under the curve:
pred_modSSb18_log <- predict(modSSb18_log, newdata = anymortSS2, type = "response")
auc(roc(anymortSS2$Binary_effect_mortality, pred_modSSb18_log)) #AUC: 0.9086
#can also check out 'performance' package https://cran.r-project.org/web/packages/performance/performance.pdf
r.squaredGLMM(modSSb18_log) #The fixed effect of sediment level explains ~17% of variation of the total variation. If the random intercepts for studies are also included, then 78% of variation is explained.

##Exploration of random effect(s)
plot(allEffects(modSSb18_log))
dotplot(ranef(modSSb18_log, condVar = T)) #residual variation at the level of studies/species -- variation is large!
qqnorm(ranef(modSSb18_log)$Ref[,1])
qqline(ranef(modSSb18_log)$Ref[,1]) #distribution of random effects looks good
VarCorr(modSSb18_log) #SD=4.8,5.3
exp(sqrt(VarCorr(modSSb18_log)$Ref[1])) #I think this means that two observations from different studies typically differ by a factor of exp(sd) = x (?)
modSSb18_log_noSed <- glmer(Binary_effect_mortality ~ 1 + (1 | Gsp), 
                      family = binomial, data = anymortSS2)
random.intercepts <- ranef(modSSb18_log)$Ref[["(Intercept)"]]
Ref.intercepts <- fixef(modSSb18_log)[1] + random.intercepts 
#plot with probability of binary response on y-axis, each line representing a study:
for (i in 1:length(random.intercepts)) {
  if (i == 1) curve(exp(Ref.intercepts[i] + fixef(modSSb18_log)["Sed_level_stand_mg"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSSb18_log)["Sed_level_stand_mg"]*x)), 
                    from = min(anymortSS2$Sed_level_stand_mg), to = max(anymortSS2$Sed_level_stand_mg), 
                    ylim = c(0, 1), 
                    ylab = "Probability of adverse effect", 
                    xlab = "log10(exposure concentration, mg/cm2/d)")
  if (i > 1) curve(exp(Ref.intercepts[i] + fixef(modSSb18_log)["Sed_level_stand_mg"]*x)/(1 + exp(Ref.intercepts[i] + fixef(modSSb18_log)["Sed_level_stand_mg"]*x)), add = T) 
}

#https://stats.stackexchange.com/questions/8318/interpretation-of-log-transformed-predictors-in-logistic-regression
#Generally, each k-fold increase in x is associated with a change in the odds by a multiplicative factor of k^(Beta). For instance, k=2 for a doubling of x and k=0.5 for a halving of x is associated with a change in the odds of success by a factor of k^(Beta).
#If predictor is log-transformed:
#"Case 1: k=e, i.e. natural log transformed independent variable. Then if Beta is close to zero we can say "a 1% increase in x leads to a Beta percent increase in the odds of the outcome.""
#"Case 2: base k transformed independent variable: Then the exponentiated coefficient, exp(Beta), can be interpreted as the proportionate increase in the odds from a k-fold increase in the independent variable." -- For k=10, exp(Beta) is the multiplicative change in the odds of success with a 10-fold increase in X1 (with X2 fixed, if relevant).

#Not significant
#se <- sqrt(diag(vcov(modSSb18_log)))
#tab <- cbind(Est = fixef(modSSb18_log), 
#             LL = fixef(modSSb18_log) - 1.96 * se, 
#             UL = fixef(modSSb18_log) + 1.96 * se)
#10^(tab)
```
  
There is no significant relationship between exposure concentration of suspended sediment and the odds of any tissue mortality (GLMM z = 1.110, p = 0.267), nor between exposure duration and the odds of any tissue mortality (GLMM z = 0.880, p = 0.379) after accounting for variability among articles and species.   
  
#### Prediction figures  
```{r}
#Overlaying glmm results on figure, but prediction line is jagged...
pred_modSSb18_log <- predict(modSSb18_log, newdata=anymortSS2, type="response")
anymortSS3 <- cbind(anymortSS2, pred_modSSb18_log)

anymortSS_plot <- ggplot(data = anymortSS3) +
    geom_point(mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_mortality,
      color = Ref)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Bleaching due to sediment exposure",
         color = "Study") +
    scale_x_log10(limits=c(0.1,max(anymortSS3$Sed_level_stand_mg)),breaks=c(0.01,0.1,1,10,100,1000),
                  label=c("0.01","0.1","1","10","100","1000")) +
    geom_line(aes(x = Sed_level_stand_mg, y = pred_modSSb18_log), inherit.aes=FALSE) +
    theme_bw()

anymortSS_plot
```

That plot is a bit...confusing to interpret. Let's see if I can plot the average marginal probability, i.e., the average change in probability of the outcome across the range of the predictor of interest. This is described in some detail at the following, useful website: https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/
  
##### By sediment exposure concentration
```{r}
jvalues <- with(anymortSS2, seq(from = min(log10_conc), to = max(log10_conc), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    anymortSS2$log10_conc <- j
    predict(modSSb18_log, newdata = anymortSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat4_2 <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in log10_conc values and convert to data frame
plotdat4_2 <- as.data.frame(cbind(plotdat4_2, jvalues))
plotdat4_2 <- plotdat4_2 %>% mutate(Sed_level_linear=10^jvalues)

# better names and show the first few rows
colnames(plotdat4_2) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "log10_mg_L", "mg_L")
#head(plotdat4_2)
sed <- c(1,5,10,50,100,500,1000)
sed2 <- lapply(sed, function(x) approx(plotdat4_2$mg_L, plotdat4_2$PredictedProbability, xout=x))
print(round(unlist(sed2), digits=3))

# plot average marginal predicted probabilities
ggplot(plotdat4_2, aes(x = log10_mg_L)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat4_2, aes(x = log10_mg_L)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))
ggplot(plotdat4_2, aes(x = mg_L, y = PredictedProbability)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1)) +
  scale_x_log10()

#Overlaying average marginal predicted probabilities on figure
#by Ref
anymortSS_plot2 <- ggplot() +
    geom_point(data = anymortSS2, mapping = aes(
      x = Sed_level_stand_mg, 
      y = Binary_effect_mortality)) +
    labs(x = "Sediment exposure concentration (mg/L)", 
         y = "Predicted probability of any tissue\nmortality to sediment exposure",
         linetype = "Predicted\nProbability") +
    scale_x_log10(limits=c(0.1,max(anymortSS2$Sed_level_stand_mg)), 
                  breaks=c(0.01,0.1,1,10,100,1000,loaelSS2),
                  label=c("0.01","0.1","1","10","100","1000",round(loaelSS2,digits=1))) +
    geom_ribbon(data = plotdat4_2, aes(x = mg_L, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat4_2, aes(x = mg_L, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat4_2, aes(x = mg_L, y = MedianProbability, 
                                  linetype = "solid")) +
    geom_vline(xintercept=loaelSS2, linetype="dashed", color = "red") +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

anymortSS_plot2
```
  
##### By sediment exposure duration
```{r}
jvalues <- with(anymortSS2, seq(from = min(Sed_exposure_days), to = max(Sed_exposure_days), length.out = 100))

# calculate predicted probabilities and store in a list
pp <- lapply(jvalues, function(j) {
    anymortSS2$Sed_exposure_days <- j
    predict(modSSb18_log, newdata = anymortSS2, type = "response")
})

# average marginal predicted probability across a few different sediment levels
#sapply(pp[c(1, 20, 40, 60, 80, 100)], mean)
## [1] 0.1797186 0.1960244 0.2142042 0.2333993 0.2535694 0.2746604
# get the means with lower and upper quartiles
plotdat4_2b <- t(sapply(pp, function(x) {
    c(M = mean(x), med = median(x), quantile(x, c(0.25, 0.75)))
}))

# add in Sed_exposure_days values and convert to data frame
plotdat4_2b <- as.data.frame(cbind(plotdat4_2b, jvalues))

# better names and show the first few rows
colnames(plotdat4_2b) <- c("PredictedProbability", "MedianProbability", 
                       "LowerQuantile", "UpperQuantile", "Sed_dur")
#head(plotdat4_2b)

# plot average marginal predicted probabilities
ggplot(plotdat4_2b, aes(x = Sed_dur)) + 
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) +
  ylim(c(0, 1))
ggplot(plotdat4_2b, aes(x = Sed_dur)) + 
  geom_ribbon(aes(ymin = LowerQuantile, ymax = UpperQuantile), alpha = 0.15) +
  geom_line(aes(y = PredictedProbability), size = 2) +
  geom_line(aes(y = MedianProbability), size = 0.5) + 
  ylim(c(0, 1))

#Overlaying average marginal predicted probabilities on figure
#by Ref
anymortSS_plot3 <- ggplot() +
    geom_point(data = anymortSS2, mapping = aes(
      x = Sed_exposure_days, 
      y = Binary_effect_mortality,
      color = Ref)) +
    labs(x = "Sediment exposure duration (days)", 
         y = "Predicted probability of any tissue\nmortality to sediment exposure",
         color = "Binary Data\nby Study",
         linetype = "Predicted\nProbability") +
    scale_x_continuous(limits=c(0,max(anymortSS2$Sed_exposure_days))) +
    geom_ribbon(data = plotdat4_2b, aes(x = Sed_dur, y = PredictedProbability, 
                                    ymin = LowerQuantile, ymax = UpperQuantile), 
                alpha = 0.15) +
    geom_line(data = plotdat4_2b, aes(x = Sed_dur, y = PredictedProbability, 
                                  linetype = "twodash")) +
    geom_line(data = plotdat4_2b, aes(x = Sed_dur, y = MedianProbability, 
                                  linetype = "solid")) +
    theme_bw() +
    scale_linetype_manual(values=c("twodash", "solid"), labels = c("Median","Mean"))

anymortSS_plot3
```
