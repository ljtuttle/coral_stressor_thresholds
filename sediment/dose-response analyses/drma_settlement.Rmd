---
title: "Effects of sediment on the settlement rate of larval corals"
author: "Lillian J. Tuttle"
date: "9/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mixmeta)
library(dosresmeta)
library(splines)

effectsize <- read.csv("data/effectsize_ALL.csv", header=T)
```
  
```{r, echo=FALSE, warning=FALSE}
#Looking at data
#head(effectsize) 

#a lot of variables (columns) are factors instead of numeric/doubles/integers
effectsize <- effectsize %>% #converting appropriate columns to numeric...
  mutate_at(vars(ES, Hedges_d, Var_d, SE_d, CI_lo_d, CI_up_d, Sed_level_standardized, Sed_exposure, Sed_exposure_mg_d_L), as.character) %>% 
  mutate_at(vars(ES, Hedges_d, Var_d, SE_d, CI_lo_d, CI_up_d, Sed_level_standardized, Sed_exposure, Sed_exposure_mg_d_L), as.numeric)
#head(effectsize) #"double"-check!

#Now create a new variable that has both Genus and species, remove sediment burial experiments, and remove irrelevant rows (non-controls, -treatments, or -baselines)
effectsize <- effectsize %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(Binary_sed_burial=="0") %>%
  filter(!Control=="-1")
#head(effectsize)

#Separate into deposited sediment (DS) and suspended sediment (SS) datasets, WITH CONTROLS
ES_DS <- effectsize %>% filter(DS_SS=="DS")
ES_SS <- effectsize %>% filter(DS_SS=="SS")

#Second dataset that that removes controls (Control == c("1","2"))
effectsize2 <- effectsize %>% filter(Control=="0")
#effectsize2 #"double"-check!

#Separate into deposited sediment (DS) and suspended sediment (SS) datasets, WITHOUT CONTROLS
ES_DS2 <- effectsize2 %>% filter(DS_SS=="DS")
ES_SS2 <- effectsize2 %>% filter(DS_SS=="SS")

#Now separate into independent datasets for each coral response for DEPOSITED SEDIMENT
ES_DS_settlement <- ES_DS %>% 
  filter(Response == "settlement") %>%
  filter(Surface_direction == "top")
#ES_DS_settlement %>% tally()
#ES_DS_settlement %>% count(Ref)
#ES_DS_settlement %>% count(Ref_name)
#ES_DS_settlement %>% count(Gsp)
#ES_DS_settlement %>% count(Updated_Genus)

#Now separate into independent datasets for each coral response for SUSPENDED SEDIMENT
ES_SS_settlement <- ES_SS %>% filter(Response == "settlement")
#ES_SS_settlement %>% tally()
#ES_SS_settlement %>% count(Ref)
#ES_SS_settlement %>% count(Ref_name)
#ES_SS_settlement %>% count(Gsp)
#ES_SS_settlement %>% count(Updated_Genus)
``` 
  
These datasets contain information from multiple articles (**Ref_name**) and studies/experiments (**Ref**) within those articles about the effects of DEPOSITED & SUSPENDED sediment on the **settlement rate** of larval corals, quantified as the percent of coral larvae (of those released) that successfully attach to experimental surfaces by the end of a given experiment. I would like to explore the dose-response relationship between sediment 'dose' and the effect size, estimated here as the standardized mean difference between treatment and control, in terms of Hedges' *d*:

- Hedges' *d* is the standardized mean difference between the treatment and control groups (Hedges and Olkin 1985). Each study may have multiple Hedges' *d* calculations, one for each treatment-control comparison at each time-point.   

- 'Dose' can be quantified as sediment exposure concentration (mg/cm^2^/day for deposited sediment and mg/L for suspended sediment), exposure duration (days), or as "cumulative exposure", for which I multiply concentration and duration (mg/cm^2^ for deposited sediment and mg x day/L for suspended sediment).

Each study/experiment (Ref) may contain multiple sets of controls and treatments (due to using multiple species or sediment types, for instance). Thus, I have added two categorical vectors, '**Comparison**' and 'Control', which group each set of control-treatment comparisons into a unique two-letter code, within which is one control (Control=="1") and at least one treatment (Control=="0"). **Therefore, 'Comparison' is nested within 'Ref', which is further nested within 'Ref_name'.**

```{r, echo=FALSE}
#Using dosresmeta to calculate Hedges' d and variance of d
covar_DS_settlement <- by(ES_DS_settlement, ES_DS_settlement$Comparison, function(x) 
  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))
ES_DS_settlement$smd <- unlist(lapply(covar_DS_settlement, function(x) x$y))
ES_DS_settlement$vmd <- unlist(lapply(covar_DS_settlement, function(x) x$v))

covar_SS_settlement <- by(ES_SS_settlement, ES_SS_settlement$Comparison, function(x) 
  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))
ES_SS_settlement$smd <- unlist(lapply(covar_SS_settlement, function(x) x$y))
ES_SS_settlement$vmd <- unlist(lapply(covar_SS_settlement, function(x) x$v))

#Looking at data to make sure smd and vmd added as columns
#ES_DS_settlement
#ES_SS_settlement

#Removing controls for modeling
ES_DS_settlement2 <- subset(ES_DS_settlement, Control=="0")
ES_SS_settlement2 <- subset(ES_SS_settlement, Control=="0")

#Looking at data to make sure controls were removed
#ES_DS_settlement2
#ES_SS_settlement2
#ES_DS_settlement2 %>% tally()
#ES_SS_settlement2 %>% tally()
``` 
  
# I. Settlement rate

## A. Deposited Sediment  
  
### 1. Plots  
I calculated the standardized mean difference in terms of Hedges' *d* and plot it here with respect to exposure concentration. I did this first for a Hedges' *d* that I calculated before importing the data to R and again for a Hedges' *d* that is calculated by the dosresmeta::covar.smd function.

```{r, echo=FALSE, warning=FALSE}
#EXPOSURE CONCENTRATION vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_settlement2, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Settlement rate on vertically facing surfaces") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,2000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000")) 
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_DS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate on vertically facing surfaces") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,2000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000"))


#by SEDIMENT TYPE
ggplot(ES_DS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_category,
           shape = Sed_source,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate on vertically facing surfaces") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment relative\ngrain size",
       shape = "Sediment source") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,2000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000"))
ggplot(ES_DS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_class,
           shape = Sed_mineralogy,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate on vertically facing surfaces") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment\ngrain class",
       shape = "Sediment mineralogy") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,2000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000"))

#by PHYLOGENY
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Gsp,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate on vertically facing surfaces") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Species") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,2000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000"))

#by OCEAN and REGION
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Region,
           shape = Ocean,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate on vertically facing surfaces") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Region",
       shape = "Ocean") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,2000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000"))
```
  
It is interesting that there is a difference between how I calculated Hedges' *d* and how *dosresmeta* appears to calculate it. But in both cases, there may be a negative relationship between sediment exposure and effect size. There does not appear to be strong effects of phylogeny (genus) or geography (ocean and region). There may be effects of sediment type (source, origin, grain size), but I need to input these data to evaluate!
  
### 2. Model Fitting  
The following set of functions model fixed and random (nested) effects WITHOUT accounting for within-comparison (or within-study) correlations. The output for each is a univariate, random-effects meta-regression.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models have exposure concentration as its predictor. 
#All models with 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_settle_1d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Comparison,
                      data = ES_DS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_settle_2d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Ref/Comparison,
                      data = ES_DS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_settle_3d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Ref_name/Comparison,
                      data = ES_DS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_settle_4d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                       random =  ~ Sed_level_standardized | Ref_name/Ref/Comparison,
                       data = ES_DS_settlement2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_DS_settlement <- by(ES_DS_settlement, ES_DS_settlement$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))


# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_SETT <- list(NA)
for (i in seq(1,length(covar_DS_settlement))) {
newlist_SETT[i] <- list(covar_DS_settlement[[i]]$S)
}
mod_DS_settle_5d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Comparison,
                       data=ES_DS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_SETT))


# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_SETT2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_SETT <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_SETT2 <-list(NA)
reflista <- ES_DS_settlement %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_DS_settlement that are all from the same reference [i]
  templist_SETT[i] <-list(covar_DS_settlement[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_SETT[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_SETT2
     templist_SETT2[j] <- list(templist_SETT[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_SETT2[i] <- list(bdiagMat(templist_SETT2))
  templist_SETT2 <- list(NA)
}
mod_DS_settle_6d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Ref/Comparison,
                       data=ES_DS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_SETT2))


# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref_name/Comparison
newlist_SETT3 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial Ref_name/Comparison
templist_SETT3 <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_SETT4 <-list(NA)
reflista <- ES_DS_settlement %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,2]
for (i in seq(1,length(unique(reflista$Ref_name))))  {
  #pull the elements from covar_DS_settlement that are all from the same reference [i]
  templist_SETT3[i] <-list(covar_DS_settlement[reflist==unique(reflista$Ref_name)[i]])
  for (j in seq(1,length(templist_SETT3[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_SETT4
     templist_SETT4[j] <- list(templist_SETT3[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_SETT3[i] <- list(bdiagMat(templist_SETT4))
  templist_SETT4 <- list(NA)
}
#### Only one Ref_name had multiple Ref, so these models not working properly:
#### Error in getSlist(S, nay, groups, m, k, control$addSlist, control$checkPD) : wrong dimensions in 'addSlist'. See help(mixmetaControl)
#mod_DS_settle_7d <- mixmeta(smd ~ Sed_level_standardized,
#                       random = ~ Sed_level_standardized | Ref_name/Comparison,
#                       data=ES_DS_settlement2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_SETT3))
```
  
And now to compare relative fit of linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(mod_DS_settle_1d, mod_DS_settle_2d, mod_DS_settle_3d, mod_DS_settle_4d, mod_DS_settle_5d, mod_DS_settle_6d) 
#of these, model 5d has lowest AIC
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots and Normal Q-Q Plots
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))

resid_d <- resid(mod_DS_settle_5d)
fitted_d <- fitted(mod_DS_settle_5d)
plot(fitted_d, resid_d, main = "D: smd ~ mg_cm2_d, control = addSlist,
     random =  ~ mg_cm2_d | Comparison")
abline(0,0)

qqnorm(resid_d)
qqline(resid_d)

par(op)
```
  
Patterns:
1.  Residuals for all best-fit models are very similar -- YIKES! may need some transformations.
2.  There could be non-linearities that need to be accounted for.
3.  Very strong series of outliers in positive residual land!
4.  First let's try a log transformation of sediment exposure before adding non-linear models.
  
Now let's check out a log, base 10 transformation of sediment exposure to see if it improves the residuals of the models.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models have exposure concentration as its predictor. 
#All models with 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

log10_mg_cm2_d <- log10(ES_DS_settlement2$Sed_level_standardized)

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_settle_1d <- mixmeta(smd ~ log10_mg_cm2_d, S = vmd,
                      random =  ~ log10_mg_cm2_d | Comparison,
                      data = ES_DS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_settle_2d <- mixmeta(smd ~ log10_mg_cm2_d, S = vmd,
                      random =  ~ log10_mg_cm2_d | Ref/Comparison,
                      data = ES_DS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_settle_3d <- mixmeta(smd ~ log10_mg_cm2_d, S = vmd,
                      random =  ~ log10_mg_cm2_d | Ref_name/Comparison,
                      data = ES_DS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_settle_4d <- mixmeta(smd ~ log10_mg_cm2_d, S = vmd,
                       random =  ~ log10_mg_cm2_d | Ref_name/Ref/Comparison,
                       data = ES_DS_settlement2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_DS_settlement <- by(ES_DS_settlement, ES_DS_settlement$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))


# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_log_SETT <- list(NA)
for (i in seq(1,length(covar_DS_settlement))) {
newlist_log_SETT[i] <- list(covar_DS_settlement[[i]]$S)
}
log_mod_DS_settle_5d <- mixmeta(smd ~ log10_mg_cm2_d,
                       random = ~ log10_mg_cm2_d | Comparison,
                       data=ES_DS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_SETT))


# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_log_SETT2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_log_SETT <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_log_SETT2 <-list(NA)
reflista <- ES_DS_settlement %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_DS_settlement that are all from the same reference [i]
  templist_log_SETT[i] <-list(covar_DS_settlement[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_log_SETT[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_log_SETT2
     templist_log_SETT2[j] <- list(templist_log_SETT[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_log_SETT2[i] <- list(bdiagMat(templist_log_SETT2))
  templist_log_SETT2 <- list(NA)
}
log_mod_DS_settle_6d <- mixmeta(smd ~ log10_mg_cm2_d,
                       random = ~ log10_mg_cm2_d | Ref/Comparison,
                       data=ES_DS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_SETT2))
```
  
And now to compare relative fit of linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(log_mod_DS_settle_1d, log_mod_DS_settle_2d, log_mod_DS_settle_3d, log_mod_DS_settle_4d, log_mod_DS_settle_5d, log_mod_DS_settle_6d) 
#of these, model 2d has lowest AIC
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots and Normal Q-Q Plots
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))

resid_logd <- resid(log_mod_DS_settle_2d)
fitted_logd <- fitted(log_mod_DS_settle_2d)
plot(fitted_logd, resid_logd, main = "D: smd ~ log_mg_cm2_d, S = vmd,
     random =  ~ log_mg_cm2_d | Ref/Comparison")
abline(0,0)

qqnorm(resid_logd)
qqline(resid_logd)

par(op)
```
  
Patterns:
1.  Residuals for best-fit model are very similar -- transformations seem to have helped spread along fitted values axis and reduced magnitude of residuals.
2.  No apparent need to look for non-linearities in data.
  
  
### 4. Best-Fit Model Summary
  
#### MG/CM^2^/DAY IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_DS_settle_2d)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_DS_settle_2d, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_DS_settle_2d <- predict(log_mod_DS_settle_2d, newdata=ES_DS_settlement2, ci=TRUE)
ES_DS_settlement2_CI4 <- cbind(ES_DS_settlement2, pred_log_mod_DS_settle_2d)
#head(ES_DS_settlement2_CI4)
min_conc_d <- ES_DS_settlement2_CI4 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  filter(Sed_level_standardized>0.5) %>% #added this because some "FALSE" statements are significantly ABOVE zero
  summarize(min_conc_d=min(Sed_level_standardized))
min_conc_d2 <- as.numeric(min_conc_d)

ggplot(ES_DS_settlement2_CI4, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_d2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = smd,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(0.01,1200), breaks=c(0.01,0.1,1,10,100,1000,min_conc_d2), 
                label=c("0.01","0.1","1","10","100","1000",round(min_conc_d2,digits=1))) 
```
  
For every 10-fold increase in exposure concentration of deposited sediment, the Hedges' d effect size for settlement rate of coral larvae declined by 2.5 (95% CI -3.6, -1.4; DRMA z = -4.494, p < 0.0001), after accounting for variability by comparison (Fig. X, Table X). However, the best-fit model’s I2 statistic was 84.6%, indicating considerable residual heterogeneity unaccounted for by the model (Table X), which could be the result of taxonomic, geographic, and/or mineralogical differences among (and within) studies.
  
  
## B. Suspended Sediment  
  
### 1. Plots  
I calculated the standardized mean difference in terms of Hedges' *d* and plot it here with respect to exposure concentration. I did this first for a Hedges' *d* that I calculated before importing the data to R and again for a Hedges' *d* that is calculated by the dosresmeta::covar.smd function.

```{r, echo=FALSE, warning=FALSE}
#EXPOSURE CONCENTRATION vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_settlement2, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Settlement rate") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,1000), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000")) 
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_SS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,1000), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000")) 


#by SEDIMENT TYPE
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_category,
           shape = Sed_source,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment relative\ngrain size",
       shape = "Sediment source") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,1000), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000")) 
ggplot(ES_SS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_class,
           shape = Sed_mineralogy,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment\ngrain class",
       shape = "Sediment mineralogy") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,1000), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000")) 

#by PHYLOGENY
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Gsp,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Species") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,1000), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000")) 

#by OCEAN and REGION
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_settlement2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Region,
           shape = Ocean,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Settlement rate") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Region",
       shape = "Ocean") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,1000), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000")) 
```
  
It is interesting that there is a difference between how I calculated Hedges' *d* and how *dosresmeta* appears to calculate it. But in both cases, there is not strong evidence for a relationship between sediment exposure and effect size. There is not strong evidence of an effect by phylogeny (genus), geography (ocean and region), or sediment type (source, origin, grain size).
  
### 2. Model Fitting   
The following set of functions model fixed and random (nested) effects WITHOUT accounting for within-comparison (or within-study) correlations. The output for each is a univariate, random-effects meta-regression.

```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models have exposure concentration as its predictor. 
#All models with 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_SS_settle_1d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Comparison,
                      data = ES_SS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in chol.default(XtVX) : the leading minor of order 4/4 is not positive definite
#mod_SS_settle_2d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
#                      random =  ~ Sed_level_standardized | Ref/Comparison,
#                      data = ES_SS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_SS_settle_3d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Ref_name/Comparison,
                      data = ES_SS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in chol.default(XtVX) : the leading minor of order 7/7 is not positive definite
#mod_SS_settle_4d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
#                       random =  ~ Sed_level_standardized | Ref_name/Ref/Comparison,
#                       data = ES_SS_settlement2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_SS_settlement <- by(ES_SS_settlement, ES_SS_settlement$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))


# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_SETT_SS <- list(NA)
for (i in seq(1,length(covar_SS_settlement))) {
newlist_SETT_SS[i] <- list(covar_SS_settlement[[i]]$S)
}
mod_SS_settle_5d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Comparison,
                       data=ES_SS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_SETT_SS))


# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_SETT_SS2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_SETT_SS <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_SETT_SS2 <-list(NA)
reflista <- ES_SS_settlement %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_SS_settlement that are all from the same reference [i]
  templist_SETT_SS[i] <-list(covar_SS_settlement[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_SETT_SS[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_SETT_SS2
     templist_SETT_SS2[j] <- list(templist_SETT_SS[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_SETT_SS2[i] <- list(bdiagMat(templist_SETT_SS2))
  templist_SETT_SS2 <- list(NA)
}
#Error in chol.default(XtVX) : the leading minor of order 5/5 is not positive definite
#mod_SS_settle_6d <- mixmeta(smd ~ Sed_level_standardized,
#                       random = ~ Sed_level_standardized | Ref/Comparison,
#                       data=ES_SS_settlement2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_SETT_SS2))


# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref_name/Comparison
newlist_SETT_SS3 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial Ref_name/Comparison
templist_SETT_SS3 <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_SETT_SS4 <-list(NA)
reflista <- ES_SS_settlement %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,2]
for (i in seq(1,length(unique(reflista$Ref_name))))  {
  #pull the elements from covar_SS_settlement that are all from the same reference [i]
  templist_SETT_SS3[i] <-list(covar_SS_settlement[reflist==unique(reflista$Ref_name)[i]])
  for (j in seq(1,length(templist_SETT_SS3[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_SETT_SS4
     templist_SETT_SS4[j] <- list(templist_SETT_SS3[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_SETT_SS3[i] <- list(bdiagMat(templist_SETT_SS4))
  templist_SETT_SS4 <- list(NA)
}
mod_SS_settle_7d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Ref_name/Comparison,
                       data=ES_SS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_SETT_SS3))
```
  
And now to compare relative fit of linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(mod_SS_settle_1d, mod_SS_settle_3d, mod_SS_settle_5d, mod_SS_settle_7d) 
#of these, model 1d has lowest AIC
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots and Normal Q-Q Plots
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))

resid_SSd <- resid(mod_SS_settle_1d)
fitted_SSd <- fitted(mod_SS_settle_1d)
plot(fitted_SSd, resid_SSd, main = "D: smd ~ mg/L, S = vmd,
     random =  ~ mg/L | Comparison")
abline(0,0)

qqnorm(resid_SSd)
qqline(resid_SSd)

par(op)
```
  
Patterns:
1.  Residuals are very similar -- YIKES! may need some transformations.
2.  There could be non-linearities that need to be accounted for.
3.  First let's try a log transformation of sediment exposure before adding non-linear models.
  
Now let's check out a log, base 10 transformation of sediment exposure to see if it improves the residuals of the models.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models have exposure concentration as its predictor. 
#All models with 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

log10_mg_L <- log10(ES_SS_settlement2$Sed_level_standardized)

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_SS_settle_1d <- mixmeta(smd ~ log10_mg_L, S = vmd,
                      random =  ~ log10_mg_L | Comparison,
                      data = ES_SS_settlement2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_SS_settle_3d <- mixmeta(smd ~ log10_mg_L, S = vmd,
                      random =  ~ log10_mg_L | Ref_name/Comparison,
                      data = ES_SS_settlement2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_SS_settlement <- by(ES_SS_settlement, ES_SS_settlement$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))


# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_log_SETT_SS <- list(NA)
for (i in seq(1,length(covar_SS_settlement))) {
newlist_log_SETT_SS[i] <- list(covar_SS_settlement[[i]]$S)
}
log_mod_SS_settle_5d <- mixmeta(smd ~ log10_mg_L,
                       random = ~ log10_mg_L | Comparison,
                       data=ES_SS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_SETT_SS))


# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref_name/Comparison
newlist_log_SETT_SS3 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial Ref_name/Comparison
templist_log_SETT_SS3 <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_log_SETT_SS4 <-list(NA)
reflista <- ES_SS_settlement %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,2]
for (i in seq(1,length(unique(reflista$Ref_name))))  {
  #pull the elements from covar_SS_settlement that are all from the same reference [i]
  templist_log_SETT_SS3[i] <-list(covar_SS_settlement[reflist==unique(reflista$Ref_name)[i]])
  for (j in seq(1,length(templist_log_SETT_SS3[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_log_SETT_SS4
     templist_log_SETT_SS4[j] <- list(templist_log_SETT_SS3[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_log_SETT_SS3[i] <- list(bdiagMat(templist_log_SETT_SS4))
  templist_log_SETT_SS4 <- list(NA)
}
log_mod_SS_settle_7d <- mixmeta(smd ~ log10_mg_L,
                       random = ~ log10_mg_L | Ref_name/Comparison,
                       data=ES_SS_settlement2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_SETT_SS3))
```
  
### 3. Model Comparison and Summary
And now to compare relative fit of log-linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(log_mod_SS_settle_1d, log_mod_SS_settle_3d, log_mod_SS_settle_5d, log_mod_SS_settle_7d) 
#of these, model 5d has lowest AIC
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots and Normal Q-Q Plots
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))

resid_SSlogd <- resid(log_mod_SS_settle_5d)
fitted_SSlogd <- fitted(log_mod_SS_settle_5d)
plot(fitted_SSlogd, resid_SSlogd, main = "D: smd ~ log_mg_L, control=addSlist,
     random =  ~ log_mg_L | Comparison")
abline(0,0)

qqnorm(resid_SSlogd)
qqline(resid_SSlogd)

par(op)
```
   
Patterns:
1.  All residuals look remarkably better -- more even spread and magnitude of residuals diminished.
2.  No need to check non-linear models.
   
### 4. Best-Fit Model Summary
  
#### MG/L IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_SS_settle_5d)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_SS_settle_5d, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_SS_settle_5d <- predict(log_mod_SS_settle_5d, newdata=ES_SS_settlement2, ci=TRUE)
ES_SS_settlement2_CI4 <- cbind(ES_SS_settlement2, pred_log_mod_SS_settle_5d)
#head(ES_SS_settlement2_CI4)
min_conc_d_SS <- ES_SS_settlement2_CI4 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_conc_d_SS=min(Sed_level_standardized))
min_conc_d_SS2 <- as.numeric(min_conc_d_SS)

ggplot(ES_SS_settlement2_CI4, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_d_SS2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = smd,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(1,1000), breaks=c(1,10,100,1000,min_conc_d_SS2), 
                label=c("1","10","100","1000",round(min_conc_d_SS2,digits=1))) 
```
  
There is no significant relationship between exposure concentration to suspended sediment and the Hedges' d effect size for settlement rate of coral larvae (DRMA z = -0.719, p = 0.472).
  