---
title: "Effects of sediment on the photosynthesis of adult corals"
author: "Lillian J. Tuttle"
date: "7/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mixmeta)
library(dosresmeta)
library(splines)

#will want to getwd() and setwd(), as appropriate
effectsize <- read.csv("/Volumes/GoogleDrive/My Drive/iScience/Code/thresholds/sedimentation/effectsize2.csv", header=T)

#keyboard shortcuts to remember: 
#command-option-I inserts new code chunk
#command-shift-M inserts pipeline symbols
#command-enter runs line of code where cursor is (or highlighted portion)
```
  
```{r, echo=FALSE, warning=FALSE}
#Looking at data
#head(effectsize) 

#a lot of variables (columns) are factors instead of numeric/doubles/integers
effectsize <- effectsize %>% #converting appropriate columns to numeric...
  mutate_at(vars(ES, Hedges_d, Var_d, SE_d, CI_lo_d, CI_up_d, Sed_level_standardized, Sed_exposure, Sed_exposure_mg_d_L), as.character) %>% 
  mutate_at(vars(ES, Hedges_d, Var_d, SE_d, CI_lo_d, CI_up_d, Sed_level_standardized, Sed_exposure, Sed_exposure_mg_d_L), as.numeric)
#head(effectsize) #"double"-check!

#Now create a new variable that has both Genus and species, remove sediment burial experiments, and remove irrelevant rows (non-controls, -treatments, or -baselines)
effectsize <- effectsize %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>% 
  filter(Binary_sed_burial=="0") %>%
  filter(!Control=="-1")
#head(effectsize)

#Separate into deposited sediment (DS) and suspended sediment (SS) datasets, WITH CONTROLS
ES_DS <- effectsize %>% filter(DS_SS=="DS")
ES_SS <- effectsize %>% filter(DS_SS=="SS")

#Second dataset that that removes controls (Control == c("1","2"))
effectsize2 <- effectsize %>% filter(Control=="0")
#effectsize2 #"double"-check!

#Separate into deposited sediment (DS) and suspended sediment (SS) datasets, WITHOUT CONTROLS
ES_DS2 <- effectsize2 %>% filter(DS_SS=="DS")
ES_SS2 <- effectsize2 %>% filter(DS_SS=="SS")

#Now separate into independent datasets for each coral response for DEPOSITED SEDIMENT
ES_DS_deltaf_fm <- ES_DS %>% filter(Response == "deltaf_fm")
ES_DS_fv_fm <- ES_DS %>% filter(Response == "fv_fm")
ES_DS_p_r <- ES_DS %>% filter(Response == "p_r_ratio")
#ES_DS_deltaf_fm %>% count(Ref, sort=T) #n=1 study -- not suitable for meta-analysis ****
#ES_DS_fv_fm %>% count(Ref, sort=T) #n=8 studies from 6 papers
#ES_DS_p_r %>% count(Ref, sort=T) #n=3 studies from 3 papers -- suitable for meta-analysis with so few studies?
ES_DS_fv_fm %>% tally()
ES_DS_fv_fm %>% count(Ref)
ES_DS_fv_fm %>% count(Ref_name)
ES_DS_fv_fm %>% count(Gsp)
ES_DS_fv_fm %>% count(Updated_Genus)
ES_DS_p_r %>% tally()
ES_DS_p_r %>% count(Ref)
ES_DS_p_r %>% count(Ref_name)
ES_DS_p_r %>% count(Gsp)
ES_DS_p_r %>% count(Updated_Genus)

#Now separate into independent datasets for each coral response for SUSPENDED SEDIMENT
ES_SS_fv_fm <- ES_SS %>% filter(Response == "fv_fm")
ES_SS_p_r <- ES_SS %>% filter(Response == "p_r_ratio")
#ES_SS_fv_fm %>% count(Ref, sort=T) #n=5 studies from 4 papers
#ES_SS_p_r %>% count(Ref, sort=T) #n=1 study -- not suitable for meta-analysis ****
ES_SS_fv_fm %>% tally()
ES_SS_fv_fm %>% count(Ref)
ES_SS_fv_fm %>% count(Ref_name)
ES_SS_fv_fm %>% count(Gsp)
ES_SS_fv_fm %>% count(Updated_Genus)
``` 
  
These datasets contain information from multiple articles (**Ref_name**) and studies/experiments (**Ref**) within those articles about the effects of DEPOSITED & SUSPENDED sediment on the **photosynthetic yield (Fv/Fm or deltaF/Fm) or the photosynthesis-respiration (P/R) ratio** of symbiotic algae living within coral cells. I would like to explore the dose-response relationship between sediment 'dose' and the effect size, estimated here as the standardized mean difference between treatment and control, in terms of Hedges' *d*:

- Hedges' *d* is the standardized mean difference between the treatment and control groups (Hedges and Olkin 1985). Each study may have multiple Hedges' *d* calculations, one for each treatment-control comparison at each time-point.   

- 'Dose' can be quantified as sediment exposure concentration (mg/cm^2^/day for deposited sediment and mg/L for suspended sediment), exposure duration (days), or as "cumulative exposure", for which I multiply concentration and duration (mg/cm^2^ for deposited sediment and mg x day/L for suspended sediment).

Each study/experiment (Ref) may contain multiple sets of controls and treatments (due to using multiple species or sediment types, for instance). Thus, I have added two categorical vectors, '**Comparison**' and 'Control', which group each set of control-treatment comparisons into a unique two-letter code, within which is one control (Control=="1") and at least one treatment (Control=="0"). **Therefore, 'Comparison' is nested within 'Ref', which is further nested within 'Ref_name'.**

```{r, echo=FALSE}
#Using dosresmeta to calculate Hedges' d and variance of d
covar_DS_photo <- by(ES_DS_fv_fm, ES_DS_fv_fm$Comparison, function(x) 
  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))
ES_DS_fv_fm$smd <- unlist(lapply(covar_DS_photo, function(x) x$y))
ES_DS_fv_fm$vmd <- unlist(lapply(covar_DS_photo, function(x) x$v))

covar_DS_p_r <- by(ES_DS_p_r, ES_DS_p_r$Comparison, function(x) 
  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))
ES_DS_p_r$smd <- unlist(lapply(covar_DS_p_r, function(x) x$y))
ES_DS_p_r$vmd <- unlist(lapply(covar_DS_p_r, function(x) x$v))

covar_SS_photo <- by(ES_SS_fv_fm, ES_SS_fv_fm$Comparison, function(x) 
  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))
ES_SS_fv_fm$smd <- unlist(lapply(covar_SS_photo, function(x) x$y))
ES_SS_fv_fm$vmd <- unlist(lapply(covar_SS_photo, function(x) x$v))

#Looking at data to make sure smd and vmd added as columns
#ES_DS_fv_fm
#ES_DS_p_r
#ES_SS_fv_fm

#Removing controls for modeling
ES_DS_fv_fm2 <- subset(ES_DS_fv_fm, Control=="0")
ES_DS_p_r2 <- subset(ES_DS_p_r, Control=="0")
ES_SS_fv_fm2 <- subset(ES_SS_fv_fm, Control=="0")

#Looking at data to make sure controls were removed
#ES_DS_fv_fm2
#ES_DS_p_r2
#ES_SS_fv_fm2
ES_DS_fv_fm2 %>% tally()
ES_DS_p_r2 %>% tally()
ES_SS_fv_fm2 %>% tally()
``` 
  
# I. Photosynthetic Efficiency  

## A. Deposited Sediment  
  
### 1. Plots  
I calculated the standardized mean difference in terms of Hedges' *d* and plot it here with respect to cumulative exposure. I did this first for a Hedges' *d* that I calculated before importing the data to R and again for a Hedges' *d* that is calculated by the dosresmeta::covar.smd function.

```{r, echo=FALSE, warning=FALSE}
#CUMULATIVE EXPOSURE vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_exposure_mg_cm2,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_exposure_mg_cm2,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 

#EXPOSURE CONCENTRATION vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000")) 
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000")) 


#EXPOSURE CONCENTRATION vs. effect size, by SEDIMENT TYPE
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_category,
           shape = Sed_source,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment relative\ngrain size",
       shape = "Sediment source") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000")) 
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_class,
           shape = Sed_mineralogy,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment\ngrain class",
       shape = "Sediment mineralogy") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000")) 

#EXPOSURE CONCENTRATION vs. effect size, by PHYLOGENY
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Updated_Genus,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Genus") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000")) 

#EXPOSURE CONCENTRATION vs. effect size, by OCEAN and REGION
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Region,
           shape = Ocean,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Region",
       shape = "Ocean") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(0.1,1000), breaks=c(0.1,1,10,100,1000), 
                label=c("0.1","1","10","100","1000")) 
```
  
It is interesting that there is a difference between how I calculated Hedges' *d* and how *dosresmeta* appears to calculate it. But in both cases, there may be a negative relationship between sediment exposure and effect size. There does not appear to be strong effects of phylogeny (genus) or geography (ocean and region). There may be effects of sediment type (source, origin, grain size), but I do not think these will be discernible given the variance.
  
### 2. Model Fitting
The following set of functions model fixed and random (nested) effects WITHOUT accounting for within-comparison (or within-study) correlations. The output for each is a univariate, random-effects meta-regression.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models with 'a' or 'b' at the end of its name have cumulative exposure as its predictor. 
#All models with 'c' or 'd' at the end of its name have exposure concentration as its predictor. 
#All models with 'a' or 'c' at the end of its name have manually calculated Hedges' d as its response.
#All models with 'b' or 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_photo_1a <- mixmeta(Hedges_d ~ 0 + Sed_exposure_mg_cm2, S = Var_d,
                       random =  ~ 0 + Sed_exposure_mg_cm2 | Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_1b <- mixmeta(smd ~ 0 + Sed_exposure_mg_cm2, S = vmd,
                      random =  ~ 0 + Sed_exposure_mg_cm2 | Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_1c <- mixmeta(Hedges_d ~ 0 + Sed_level_standardized, S = Var_d,
                       random =  ~ 0 + Sed_level_standardized | Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_1d <- mixmeta(smd ~ 0 + Sed_level_standardized, S = vmd,
                      random =  ~ 0 + Sed_level_standardized | Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_photo_2a <- mixmeta(Hedges_d ~ 0 + Sed_exposure_mg_cm2, S = Var_d,
                       random =  ~ 0 + Sed_exposure_mg_cm2 | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_2b <- mixmeta(smd ~ 0 + Sed_exposure_mg_cm2, S = vmd,
                      random =  ~ 0 + Sed_exposure_mg_cm2 | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_2c <- mixmeta(Hedges_d ~ 0 + Sed_level_standardized, S = Var_d,
                       random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_2d <- mixmeta(smd ~ 0 + Sed_level_standardized, S = vmd,
                      random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_photo_3a <- mixmeta(Hedges_d ~ 0 + Sed_exposure_mg_cm2, S = Var_d,
                       random =  ~ 0 + Sed_exposure_mg_cm2 | Ref_name/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_3b <- mixmeta(smd ~ 0 + Sed_exposure_mg_cm2, S = vmd,
                      random =  ~ 0 + Sed_exposure_mg_cm2 | Ref_name/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_3c <- mixmeta(Hedges_d ~ 0 + Sed_level_standardized, S = Var_d,
                       random =  ~ 0 + Sed_level_standardized | Ref_name/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_3d <- mixmeta(smd ~ 0 + Sed_level_standardized, S = vmd,
                      random =  ~ 0 + Sed_level_standardized | Ref_name/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_photo_4a <- mixmeta(Hedges_d ~ 0 + Sed_exposure_mg_cm2, S = Var_d,
                       random =  ~ 0 + Sed_exposure_mg_cm2 | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_4b <- mixmeta(smd ~ 0 + Sed_exposure_mg_cm2, S = vmd,
                       random =  ~ 0 + Sed_exposure_mg_cm2 | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_4c <- mixmeta(Hedges_d ~ 0 + Sed_level_standardized, S = Var_d,
                       random =  ~ 0 + Sed_level_standardized | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
mod_DS_photo_4d <- mixmeta(smd ~ 0 + Sed_level_standardized, S = vmd,
                       random =  ~ 0 + Sed_level_standardized | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_DS_photo <- by(ES_DS_fv_fm, ES_DS_fv_fm$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))

# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_FVFM <- list(NA)
for (i in seq(1,length(covar_DS_photo))) {
newlist_FVFM[i] <- list(covar_DS_photo[[i]]$S)
}
mod_DS_photo_5a <- mixmeta(Hedges_d ~ 0 + Sed_exposure_mg_cm2,
                       random = ~ 0 + Sed_exposure_mg_cm2 | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM))
mod_DS_photo_5b <- mixmeta(smd ~ 0 + Sed_exposure_mg_cm2,
                       random = ~ 0 + Sed_exposure_mg_cm2 | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM))
mod_DS_photo_5c <- mixmeta(Hedges_d ~ 0 + Sed_level_standardized,
                       random = ~ 0 + Sed_level_standardized | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM))
mod_DS_photo_5d <- mixmeta(smd ~ 0 + Sed_level_standardized,
                       random = ~ 0 + Sed_level_standardized | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_FVFM2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_FVFM <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_FVFM2 <-list(NA)
reflista <- ES_DS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_DS_photo that are all from the same reference [i]
  templist_FVFM[i] <-list(covar_DS_photo[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_FVFM[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_FVFM2
     templist_FVFM2[j] <- list(templist_FVFM[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_FVFM2[i] <- list(bdiagMat(templist_FVFM2))
  templist_FVFM2 <- list(NA)
}
mod_DS_photo_6a <- mixmeta(Hedges_d ~ 0 + Sed_exposure_mg_cm2,
                       random = ~ 0 + Sed_exposure_mg_cm2 | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM2))
mod_DS_photo_6b <- mixmeta(smd ~ 0 + Sed_exposure_mg_cm2,
                       random = ~ 0 + Sed_exposure_mg_cm2 | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM2))
mod_DS_photo_6c <- mixmeta(Hedges_d ~ 0 + Sed_level_standardized,
                       random = ~ 0 + Sed_level_standardized | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM2))
mod_DS_photo_6d <- mixmeta(smd ~ 0 + Sed_level_standardized,
                       random = ~ 0 + Sed_level_standardized | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM2))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref_name/Comparison
newlist_FVFM3 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial Ref_name/Comparison
templist_FVFM3 <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_FVFM4 <-list(NA)
reflista <- ES_DS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,2]
for (i in seq(1,length(unique(reflista$Ref_name))))  {
  #pull the elements from covar_DS_photo that are all from the same reference [i]
  templist_FVFM3[i] <-list(covar_DS_photo[reflist==unique(reflista$Ref_name)[i]])
  for (j in seq(1,length(templist_FVFM3[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_FVFM4
     templist_FVFM4[j] <- list(templist_FVFM3[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_FVFM3[i] <- list(bdiagMat(templist_FVFM4))
  templist_FVFM4 <- list(NA)
}
mod_DS_photo_7a <- mixmeta(Hedges_d ~ 0 + Sed_exposure_mg_cm2,
                       random = ~ 0 + Sed_exposure_mg_cm2 | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM3))
mod_DS_photo_7b <- mixmeta(smd ~ 0 + Sed_exposure_mg_cm2,
                       random = ~ 0 + Sed_exposure_mg_cm2 | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM3))
mod_DS_photo_7c <- mixmeta(Hedges_d ~ 0 + Sed_level_standardized,
                       random = ~ 0 + Sed_level_standardized | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM3))
mod_DS_photo_7d <- mixmeta(smd ~ 0 + Sed_level_standardized,
                       random = ~ 0 + Sed_level_standardized | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM3))
```
  
And now to compare relative fit of linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(mod_DS_photo_1a, mod_DS_photo_2a, mod_DS_photo_3a, mod_DS_photo_4a, mod_DS_photo_5a, mod_DS_photo_6a, mod_DS_photo_7a) 
#of these, model 2a has lowest AIC

AIC(mod_DS_photo_1b, mod_DS_photo_2b, mod_DS_photo_3b, mod_DS_photo_4b, mod_DS_photo_5b, mod_DS_photo_6b, mod_DS_photo_7b) 
#of these, model 2b has lowest AIC

AIC(mod_DS_photo_1c, mod_DS_photo_2c, mod_DS_photo_3c, mod_DS_photo_4c, mod_DS_photo_5c, mod_DS_photo_6c, mod_DS_photo_7c) 
#of these, model 2c has lowest AIC

AIC(mod_DS_photo_1d, mod_DS_photo_2d, mod_DS_photo_3d, mod_DS_photo_4d, mod_DS_photo_5d, mod_DS_photo_6d, mod_DS_photo_7d) 
#of these, model 2d has lowest AIC

#ALTERNATIVE MODELS WITHOUT ZERO INTERCEPT
# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
alt_mod_DS_photo_2a <- mixmeta(Hedges_d ~ Sed_exposure_mg_cm2, S = Var_d,
                       random =  ~ Sed_exposure_mg_cm2 | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
alt_mod_DS_photo_2b <- mixmeta(smd ~ Sed_exposure_mg_cm2, S = vmd,
                      random =  ~ Sed_exposure_mg_cm2 | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
alt_mod_DS_photo_2c <- mixmeta(Hedges_d ~ Sed_level_standardized, S = Var_d,
                       random =  ~ Sed_level_standardized | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
alt_mod_DS_photo_2d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

AIC(alt_mod_DS_photo_2a, mod_DS_photo_2a)
AIC(alt_mod_DS_photo_2b, mod_DS_photo_2b)
AIC(alt_mod_DS_photo_2c, mod_DS_photo_2c)
AIC(alt_mod_DS_photo_2d, mod_DS_photo_2d)
#In all cases, the alternative models have lower AIC values, but take a look at the outrageous residuals from these alt models...
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
#Models WITH zero intercept
# Residuals vs. Fitted Plots
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))

resid_a <- resid(mod_DS_photo_2a)
fitted_a <- fitted(mod_DS_photo_2a)
plot(fitted_a, resid_a, main = "A: Hedges_d ~ 0+mg_cm2, S = Var_d,
     random =  ~ 0+mg_cm2 | Ref/Comparison")
abline(0,0)
#mod_DS_photo_1a and mod_DS_photo_3a were within 2 AIC

resid_b <- resid(mod_DS_photo_2b)
fitted_b <- fitted(mod_DS_photo_2b)
plot(fitted_b, resid_b, main = "B: smd ~ 0+mg_cm2, S = vmd,
     random =  ~ 0+mg_cm2 | Ref/Comparison")
abline(0,0)
#mod_DS_photo_6b within 1 AIC

resid_c <- resid(mod_DS_photo_2c)
fitted_c <- fitted(mod_DS_photo_2c)
plot(fitted_c, resid_c, main = "C: Hedges_d ~ 0+mg_cm2_d, S = Var_d,
     random =  ~ 0+mg_cm2_d | Ref/Comparison")
abline(0,0)
#mod_DS_photo_2c within 0.3 AIC

resid_d <- resid(mod_DS_photo_2d)
fitted_d <- fitted(mod_DS_photo_2d)
plot(fitted_d, resid_d, main = "D: smd ~ 0+mg_cm2_d, S = vmd,
     random =  ~ 0+mg_cm2_d | Ref/Comparison")
abline(0,0)

par(op)

# Normal Q-Q Plot
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))
qqnorm(resid_a)
qqline(resid_a)
qqnorm(resid_b)
qqline(resid_b)
qqnorm(resid_c)
qqline(resid_c)
qqnorm(resid_d)
qqline(resid_d)
par(op)


#Models WITHOUT zero intercept
# Residuals vs. Fitted Plots
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))

alt_resid_a <- resid(alt_mod_DS_photo_2a)
alt_fitted_a <- fitted(alt_mod_DS_photo_2a)
plot(alt_fitted_a, alt_resid_a, main = "A: Hedges_d ~ mg_cm2, S = Var_d,
     random =  ~ mg_cm2 | Ref/Comparison")
abline(0,0)
#alt_mod_DS_photo_1a and alt_mod_DS_photo_3a were within 2 AIC

alt_resid_b <- resid(alt_mod_DS_photo_2b)
alt_fitted_b <- fitted(alt_mod_DS_photo_2b)
plot(alt_fitted_b, alt_resid_b, main = "B: smd ~ mg_cm2, S = vmd,
     random =  ~ mg_cm2 | Ref/Comparison")
abline(0,0)
#alt_mod_DS_photo_6b within 1 AIC

alt_resid_c <- resid(alt_mod_DS_photo_2c)
alt_fitted_c <- fitted(alt_mod_DS_photo_2c)
plot(alt_fitted_c, alt_resid_c, main = "C: Hedges_d ~ mg_cm2_d, S = Var_d,
     random =  ~ mg_cm2_d | Ref/Comparison")
abline(0,0)
#alt_mod_DS_photo_2c within 0.3 AIC

alt_resid_d <- resid(alt_mod_DS_photo_2d)
alt_fitted_d <- fitted(alt_mod_DS_photo_2d)
plot(alt_fitted_d, alt_resid_d, main = "D: smd ~ mg_cm2_d, S = vmd,
     random =  ~ mg_cm2_d | Ref/Comparison")
abline(0,0)

par(op)

# Normal Q-Q Plot
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))
qqnorm(alt_resid_a)
qqline(alt_resid_a)
qqnorm(alt_resid_b)
qqline(alt_resid_b)
qqnorm(alt_resid_c)
qqline(alt_resid_c)
qqnorm(alt_resid_d)
qqline(alt_resid_d)
par(op)


# Patterns:
# 1.  "Clumping" of residuals that may be improved by log-transformation.
# 2.  The angle of the residual line looks terrible for alternative models.
# 4.  First let's try a log transformation of sediment exposure for both alt and normal models.
```
  
Now let's check out a log, base 10 transformation of sediment exposure to see if it improves the residuals of the models.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models with 'a' or 'b' at the end of its name have cumulative exposure as its predictor. 
#All models with 'c' or 'd' at the end of its name have exposure concentration as its predictor. 
#All models with 'a' or 'c' at the end of its name have manually calculated Hedges' d as its response.
#All models with 'b' or 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

log10_mg_cm2 <- log10(ES_DS_fv_fm2$Sed_exposure_mg_cm2)
log10_mg_cm2_d <- log10(ES_DS_fv_fm2$Sed_level_standardized)

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_photo_1a <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2 | Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_1b <- mixmeta(smd ~ 0 + log10_mg_cm2, S = vmd,
                      random =  ~ 0 + log10_mg_cm2 | Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_1c <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2_d, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2_d | Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_1d <- mixmeta(smd ~ 0 + log10_mg_cm2_d, S = vmd,
                      random =  ~ 0 + log10_mg_cm2_d | Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_photo_2a <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2 | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_2b <- mixmeta(smd ~ 0 + log10_mg_cm2, S = vmd,
                      random =  ~ 0 + log10_mg_cm2 | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_2c <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2_d, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2_d | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_2d <- mixmeta(smd ~ 0 + log10_mg_cm2_d, S = vmd,
                      random =  ~ 0 + log10_mg_cm2_d | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_photo_3a <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2 | Ref_name/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_3b <- mixmeta(smd ~ 0 + log10_mg_cm2, S = vmd,
                      random =  ~ 0 + log10_mg_cm2 | Ref_name/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_3c <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2_d, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2_d | Ref_name/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_3d <- mixmeta(smd ~ 0 + log10_mg_cm2_d, S = vmd,
                      random =  ~ 0 + log10_mg_cm2_d | Ref_name/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_DS_photo_4a <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2 | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_4b <- mixmeta(smd ~ 0 + log10_mg_cm2, S = vmd,
                       random =  ~ 0 + log10_mg_cm2 | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_4c <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2_d, S = Var_d,
                       random =  ~ 0 + log10_mg_cm2_d | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
log_mod_DS_photo_4d <- mixmeta(smd ~ 0 + log10_mg_cm2_d, S = vmd,
                       random =  ~ 0 + log10_mg_cm2_d | Ref_name/Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_DS_photo <- by(ES_DS_fv_fm, ES_DS_fv_fm$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))

# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_log_FVFM <- list(NA)
for (i in seq(1,length(covar_DS_photo))) {
newlist_log_FVFM[i] <- list(covar_DS_photo[[i]]$S)
}
log_mod_DS_photo_5a <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2,
                       random = ~ 0 + log10_mg_cm2 | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))
log_mod_DS_photo_5b <- mixmeta(smd ~ 0 + log10_mg_cm2,
                       random = ~ 0 + log10_mg_cm2 | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))
log_mod_DS_photo_5c <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2_d,
                       random = ~ 0 + log10_mg_cm2_d | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))
log_mod_DS_photo_5d <- mixmeta(smd ~ 0 + log10_mg_cm2_d,
                       random = ~ 0 + log10_mg_cm2_d | Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_log_FVFM2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_log_FVFM <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_log_FVFM2 <-list(NA)
reflista <- ES_DS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_DS_photo that are all from the same reference [i]
  templist_log_FVFM[i] <-list(covar_DS_photo[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_log_FVFM[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_log_FVFM2
     templist_log_FVFM2[j] <- list(templist_log_FVFM[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_log_FVFM2[i] <- list(bdiagMat(templist_log_FVFM2))
  templist_log_FVFM2 <- list(NA)
}
log_mod_DS_photo_6a <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2,
                       random = ~ 0 + log10_mg_cm2 | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))
log_mod_DS_photo_6b <- mixmeta(smd ~ 0 + log10_mg_cm2,
                       random = ~ 0 + log10_mg_cm2 | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))
log_mod_DS_photo_6c <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2_d,
                       random = ~ 0 + log10_mg_cm2_d | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))
log_mod_DS_photo_6d <- mixmeta(smd ~ 0 + log10_mg_cm2_d,
                       random = ~ 0 + log10_mg_cm2_d | Ref/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref_name/Comparison
newlist_log_FVFM3 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial Ref_name/Comparison
templist_log_FVFM3 <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_log_FVFM4 <-list(NA)
reflista <- ES_DS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,2]
for (i in seq(1,length(unique(reflista$Ref_name))))  {
  #pull the elements from covar_DS_photo that are all from the same reference [i]
  templist_log_FVFM3[i] <-list(covar_DS_photo[reflist==unique(reflista$Ref_name)[i]])
  for (j in seq(1,length(templist_log_FVFM3[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_log_FVFM4
     templist_log_FVFM4[j] <- list(templist_log_FVFM3[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_log_FVFM3[i] <- list(bdiagMat(templist_log_FVFM4))
  templist_log_FVFM4 <- list(NA)
}
log_mod_DS_photo_7a <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2,
                       random = ~ 0 + log10_mg_cm2 | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
log_mod_DS_photo_7b <- mixmeta(smd ~ 0 + log10_mg_cm2,
                       random = ~ 0 + log10_mg_cm2 | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
log_mod_DS_photo_7c <- mixmeta(Hedges_d ~ 0 + log10_mg_cm2_d,
                       random = ~ 0 + log10_mg_cm2_d | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
log_mod_DS_photo_7d <- mixmeta(smd ~ 0 + log10_mg_cm2_d,
                       random = ~ 0 + log10_mg_cm2_d | Ref_name/Comparison,
                       data=ES_DS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
```
  
### 3. Model Comparison and Summary
And now to compare relative fit of log-linear models...
  
```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(log_mod_DS_photo_1a, log_mod_DS_photo_2a, log_mod_DS_photo_3a, log_mod_DS_photo_4a, log_mod_DS_photo_5a, log_mod_DS_photo_6a, log_mod_DS_photo_7a) 
#of these, model 2a has lowest AIC

AIC(log_mod_DS_photo_1b, log_mod_DS_photo_2b, log_mod_DS_photo_3b, log_mod_DS_photo_4b, log_mod_DS_photo_5b, log_mod_DS_photo_6b, log_mod_DS_photo_7b) 
#of these, model 2b has lowest AIC

AIC(log_mod_DS_photo_1c, log_mod_DS_photo_2c, log_mod_DS_photo_3c, log_mod_DS_photo_4c, log_mod_DS_photo_5c, log_mod_DS_photo_6c, log_mod_DS_photo_7c) 
#of these, model 2c has lowest AIC

AIC(log_mod_DS_photo_1d, log_mod_DS_photo_2d, log_mod_DS_photo_3d, log_mod_DS_photo_4d, log_mod_DS_photo_5d, log_mod_DS_photo_6d, log_mod_DS_photo_7d) 
#of these, model 2d has lowest AIC

#ALTERNATIVE MODELS WITHOUT ZERO INTERCEPT
# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
alt_log_mod_DS_photo_2a <- mixmeta(Hedges_d ~ log10_mg_cm2, S = Var_d,
                       random =  ~ log10_mg_cm2 | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
alt_log_mod_DS_photo_2b <- mixmeta(smd ~ log10_mg_cm2, S = vmd,
                      random =  ~ log10_mg_cm2 | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")
alt_log_mod_DS_photo_2c <- mixmeta(Hedges_d ~ log10_mg_cm2_d, S = Var_d,
                       random =  ~ log10_mg_cm2_d | Ref/Comparison,
                       data = ES_DS_fv_fm2, method = "ml")
alt_log_mod_DS_photo_2d <- mixmeta(smd ~ log10_mg_cm2_d, S = vmd,
                      random =  ~ log10_mg_cm2_d | Ref/Comparison,
                      data = ES_DS_fv_fm2, method = "ml")

AIC(alt_log_mod_DS_photo_2a, log_mod_DS_photo_2a)
AIC(alt_log_mod_DS_photo_2b, log_mod_DS_photo_2b)
AIC(alt_log_mod_DS_photo_2c, log_mod_DS_photo_2c)
AIC(alt_log_mod_DS_photo_2d, log_mod_DS_photo_2d)
#In all cases except model A, the alternative models have lower AIC values, but let's take a look at the residuals from these alt models...
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
#Models WITH zero intercept
# Residuals vs. Fitted Plots
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))

resid_loga <- resid(log_mod_DS_photo_2a)
fitted_loga <- fitted(log_mod_DS_photo_2a)
plot(fitted_loga, resid_loga, main = "A: Hedges_d ~ 0+log_mg_cm2, S=Var_d,
     random =  ~ 0+log_mg_cm2 | Ref/Comparison")
abline(0,0)

resid_logb <- resid(log_mod_DS_photo_2b)
fitted_logb <- fitted(log_mod_DS_photo_2b)
plot(fitted_logb, resid_logb, main = "B: smd ~ 0+log_mg_cm2, S = vmd,
     random =  ~ 0+log_mg_cm2 | Ref/Comparison")
abline(0,0)

resid_logc <- resid(log_mod_DS_photo_2c)
fitted_logc <- fitted(log_mod_DS_photo_2c)
plot(fitted_logc, resid_logc, main = "C: Hedges_d ~ 0+log_mg_cm2_d, S=Var_d,
     random =  ~ 0+log_mg_cm2_d | Ref/Comparison")
abline(0,0)

resid_logd <- resid(log_mod_DS_photo_2d)
fitted_logd <- fitted(log_mod_DS_photo_2d)
plot(fitted_logd, resid_logd, main = "D: smd ~ 0+log_mg_cm2_d, S = vmd,
     random =  ~ 0+log_mg_cm2_d | Ref/Comparison")
abline(0,0)

par(op)

# Normal Q-Q Plot
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))
qqnorm(resid_loga)
qqline(resid_loga)
qqnorm(resid_logb)
qqline(resid_logb)
qqnorm(resid_logc)
qqline(resid_logc)
qqnorm(resid_logd)
qqline(resid_logd)
par(op)


#Models WITHOUT zero intercept
# Residuals vs. Fitted Plots
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))

resid_alt_loga <- resid(alt_log_mod_DS_photo_2a)
fitted_alt_loga <- fitted(alt_log_mod_DS_photo_2a)
plot(fitted_alt_loga, resid_alt_loga, main = "A: Hedges_d ~ log_mg_cm2, S=Var_d,
     random =  ~ log_mg_cm2 | Ref/Comparison")
abline(0,0)

resid_alt_logb <- resid(alt_log_mod_DS_photo_2b)
fitted_alt_logb <- fitted(alt_log_mod_DS_photo_2b)
plot(fitted_alt_logb, resid_alt_logb, main = "B: smd ~ log_mg_cm2, S = vmd,
     random =  ~ log_mg_cm2 | Ref/Comparison")
abline(0,0)

resid_alt_logc <- resid(alt_log_mod_DS_photo_2c)
fitted_alt_logc <- fitted(alt_log_mod_DS_photo_2c)
plot(fitted_alt_logc, resid_alt_logc, main = "C: Hedges_d ~ log_mg_cm2_d, S=Var_d,
     random =  ~ log_mg_cm2_d | Ref/Comparison")
abline(0,0)

resid_alt_logd <- resid(alt_log_mod_DS_photo_2d)
fitted_alt_logd <- fitted(alt_log_mod_DS_photo_2d)
plot(fitted_alt_logd, resid_alt_logd, main = "D: smd ~ log_mg_cm2_d, S = vmd,
     random =  ~ log_mg_cm2_d | Ref/Comparison")
abline(0,0)

par(op)

# Normal Q-Q Plot
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))
qqnorm(resid_alt_loga)
qqline(resid_alt_loga)
qqnorm(resid_alt_logb)
qqline(resid_alt_logb)
qqnorm(resid_alt_logc)
qqline(resid_alt_logc)
qqnorm(resid_alt_logd)
qqline(resid_alt_logd)
par(op)


# Patterns:
# 1.  Log models much improve residuals -- lower magnitudes and more even spread. 
# 2.  Alt models look terrible -- high magnitude residuals and severe misalignment between residual points and model average (zero abline).
```
  
### 4. Best-Fit Model Summary
  
#### i. MG/CM2 IS PREDICTOR, Model using manual calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_DS_photo_2a)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_DS_photo_2a, newdata=data.frame(Sed_exposure_mg_cm2=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_DS_photo_2a <- predict(log_mod_DS_photo_2a, newdata=ES_DS_fv_fm2, ci=TRUE)
ES_DS_fv_fm2_CI <- cbind(ES_DS_fv_fm2, pred_log_mod_DS_photo_2a)
#head(ES_DS_fv_fm2_CI)
min_exp_a <- ES_DS_fv_fm2_CI %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp_a=min(Sed_exposure_mg_cm2))
min_exp_a2 <- as.numeric(min_exp_a)

ggplot(ES_DS_fv_fm2_CI, 
       aes(x = Sed_exposure_mg_cm2,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = expression("Sediment cumulative exposure (mg/cm"^"2"*")"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp_a2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_cm2, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_cm2, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(10,1000), breaks=c(10,100,1000,min_exp_a2), 
                label=c("10","100","1000",round(min_exp_a2,digits=1))) 
```
  
#### ii. MG/CM2 IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_DS_photo_2b)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_DS_photo_2b, newdata=data.frame(Sed_exposure_mg_cm2=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_DS_photo_2b <- predict(log_mod_DS_photo_2b, newdata=ES_DS_fv_fm2, ci=TRUE)
ES_DS_fv_fm2_CI2 <- cbind(ES_DS_fv_fm2, pred_log_mod_DS_photo_2b)
#head(ES_DS_fv_fm2_CI2)
min_exp_b <- ES_DS_fv_fm2_CI2 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp_b=min(Sed_exposure_mg_cm2))
min_exp_b2 <- as.numeric(min_exp_b)

ggplot(ES_DS_fv_fm2_CI2, 
       aes(x = Sed_exposure_mg_cm2,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  labs(x = expression("Sediment cumulative exposure (mg/cm"^"2"*")"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp_b2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_cm2, y = smd,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_cm2, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(10,1000), breaks=c(10,100,1000,min_exp_b2), 
                label=c("10","100","1000",round(min_exp_b2, digits=1)))
```
  
#### iii. MG/CM2/DAY IS PREDICTOR, Model using manual calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_DS_photo_2c)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_DS_photo_2c, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_DS_photo_2c <- predict(log_mod_DS_photo_2c, newdata=ES_DS_fv_fm2, ci=TRUE)
ES_DS_fv_fm2_CI3 <- cbind(ES_DS_fv_fm2, pred_log_mod_DS_photo_2c)
#head(ES_DS_fv_fm2_CI3)
min_conc_c <- ES_DS_fv_fm2_CI3 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  filter(ci.ub<0) %>% 
  summarize(min_conc_c=min(Sed_level_standardized))
min_conc_c2 <- as.numeric(min_conc_c)

ggplot(ES_DS_fv_fm2_CI3, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_c2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,1000), breaks=c(0.1,1,10,100,1000,min_conc_c2), 
                label=c("0.1","1","10","100","1000",round(min_conc_c2,digits=1)))
```
  
#### iv. MG/CM2/DAY IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_DS_photo_2d)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_DS_photo_2d, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_DS_photo_2d <- predict(log_mod_DS_photo_2d, newdata=ES_DS_fv_fm2, ci=TRUE)
ES_DS_fv_fm2_CI4 <- cbind(ES_DS_fv_fm2, pred_log_mod_DS_photo_2d)
#head(ES_DS_fv_fm2_CI4)
min_conc_d <- ES_DS_fv_fm2_CI4 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  filter(ci.ub<0) %>% 
  summarize(min_conc_d=min(Sed_level_standardized))
min_conc_d2 <- as.numeric(min_conc_d)

ggplot(ES_DS_fv_fm2_CI4, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_d2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = smd,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(0.1,1000), breaks=c(0.1,1,10,100,1000,min_conc_d2), 
                label=c("0.1","1","10","100","1000",round(min_conc_d2,digits=1)))
```
  
  
## B. Suspended Sediment  
  
### 1. Plots  
I calculated the standardized mean difference in terms of Hedges' *d* and plot it here with respect to cumulative exposure. I did this first for a Hedges' *d* that I calculated before importing the data to R and again for a Hedges' *d* that is calculated by the dosresmeta::covar.smd function.

```{r, echo=FALSE, warning=FALSE}
#CUMULATIVE EXPOSURE vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_exposure_mg_d_L,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(1,10000), breaks=c(1,10,100,1000,10000), 
                label=c("1","10","100","1000","10000"))
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_exposure_mg_d_L,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits=c(1,10000), breaks=c(1,10,100,1000,10000), 
                label=c("1","10","100","1000","10000"))

#EXPOSURE CONCENTRATION vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 


#EXPOSURE CONCENTRATION vs. effect size, by SEDIMENT TYPE
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_category,
           shape = Sed_source,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment relative\ngrain size",
       shape = "Sediment source") +
  geom_abline(intercept=0, slope=0) +
  theme_classic()
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_class,
           shape = Sed_mineralogy,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment\ngrain class",
       shape = "Sediment mineralogy") +
  geom_abline(intercept=0, slope=0) +
  theme_classic()

#EXPOSURE CONCENTRATION vs. effect size, by PHYLOGENY
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Updated_Genus,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Genus") +
  geom_abline(intercept=0, slope=0) +
  theme_classic()

#EXPOSURE CONCENTRATION vs. effect size, by OCEAN and REGION
#Using previously calculated Hedges' d and variance of d
ggplot(ES_SS_fv_fm2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Region,
           shape = Ocean,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthetic efficiency, Fv/Fm") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Region",
       shape = "Ocean") +
  geom_abline(intercept=0, slope=0) +
  theme_classic()
```
  
It is interesting that there is a difference between how I calculated Hedges' *d* and how *dosresmeta* appears to calculate it. But in both cases, there is a funnel-like relationship between sediment exposure and effect size. There does not appear to be strong effects of phylogeny (genus) or geography (ocean and region). **??There may be effects of sediment type (source, origin, grain size), but I do not think these will be discernible given the variance.??**
  
### 2. Model Fitting  
The following set of functions model fixed and random (nested) effects WITHOUT accounting for within-comparison (or within-study) correlations. The output for each is a univariate, random-effects meta-regression.

```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models with 'a' or 'b' at the end of its name have cumulative exposure as its predictor. 
#All models with 'c' or 'd' at the end of its name have exposure concentration as its predictor. 
#All models with 'a' or 'c' at the end of its name have manually calculated Hedges' d as its response.
#All models with 'b' or 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in chol.default(X[[i]], ...) : the leading minor of order 4/4 is not positive definite
#mod_SS_photo_1a <- mixmeta(Hedges_d ~ Sed_exposure_mg_d_L, S = Var_d,
#                       random =  ~ Sed_exposure_mg_d_L | Comparison,
#                       data = ES_SS_fv_fm2, method = "ml")
#mod_SS_photo_1b <- mixmeta(smd ~ Sed_exposure_mg_d_L, S = vmd,
#                      random =  ~ Sed_exposure_mg_d_L | Comparison,
#                      data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_1c <- mixmeta(Hedges_d ~ Sed_level_standardized, S = Var_d,
                       random =  ~ Sed_level_standardized | Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_1d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Comparison,
                      data = ES_SS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in chol.default(X[[i]], ...) : the leading minor of order 32 is not positive definite
#mod_SS_photo_2a <- mixmeta(Hedges_d ~ Sed_exposure_mg_d_L, S = Var_d,
#                       random =  ~ Sed_exposure_mg_d_L | Ref/Comparison,
#                       data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_2b <- mixmeta(smd ~ Sed_exposure_mg_d_L, S = vmd,
                      random =  ~ Sed_exposure_mg_d_L | Ref/Comparison,
                      data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_2c <- mixmeta(Hedges_d ~ Sed_level_standardized, S = Var_d,
                       random =  ~ Sed_level_standardized | Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_2d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Ref/Comparison,
                      data = ES_SS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in chol.default(X[[i]], ...) : the leading minor of order 31/24 is not positive definite
#mod_SS_photo_3a <- mixmeta(Hedges_d ~ Sed_exposure_mg_d_L, S = Var_d,
#                       random =  ~ Sed_exposure_mg_d_L | Ref_name/Comparison,
#                       data = ES_SS_fv_fm2, method = "ml")
#mod_SS_photo_3b <- mixmeta(smd ~ Sed_exposure_mg_d_L, S = vmd,
#                      random =  ~ Sed_exposure_mg_d_L | Ref_name/Comparison,
#                      data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_3c <- mixmeta(Hedges_d ~ Sed_level_standardized, S = Var_d,
                       random =  ~ Sed_level_standardized | Ref_name/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_3d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Ref_name/Comparison,
                      data = ES_SS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in chol.default(X[[i]], ...) : the leading minor of order 32/28 is not positive definite
#mod_SS_photo_4a <- mixmeta(Hedges_d ~ Sed_exposure_mg_d_L, S = Var_d,
#                       random =  ~ Sed_exposure_mg_d_L | Ref_name/Ref/Comparison,
#                       data = ES_SS_fv_fm2, method = "ml")
#mod_SS_photo_4b <- mixmeta(smd ~ Sed_exposure_mg_d_L, S = vmd,
#                       random =  ~ Sed_exposure_mg_d_L | Ref_name/Ref/Comparison,
#                       data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_4c <- mixmeta(Hedges_d ~ Sed_level_standardized, S = Var_d,
                       random =  ~ Sed_level_standardized | Ref_name/Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
mod_SS_photo_4d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                       random =  ~ Sed_level_standardized | Ref_name/Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_DS_photo <- by(ES_DS_fv_fm, ES_DS_fv_fm$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))

# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_FVFM_SS <- list(NA)
for (i in seq(1,length(covar_SS_photo))) {
newlist_FVFM_SS[i] <- list(covar_SS_photo[[i]]$S)
}
#Error in chol.default(X[[i]], ...) : the leading minor of order 4 is not positive definite
#mod_SS_photo_5a <- mixmeta(Hedges_d ~ Sed_exposure_mg_d_L,
#                       random = ~ Sed_exposure_mg_d_L | Comparison,
#                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_FVFM_SS))
#mod_SS_photo_5b <- mixmeta(smd ~ Sed_exposure_mg_d_L,
#                       random = ~ Sed_exposure_mg_d_L | Comparison,
#                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_FVFM_SS))
mod_SS_photo_5c <- mixmeta(Hedges_d ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM_SS))
mod_SS_photo_5d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM_SS))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_FVFM_SS2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_FVFM_SS <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_FVFM_SS2 <-list(NA)
reflista <- ES_SS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_SS_photo that are all from the same reference [i]
  templist_FVFM_SS[i] <-list(covar_SS_photo[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_FVFM_SS[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_FVFM_SS2
     templist_FVFM_SS2[j] <- list(templist_FVFM_SS[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_FVFM_SS2[i] <- list(bdiagMat(templist_FVFM_SS2))
  templist_FVFM_SS2 <- list(NA)
}
#Error in chol.default(X[[i]], ...) : the leading minor of order 35/10 is not positive definite
#mod_SS_photo_6a <- mixmeta(Hedges_d ~ Sed_exposure_mg_d_L,
#                       random = ~ Sed_exposure_mg_d_L | Ref/Comparison,
#                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_FVFM_SS2))
#mod_SS_photo_6b <- mixmeta(smd ~ Sed_exposure_mg_d_L,
#                       random = ~ Sed_exposure_mg_d_L | Ref/Comparison,
#                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_FVFM_SS2))
mod_SS_photo_6c <- mixmeta(Hedges_d ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Ref/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM_SS2))
mod_SS_photo_6d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Ref/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM_SS2))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref_name/Comparison
newlist_FVFM_SS3 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial Ref_name/Comparison
templist_FVFM_SS3 <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_FVFM_SS4 <-list(NA)
reflista <- ES_SS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,2]
for (i in seq(1,length(unique(reflista$Ref_name))))  {
  #pull the elements from covar_SS_photo that are all from the same reference [i]
  templist_FVFM_SS3[i] <-list(covar_SS_photo[reflist==unique(reflista$Ref_name)[i]])
  for (j in seq(1,length(templist_FVFM_SS3[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_FVFM_SS4
     templist_FVFM_SS4[j] <- list(templist_FVFM_SS3[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_FVFM_SS3[i] <- list(bdiagMat(templist_FVFM_SS4))
  templist_FVFM_SS4 <- list(NA)
}
#Error in chol.default(X[[i]], ...) : the leading minor of order 36/27 is not positive definite
#mod_SS_photo_7a <- mixmeta(Hedges_d ~ Sed_exposure_mg_d_L,
#                       random = ~ Sed_exposure_mg_d_L | Ref_name/Comparison,
#                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_FVFM_SS3))
#mod_SS_photo_7b <- mixmeta(smd ~ Sed_exposure_mg_d_L,
#                       random = ~ Sed_exposure_mg_d_L | Ref_name/Comparison,
#                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_FVFM_SS3))
mod_SS_photo_7c <- mixmeta(Hedges_d ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Ref_name/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM_SS3))
mod_SS_photo_7d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Ref_name/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_FVFM_SS3))
```
  
And now to compare relative fit of linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(mod_SS_photo_1c, mod_SS_photo_2c, mod_SS_photo_3c, mod_SS_photo_4c, mod_SS_photo_5c, mod_SS_photo_6c, mod_SS_photo_7c) 
#of these, model 1c has lowest AIC

AIC(mod_SS_photo_1d, mod_SS_photo_2d, mod_SS_photo_3d, mod_SS_photo_4d, mod_SS_photo_5d, mod_SS_photo_6d, mod_SS_photo_7d) 
#of these, model 5d has lowest AIC
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))

resid_c <- resid(mod_SS_photo_1c)
fitted_c <- fitted(mod_SS_photo_1c)
plot(fitted_c, resid_c, main = "C: Hedges_d ~ mg_L, S = Var_d,
     random =  ~ mg_L | Comparison")
abline(0,0)
#mod_SS_photo_2c within 0.3 AIC

resid_d <- resid(mod_SS_photo_5d)
fitted_d <- fitted(mod_SS_photo_5d)
plot(fitted_d, resid_d, main = "D: smd ~ mg_L, control=addSlist,
     random =  ~ mg_L | Comparison")
abline(0,0)

par(op)


# Normal Q-Q Plot
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))
qqnorm(resid_c)
qqline(resid_c)
qqnorm(resid_d)
qqline(resid_d)
par(op)


# Patterns:
# 1.  Not bad -- not high magnitude of residuals and does not look like it requires transformations or non-linear approaches.
# 2.  But models A and B were not working, so will try log transformation on those.
```
  
Now let's check out a log, base 10 transformation of sediment exposure to see if it improves the residuals of the models.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models with 'a' or 'b' at the end of its name have cumulative exposure as its predictor. 
#All models with 'c' or 'd' at the end of its name have exposure concentration as its predictor. 
#All models with 'a' or 'c' at the end of its name have manually calculated Hedges' d as its response.
#All models with 'b' or 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

log10_mg_d_L <- log10(ES_SS_fv_fm2$Sed_exposure_mg_d_L)
log10_mg_L <- log10(ES_SS_fv_fm2$Sed_level_standardized)

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_SS_photo_1a <- mixmeta(Hedges_d ~ log10_mg_d_L, S = Var_d,
                       random =  ~ log10_mg_d_L | Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_1b <- mixmeta(smd ~ log10_mg_d_L, S = vmd,
                      random =  ~ log10_mg_d_L | Comparison,
                      data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_1c <- mixmeta(Hedges_d ~ log10_mg_L, S = Var_d,
                       random =  ~ log10_mg_L | Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_1d <- mixmeta(smd ~ log10_mg_L, S = vmd,
                      random =  ~ log10_mg_L | Comparison,
                      data = ES_SS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_SS_photo_2a <- mixmeta(Hedges_d ~ log10_mg_d_L, S = Var_d,
                       random =  ~ log10_mg_d_L | Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_2b <- mixmeta(smd ~ log10_mg_d_L, S = vmd,
                      random =  ~ log10_mg_d_L | Ref/Comparison,
                      data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_2c <- mixmeta(Hedges_d ~ log10_mg_L, S = Var_d,
                       random =  ~ log10_mg_L | Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_2d <- mixmeta(smd ~ log10_mg_L, S = vmd,
                      random =  ~ log10_mg_L | Ref/Comparison,
                      data = ES_SS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_SS_photo_3a <- mixmeta(Hedges_d ~ log10_mg_d_L, S = Var_d,
                       random =  ~ log10_mg_d_L | Ref_name/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_3b <- mixmeta(smd ~ log10_mg_d_L, S = vmd,
                      random =  ~ log10_mg_d_L | Ref_name/Comparison,
                      data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_3c <- mixmeta(Hedges_d ~ log10_mg_L, S = Var_d,
                       random =  ~ log10_mg_L | Ref_name/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_3d <- mixmeta(smd ~ log10_mg_L, S = vmd,
                      random =  ~ log10_mg_L | Ref_name/Comparison,
                      data = ES_SS_fv_fm2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
log_mod_SS_photo_4a <- mixmeta(Hedges_d ~ log10_mg_d_L, S = Var_d,
                       random =  ~ log10_mg_d_L | Ref_name/Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_4b <- mixmeta(smd ~ log10_mg_d_L, S = vmd,
                       random =  ~ log10_mg_d_L | Ref_name/Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_4c <- mixmeta(Hedges_d ~ log10_mg_L, S = Var_d,
                       random =  ~ log10_mg_L | Ref_name/Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
log_mod_SS_photo_4d <- mixmeta(smd ~ log10_mg_L, S = vmd,
                       random =  ~ log10_mg_L | Ref_name/Ref/Comparison,
                       data = ES_SS_fv_fm2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_SS_photo <- by(ES_DS_fv_fm, ES_DS_fv_fm$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))

# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_log_FVFM <- list(NA)
for (i in seq(1,length(covar_SS_photo))) {
newlist_log_FVFM[i] <- list(covar_SS_photo[[i]]$S)
}
log_mod_SS_photo_5a <- mixmeta(Hedges_d ~ log10_mg_d_L,
                       random = ~ log10_mg_d_L | Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))
log_mod_SS_photo_5b <- mixmeta(smd ~ log10_mg_d_L,
                       random = ~ log10_mg_d_L | Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))
log_mod_SS_photo_5c <- mixmeta(Hedges_d ~ log10_mg_L,
                       random = ~ log10_mg_L | Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))
log_mod_SS_photo_5d <- mixmeta(smd ~ log10_mg_L,
                       random = ~ log10_mg_L | Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_log_FVFM2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_log_FVFM <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_log_FVFM2 <-list(NA)
reflista <- ES_SS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_SS_photo that are all from the same reference [i]
  templist_log_FVFM[i] <-list(covar_SS_photo[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_log_FVFM[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_log_FVFM2
     templist_log_FVFM2[j] <- list(templist_log_FVFM[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_log_FVFM2[i] <- list(bdiagMat(templist_log_FVFM2))
  templist_log_FVFM2 <- list(NA)
}
log_mod_SS_photo_6a <- mixmeta(Hedges_d ~ log10_mg_d_L,
                       random = ~ log10_mg_d_L | Ref/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))
log_mod_SS_photo_6b <- mixmeta(smd ~ log10_mg_d_L,
                       random = ~ log10_mg_d_L | Ref/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))
log_mod_SS_photo_6c <- mixmeta(Hedges_d ~ log10_mg_L,
                       random = ~ log10_mg_L | Ref/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))
log_mod_SS_photo_6d <- mixmeta(smd ~ log10_mg_L,
                       random = ~ log10_mg_L | Ref/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM2))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref_name/Comparison
newlist_log_FVFM3 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial Ref_name/Comparison
templist_log_FVFM3 <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_log_FVFM4 <-list(NA)
reflista <- ES_SS_fv_fm %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,2]
for (i in seq(1,length(unique(reflista$Ref_name))))  {
  #pull the elements from covar_SS_photo that are all from the same reference [i]
  templist_log_FVFM3[i] <-list(covar_SS_photo[reflist==unique(reflista$Ref_name)[i]])
  for (j in seq(1,length(templist_log_FVFM3[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_log_FVFM4
     templist_log_FVFM4[j] <- list(templist_log_FVFM3[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_log_FVFM3[i] <- list(bdiagMat(templist_log_FVFM4))
  templist_log_FVFM4 <- list(NA)
}
log_mod_SS_photo_7a <- mixmeta(Hedges_d ~ log10_mg_d_L,
                       random = ~ log10_mg_d_L | Ref_name/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
log_mod_SS_photo_7b <- mixmeta(smd ~ log10_mg_d_L,
                       random = ~ log10_mg_d_L | Ref_name/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
log_mod_SS_photo_7c <- mixmeta(Hedges_d ~ log10_mg_L,
                       random = ~ log10_mg_L | Ref_name/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
log_mod_SS_photo_7d <- mixmeta(smd ~ log10_mg_L,
                       random = ~ log10_mg_L | Ref_name/Comparison,
                       data=ES_SS_fv_fm2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_log_FVFM3))
```
  
### 3. Model Comparison and Summary
And now to compare relative fit of log-linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(log_mod_SS_photo_1a, log_mod_SS_photo_2a, log_mod_SS_photo_3a, log_mod_SS_photo_4a, log_mod_SS_photo_5a, log_mod_SS_photo_6a, log_mod_SS_photo_7a) 
#of these, model 1a has lowest AIC

AIC(log_mod_SS_photo_1b, log_mod_SS_photo_2b, log_mod_SS_photo_3b, log_mod_SS_photo_4b, log_mod_SS_photo_5b, log_mod_SS_photo_6b, log_mod_SS_photo_7b) 
#of these, model 6b has lowest AIC (but 7b within 2 AIC)

AIC(log_mod_SS_photo_1c, log_mod_SS_photo_2c, log_mod_SS_photo_3c, log_mod_SS_photo_4c, log_mod_SS_photo_5c, log_mod_SS_photo_6c, log_mod_SS_photo_7c) 
#of these, model 1c has lowest AIC

AIC(log_mod_SS_photo_1d, log_mod_SS_photo_2d, log_mod_SS_photo_3d, log_mod_SS_photo_4d, log_mod_SS_photo_5d, log_mod_SS_photo_6d, log_mod_SS_photo_7d) 
#of these, model 5d has lowest AIC
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))

resid_log_SSa <- resid(log_mod_SS_photo_1a)
fitted_log_SSa <- fitted(log_mod_SS_photo_1a)
plot(fitted_log_SSa, resid_log_SSa, main = "A: Hedges_d ~ log_mg_d_L, S=Var_d,
     random =  ~ log_mg_d_L | Comparison")
abline(0,0)

resid_log_SSb <- resid(log_mod_SS_photo_6b)
fitted_log_SSb <- fitted(log_mod_SS_photo_6b)
plot(fitted_log_SSb, resid_log_SSb, main = "B: smd ~ log_mg_d_L, control=addSlist,
     random =  ~ log_mg_d_L | Ref/Comparison")
abline(0,0)

resid_log_SSc <- resid(log_mod_SS_photo_1c)
fitted_log_SSc <- fitted(log_mod_SS_photo_1c)
plot(fitted_log_SSc, resid_log_SSc, main = "C: Hedges_d ~ log_mg_L, S=Var_d,
     random =  ~ log_mg_L | Comparison")
abline(0,0)

resid_log_SSd <- resid(log_mod_SS_photo_5d)
fitted_log_SSd <- fitted(log_mod_SS_photo_5d)
plot(fitted_log_SSd, resid_log_SSd, main = "D: smd ~ log_mg_L, control=addSlist,
     random =  ~ log_mg_L | Comparison")
abline(0,0)

par(op)


# Normal Q-Q Plot
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))
qqnorm(resid_log_SSa)
qqline(resid_log_SSa)
qqnorm(resid_log_SSb)
qqline(resid_log_SSb)
qqnorm(resid_log_SSc)
qqline(resid_log_SSc)
qqnorm(resid_log_SSd)
qqline(resid_log_SSd)
par(op)


# Patterns:
# 1.  A and B look pretty good -- low magnitudes
# 2.  C and D look worse and weren't necessary anyway, so stick with non-linear models for these.
```
  
### 4. Best-Fit Model Summary
  
#### i. MG x DAY/L IS PREDICTOR, Model using manual calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_SS_photo_1a)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_SS_photo_1a, newdata=data.frame(Sed_exposure_mg_d_L=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_SS_photo_1a <- predict(log_mod_SS_photo_1a, newdata=ES_SS_fv_fm2, ci=TRUE)
ES_SS_fv_fm2_CI <- cbind(ES_SS_fv_fm2, pred_log_mod_SS_photo_1a)
#head(ES_SS_fv_fm2_CI)
min_exp_SSa <- ES_SS_fv_fm2_CI %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp_SSa=min(Sed_exposure_mg_d_L))
min_exp_SSa2 <- as.numeric(min_exp_SSa)

ggplot(ES_SS_fv_fm2_CI, 
       aes(x = Sed_exposure_mg_d_L,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp_SSa2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_d_L, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_d_L, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(1,10000), breaks=c(1,10,100,1000,10000,min_exp_SSa2), 
                label=c("1","10","100","1000","10000",round(min_exp_SSa2,digits=1))) +
  scale_y_continuous(limits=c(-2.5,3))
```

#### ii. MG x DAY/L IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(log_mod_SS_photo_6b)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(log_mod_SS_photo_6b, newdata=data.frame(Sed_exposure_mg_d_L=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_log_mod_SS_photo_6b <- predict(log_mod_SS_photo_6b, newdata=ES_SS_fv_fm2, ci=TRUE)
ES_SS_fv_fm2_CI2 <- cbind(ES_SS_fv_fm2, pred_log_mod_SS_photo_6b)
#head(ES_SS_fv_fm2_CI2)
min_exp_SSb <- ES_SS_fv_fm2_CI2 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp_SSb=min(Sed_exposure_mg_d_L))
min_exp_SSb2 <- as.numeric(min_exp_SSb)

ggplot(ES_SS_fv_fm2_CI2, 
       aes(x = Sed_exposure_mg_d_L,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp_SSb2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_d_L, y = smd,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_d_L, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(1,10000), breaks=c(1,10,100,1000,10000,min_exp_SSb2), 
                label=c("1","10","100","1000","10000",round(min_exp_SSb2,digits=1)))
```
  
#### iii. MG/L IS PREDICTOR, Model using manual calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_SS_photo_1c)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(mod_SS_photo_1c, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_SS_photo_1c <- predict(mod_SS_photo_1c, newdata=ES_SS_fv_fm2, ci=TRUE)
ES_SS_fv_fm2_CI3 <- cbind(ES_SS_fv_fm2, pred_mod_SS_photo_1c)
#head(ES_SS_fv_fm2_CI3)
min_conc_SSc <- ES_SS_fv_fm2_CI3 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_conc_SSc=min(Sed_level_standardized))
min_conc_SSc2 <- as.numeric(min_conc_SSc)

ggplot(ES_SS_fv_fm2_CI3, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_SSc2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(1,250), breaks=c(1,10,100,min_conc_SSc2), 
                label=c("1","10","100",round(min_conc_SSc2,digits=1))) +
  scale_y_continuous(limits=c(-2.5,3))
```

#### iv. MG/L IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_SS_photo_5d)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(mod_SS_photo_5d, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_SS_photo_5d <- predict(mod_SS_photo_5d, newdata=ES_SS_fv_fm2, ci=TRUE)
ES_SS_fv_fm2_CI4 <- cbind(ES_SS_fv_fm2, pred_mod_SS_photo_5d)
#head(ES_SS_fv_fm2_CI4)
min_conc_SSd <- ES_SS_fv_fm2_CI4 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_conc_SSd=min(Sed_level_standardized))
min_conc_SSd2 <- as.numeric(min_conc_SSd)

ggplot(ES_SS_fv_fm2_CI4, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_SSd2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = smd,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(1,250), breaks=c(1,10,100,min_conc_SSd2), 
                label=c("1","10","100",round(min_conc_SSd2,digits=1))) +
  scale_y_continuous(limits=c(-2.5,3))
```
  
  
# II. Photosynthesis-Respiration Ratio 

## A. Deposited Sediment  
  
### 1. Plots  
I calculated the standardized mean difference in terms of Hedges' *d* and plot it here with respect to cumulative exposure. I did this first for a Hedges' *d* that I calculated before importing the data to R and again for a Hedges' *d* that is calculated by the dosresmeta::covar.smd function.

```{r, echo=FALSE, warning=FALSE}
#CUMULATIVE EXPOSURE vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_p_r2, 
       aes(x = Sed_exposure_mg_cm2,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment cumulative exposure (mg/cm2) ",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_DS_p_r2, 
       aes(x = Sed_exposure_mg_cm2,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 

#EXPOSURE CONCENTRATION vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_p_r2, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., manual calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 
#Using dosresmeta's calculation of Hedges' d and variance of d
ggplot(ES_DS_p_r2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Ref,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 


#EXPOSURE CONCENTRATION vs. effect size, by SEDIMENT TYPE
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_p_r2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_category,
           shape = Sed_source,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment relative\ngrain size",
       shape = "Sediment source") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 
ggplot(ES_DS_p_r2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Sed_grain_class,
           shape = Sed_mineralogy,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Sediment\ngrain class",
       shape = "Sediment mineralogy") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 

#EXPOSURE CONCENTRATION vs. effect size, by PHYLOGENY
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_p_r2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Updated_Genus,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Genus") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 

#EXPOSURE CONCENTRATION vs. effect size, by OCEAN and REGION
#Using previously calculated Hedges' d and variance of d
ggplot(ES_DS_p_r2, 
       aes(x = Sed_level_standardized,
           y = smd,
           color = Region,
           shape = Ocean,
           ymin = smd-vmd,
           ymax = smd+vmd)) + 
  geom_pointrange() +
  ggtitle("Photosynthesis-Respiration Ratio") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Effect size (Hedges' d +/- s.d., dosresmeta calculation)",
       color = "Region",
       shape = "Ocean") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() 
```
  
It is interesting that there is a difference between how I calculated Hedges' *d* and how *dosresmeta* appears to calculate it. But in both cases, there may be a negative relationship between sediment exposure and effect size. There does not appear to be strong effects of phylogeny (genus) or geography (ocean and region). There may be effects of sediment type (source, origin, grain size), but I do not think these will be discernible given the variance.
   
### 2. Model Fitting
The following set of functions model fixed and random (nested) effects WITHOUT accounting for within-comparison (or within-study) correlations. The output for each is a univariate, random-effects meta-regression.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

# Organizational Note: 
#All models with 'a' or 'b' at the end of its name have cumulative exposure as its predictor. 
#All models with 'c' or 'd' at the end of its name have exposure concentration as its predictor. 
#All models with 'a' or 'c' at the end of its name have manually calculated Hedges' d as its response.
#All models with 'b' or 'd' at the end of its name have covar.smd calculated Hedges' d as its response.

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_p_r_1a <- mixmeta(Hedges_d ~ Sed_exposure_mg_cm2, S = Var_d,
                       random =  ~ Sed_exposure_mg_cm2 | Comparison,
                       data = ES_DS_p_r2, method = "ml")
mod_DS_p_r_1b <- mixmeta(smd ~ Sed_exposure_mg_cm2, S = vmd,
                      random =  ~ Sed_exposure_mg_cm2 | Comparison,
                      data = ES_DS_p_r2, method = "ml")
mod_DS_p_r_1c <- mixmeta(Hedges_d ~ Sed_level_standardized, S = Var_d,
                       random =  ~ Sed_level_standardized | Comparison,
                       data = ES_DS_p_r2, method = "ml")
mod_DS_p_r_1d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
                      random =  ~ Sed_level_standardized | Comparison,
                      data = ES_DS_p_r2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_p_r_2a <- mixmeta(Hedges_d ~ Sed_exposure_mg_cm2, S = Var_d,
                       random =  ~ Sed_exposure_mg_cm2 | Ref/Comparison,
                       data = ES_DS_p_r2, method = "ml")
mod_DS_p_r_2b <- mixmeta(smd ~ Sed_exposure_mg_cm2, S = vmd,
                      random =  ~ Sed_exposure_mg_cm2 | Ref/Comparison,
                      data = ES_DS_p_r2, method = "ml")
#Error in chol.default(XtVX) : the leading minor of order 6 is not positive definite
#mod_DS_p_r_2c <- mixmeta(Hedges_d ~ Sed_level_standardized, S = Var_d,
#                       random =  ~ Sed_level_standardized | Ref/Comparison,
#                       data = ES_DS_p_r2, method = "ml")
#mod_DS_p_r_2d <- mixmeta(smd ~ Sed_level_standardized, S = vmd,
#                      random =  ~ Sed_level_standardized | Ref/Comparison,
#                      data = ES_DS_p_r2, method = "ml")
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.smd function. 

```{r, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#covar_DS_photo <- by(ES_DS_p_r, ES_DS_p_r$Comparison, function(x) 
#  covar.smd(Tx_mean, Tx_sd, Tx_n, "smd", method="hedges", data = x))

# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-COMPARISON CORRELATIONS
#Code for covariance matrix to include for addSlist for Comparison random effect
newlist_PR <- list(NA)
for (i in seq(1,length(covar_DS_p_r))) {
newlist_PR[i] <- list(covar_DS_p_r[[i]]$S)
}
mod_DS_p_r_5a <- mixmeta(Hedges_d ~ Sed_exposure_mg_cm2,
                       random = ~ Sed_exposure_mg_cm2 | Comparison,
                       data=ES_DS_p_r2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_PR))
mod_DS_p_r_5b <- mixmeta(smd ~ Sed_exposure_mg_cm2,
                       random = ~ Sed_exposure_mg_cm2 | Comparison,
                       data=ES_DS_p_r2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_PR))
mod_DS_p_r_5c <- mixmeta(Hedges_d ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Comparison,
                       data=ES_DS_p_r2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_PR))
mod_DS_p_r_5d <- mixmeta(smd ~ Sed_level_standardized,
                       random = ~ Sed_level_standardized | Comparison,
                       data=ES_DS_p_r2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_PR))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for covariance matrix to include for addSlist for Ref/Comparison
newlist_PR2 <- list(NA) #collects the list of covariance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_PR <- list(NA) #holds temp list of covariance matrices associated with each reference
templist_PR2 <-list(NA)
reflista <- ES_DS_p_r %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from covar_DS_p_r that are all from the same reference [i]
  templist_PR[i] <-list(covar_DS_p_r[reflist==unique(reflista$Ref)[i]])
  for (j in seq(1,length(templist_PR[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_PR2
     templist_PR2[j] <- list(templist_PR[[i]][[j]]$S)
  }
  #turn list of covars from all comparison in one reference into block diag matrix
  newlist_PR2[i] <- list(bdiagMat(templist_PR2))
  templist_PR2 <- list(NA)
}
mod_DS_p_r_6a <- mixmeta(Hedges_d ~ Sed_exposure_mg_cm2,
                       random = ~ Sed_exposure_mg_cm2 | Ref/Comparison,
                       data=ES_DS_p_r2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_PR2))
mod_DS_p_r_6b <- mixmeta(smd ~ Sed_exposure_mg_cm2,
                       random = ~ Sed_exposure_mg_cm2 | Ref/Comparison,
                       data=ES_DS_p_r2, method="ml", #using dataset without controls
                       control=list(addSlist=newlist_PR2))
#Error in chol.default(XtVX) : the leading minor of order 6 is not positive definite
#mod_DS_p_r_6c <- mixmeta(Hedges_d ~ Sed_level_standardized,
#                       random = ~ Sed_level_standardized | Ref/Comparison,
#                       data=ES_DS_p_r2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_PR2))
#mod_DS_p_r_6d <- mixmeta(smd ~ Sed_level_standardized,
#                       random = ~ Sed_level_standardized | Ref/Comparison,
#                       data=ES_DS_p_r2, method="ml", #using dataset without controls
#                       control=list(addSlist=newlist_PR2))
```
  
### 3. Model Comparison and Summary
And now to compare relative fit of linear models...

```{r, echo=FALSE, warning=FALSE}
# Model Comparisons
AIC(mod_DS_p_r_1a, mod_DS_p_r_2a, mod_DS_p_r_5a, mod_DS_p_r_6a) 
#of these, model 5a has lowest AIC (but 1a within 2 AIC)

AIC(mod_DS_p_r_1b, mod_DS_p_r_2b, mod_DS_p_r_5b, mod_DS_p_r_6b)
#of these, model 1b and 5b have lowest AIC

AIC(mod_DS_p_r_1c, mod_DS_p_r_5c) 
#of these, model 5c has lowest AIC (but 1c within 2 AIC)

AIC(mod_DS_p_r_1d, mod_DS_p_r_5d) 
#of these, model 1d and 5d have lowest AIC
```
  
And now to evaluate residuals of models...

```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))

resid_PRa <- resid(mod_DS_p_r_5a)
fitted_PRa <- fitted(mod_DS_p_r_5a)
plot(fitted_PRa, resid_PRa, main = "A: Hedges_d ~ mg_cm2, control=addSlist,
     random =  ~ mg_cm2 | Comparison")
abline(0,0)
#mod_DS_p_r_1a and mod_DS_p_r_3a were within 2 AIC

resid_PRb <- resid(mod_DS_p_r_5b)
fitted_PRb <- fitted(mod_DS_p_r_5b)
plot(fitted_PRb, resid_PRb, main = "B: smd ~ mg_cm2, control=addSlist,
     random =  ~ mg_cm2 | Comparison")
abline(0,0)
#mod_DS_p_r_6b within 1 AIC

resid_PRc <- resid(mod_DS_p_r_5c)
fitted_PRc <- fitted(mod_DS_p_r_5c)
plot(fitted_PRc, resid_PRc, main = "C: Hedges_d ~ mg_cm2_d, control=addSlist,
     random =  ~ mg_cm2_d | Comparison")
abline(0,0)
#mod_DS_p_r_2c within 0.3 AIC

resid_PRd <- resid(mod_DS_p_r_5d)
fitted_PRd <- fitted(mod_DS_p_r_5d)
plot(fitted_PRd, resid_PRd, main = "D: smd ~ mg_cm2_d, control=addSlist,
     random =  ~ mg_cm2_d | Comparison")
abline(0,0)

par(op)


# Normal Q-Q Plot
op <- par(mfrow = c(2,2), mar = c(2,2,4,1))
qqnorm(resid_PRa)
qqline(resid_PRa)
qqnorm(resid_PRb)
qqline(resid_PRb)
qqnorm(resid_PRc)
qqline(resid_PRc)
qqnorm(resid_PRd)
qqline(resid_PRd)
par(op)


# Patterns:
# 1.  Sparse data, but they all seem to fit a linear trend with minimal residual magnitudes.
```
  
### 4. Best-Fit Model Summary  
  
#### i. MG/CM^2^ IS PREDICTOR, Model using manual calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_DS_p_r_5a)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(mod_DS_p_r_5a, newdata=data.frame(Sed_exposure_mg_cm2=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_DS_p_r_5a <- predict(mod_DS_p_r_5a, newdata=ES_DS_p_r2, ci=TRUE)
ES_DS_p_r2_CI <- cbind(ES_DS_p_r2, pred_mod_DS_p_r_5a)
#head(ES_DS_p_r2_CI)
min_exp_a <- ES_DS_p_r2_CI %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp_a=min(Sed_exposure_mg_cm2))
min_exp_a2 <- as.numeric(min_exp_a)

ggplot(ES_DS_p_r2_CI, 
       aes(x = Sed_exposure_mg_cm2,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = expression("Sediment cumulative exposure (mg/cm"^"2"*")"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp_a2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_cm2, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_cm2, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_continuous(limits = c(0,800), breaks=c(0,200,400,600,800,min_exp_a2), 
                label=c("0","200","400","600","800",round(min_exp_a2,digits=0)))
```
  
#### ii. MG/CM^2^ IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_DS_p_r_5b)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(mod_DS_p_r_5b, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_DS_p_r_5b <- predict(mod_DS_p_r_5b, newdata=ES_DS_p_r2, ci=TRUE)
ES_DS_p_r2_CI2 <- cbind(ES_DS_p_r2, pred_mod_DS_p_r_5b)
#head(ES_DS_p_r2_CI2)
min_exp_b <- ES_DS_p_r2_CI2 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp_b=min(Sed_exposure_mg_cm2))
min_exp_b2 <- as.numeric(min_exp_b)

ggplot(ES_DS_p_r2_CI2, 
       aes(x = Sed_exposure_mg_cm2,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = expression("Sediment cumulative exposure (mg/cm"^"2"*")"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp_b2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_cm2, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_cm2, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_continuous(limits = c(0,800), breaks=c(0,200,400,600,800,min_exp_b2), 
                label=c("0","200","400","600","800",round(min_exp_b2,digits=0)))
```
  
#### iii. MG/CM2/DAY IS PREDICTOR, Model using manual calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_DS_p_r_5c)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(mod_DS_p_r_5c, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_DS_p_r_5c <- predict(mod_DS_p_r_5c, newdata=ES_DS_p_r2, ci=TRUE)
ES_DS_p_r2_CI3 <- cbind(ES_DS_p_r2, pred_mod_DS_p_r_5c)
#head(ES_DS_p_r2_CI3)
min_conc_c <- ES_DS_p_r2_CI3 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_conc_c=min(Sed_level_standardized))
min_conc_c2 <- as.numeric(min_conc_c)

ggplot(ES_DS_p_r2_CI3, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_c2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_y_continuous(limits=c(-8,1)) +
  scale_x_continuous(limits=c(20,65), breaks=c(20,40,60,min_conc_c2), 
                label=c("20","40","60",round(min_conc_c2,digits=0)))
```
  
#### iv. MG/CM2/DAY IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_DS_p_r_5d)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS (LOAEL identified by binary analyses)
#predict(mod_DS_p_r_5d, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_DS_p_r_5d <- predict(mod_DS_p_r_5d, newdata=ES_DS_p_r2, ci=TRUE)
ES_DS_p_r2_CI4 <- cbind(ES_DS_p_r2, pred_mod_DS_p_r_5d)
min_conc_d <- ES_DS_p_r2_CI4 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_conc_d=min(Sed_level_standardized))
min_conc_d2 <- as.numeric(min_conc_d)

ggplot(ES_DS_p_r2_CI4, 
       aes(x = Sed_level_standardized,
           y = Hedges_d,
           color = Ref,
           ymin = Hedges_d-Var_d,
           ymax = Hedges_d+Var_d)) + 
  geom_pointrange() +
  labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
       y = expression("Effect size (Hedges'"~italic(d)~"+/- variance of"~italic(d)~")"),
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_d2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = Hedges_d,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_y_continuous(limits=c(-8,1)) +
  scale_x_continuous(limits=c(20,65), breaks=c(20,40,60,min_conc_d2), 
                label=c("20","40","60",round(min_conc_d2,digits=0)))
```
