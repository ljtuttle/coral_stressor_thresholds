---
title: "Effects of sediment on the mortality of adult corals"
author: "Lillian J. Tuttle"
date: "7/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mixmeta)
library(dosresmeta)
library(splines)

#will want to getwd() and setwd(), as appropriate
totalmort <- read.csv("/Volumes/GoogleDrive/My Drive/iScience/Code/thresholds/sedimentation/effectsize3.csv", header=T)

#keyboard shortcuts to remember: 
#command-option-I inserts new code chunk
#command-shift-M inserts pipeline symbols
#command-enter runs line of code where cursor is (or highlighted portion)
```
  
```{r, echo=FALSE, warning=FALSE}
#Looking at data
#totalmort

#Now create a new variable that has both Genus and species and remove irrelevant rows (non-controls, -treatments, or -baselines)
totalmort <- totalmort %>%
  mutate(Gsp = paste(Updated_Genus, Updated_species, sep = "_")) %>%
  filter(!Control=="-1")
#totalmort

#Second dataset that that removes controls (Control == c("1","2"))
totalmort2 <- totalmort %>% filter(Control=="0")
#totalmort2

#Separate into deposited sediment (DS) and suspended sediment (SS) datasets, WITH CONTROLS
DS_totalmort <- totalmort %>% filter(DS_SS=="DS")
#DS dataset without Hodgson 1989 (DS08a,b):
DS_totalmort_b <- DS_totalmort %>% filter(!Ref=="DS08a") %>% filter(!Ref=="DS08b")
SS_totalmort <- totalmort %>% filter(DS_SS=="SS")
DS_totalmort_b %>% tally()
DS_totalmort_b %>% count(Ref)
DS_totalmort_b %>% count(Ref_name)
DS_totalmort_b %>% count(Gsp)
DS_totalmort_b %>% count(Updated_Genus)
SS_totalmort %>% tally()
SS_totalmort %>% count(Ref)
SS_totalmort %>% count(Ref_name)
SS_totalmort %>% count(Gsp)
SS_totalmort %>% count(Updated_Genus)
``` 
  
These datasets contain information from multiple articles (**Ref_name**) and studies/experiments (**Ref**) within those articles about the effects of DEPOSITED & SUSPENDED sediment on the **total colony mortality** of adult corals, quantified as the percent of complete colony mortality within an experimental group. I would like to explore the dose-response relationship between sediment 'dose' and the effect size, estimated here as the log risk/rate ratio (**logRR**) or the log odds ratio (**logOR**):

- The log risk ratio is defined as...

- The log odds ratio is defined as...

- 'Dose' can be quantified as sediment exposure concentration (mg/cm^2^/day for deposited sediment and mg/L for suspended sediment), exposure duration (days), or as "cumulative exposure", for which I multiply concentration and duration (mg/cm^2^ for deposited sediment and mg x day/L for suspended sediment).

Each study/experiment (Ref) may contain multiple sets of controls and treatments (due to using multiple species or sediment types, for instance). Thus, I have added two categorical vectors, '**Comparison**' and 'Control', which group each set of control-treatment comparisons into a unique two-letter code, within which is one control (Control=="1") and at least one treatment (Control=="0"). **Therefore, 'Comparison' is nested within 'Ref', which is further nested within 'Ref_name'.**

```{r, echo=FALSE}
#CALCULATE COVARIANCE
#Deposited sediment, with Hodgson 1989 Chapter IV
#does not work! Error: "Error in solve.default(H) : system is computationally singular: reciprocal Dondition number = 0"
#addS_DS_totalmort <- lapply(split(DS_totalmort, DS_totalmort$Comparison), function(x)
#  covar.logrr(y=logRR, v=logRR_var, cases=Tx_n_dead_adj, n=Tx_n_total_adj, type=Type, data=x))

#Deposited sediment, without Hodgson 1989 Chapter IV
addS_DS_totalmort_b <- lapply(split(DS_totalmort_b, DS_totalmort_b$Comparison), function(x)
  covar.logrr(y=logRR, v=logRR_var, cases=Tx_n_dead_adj, n=Tx_n_total_adj, type=Type, data=x))

#Suspended sediment
addS_SS_totalmort <- lapply(split(SS_totalmort, SS_totalmort$Comparison), function(x)
  covar.logrr(y=logRR, v=logRR_var, cases=Tx_n_dead_adj, n=Tx_n_total_adj, type=Type, data=x))

#Removing controls for modeling
DS_totalmort2 <- subset(DS_totalmort, Control=="0")
DS_totalmort_b2 <- subset(DS_totalmort_b, Control=="0")
SS_totalmort2 <- subset(SS_totalmort, Control=="0")

#Looking at data to make sure controls were removed
#DS_totalmort2
#DS_totalmort_b2
#SS_totalmort2
DS_totalmort_b2 %>% tally()
SS_totalmort2 %>% tally()
``` 
  
# I. Deposited Sediment  
  
## A. Plots  

```{r, echo=FALSE, warning=FALSE}

##WITH HODGSON 1989 PHD CHAPTER IV
#CUMULATIVE EXPOSURE vs. effect size, by study
ggplot(DS_totalmort2, 
       aes(x = Sed_exposure_mg_cm2,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(10,10000), breaks=c(10,100,1000,10000), 
                label=c("10","100","1000","10000"))
#EXPOSURE CONCENTRATION vs. effect size, by study
#Using previously calculated Hedges' d and variance of d
ggplot(DS_totalmort2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,100), breaks=c(1,10,100), 
                label=c("1","10","100"))


##WITHOUT HODGSON 1989 PHD CHAPTER IV
#CUMULATIVE EXPOSURE vs. effect size, by study
ggplot(DS_totalmort_b2, 
       aes(x = Sed_exposure_mg_cm2,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(10,10000), breaks=c(10,100,1000,10000), 
                label=c("10","100","1000","10000"))
#EXPOSURE CONCENTRATION vs. effect size, by study
ggplot(DS_totalmort_b2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment exposure concentration (mg/cm2/day)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,100), breaks=c(1,10,100), 
                label=c("1","10","100"))

#EXPOSURE CONCENTRATION vs. effect size, by SEDIMENT TYPE
ggplot(DS_totalmort_b2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Sed_grain_category,
           shape = Sed_source,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Log Relative Risk +/- s.d.",
       color = "Sediment relative\ngrain size",
       shape = "Sediment source") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,100), breaks=c(1,10,100), 
                label=c("1","10","100"))
ggplot(DS_totalmort_b2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Sed_grain_class,
           shape = Sed_mineralogy,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Log Relative Risk +/- s.d.",
       color = "Sediment\ngrain class",
       shape = "Sediment mineralogy") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,100), breaks=c(1,10,100), 
                label=c("1","10","100"))

#EXPOSURE CONCENTRATION vs. effect size, by PHYLOGENY
ggplot(DS_totalmort_b2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Gsp,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Log Relative Risk +/- s.d.",
       color = "Species") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,100), breaks=c(1,10,100), 
                label=c("1","10","100"))

#EXPOSURE CONCENTRATION vs. effect size, by OCEAN and REGION
ggplot(DS_totalmort_b2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Region,
           shape = Ocean,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg/cm2)",
       y = "Log Relative Risk +/- s.d.",
       color = "Region",
       shape = "Ocean") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,100), breaks=c(1,10,100), 
                label=c("1","10","100"))
```
  
There does not appear to be a relationship between sediment exposure and effect size. Also, there does not appear to be strong effects of phylogeny (genus) or geography (ocean and region). Sediment type (source, origin, grain size) is yet to be analyzed.
  
## B. Linear and Non-Linear Models   
The following set of functions model fixed and random (nested) effects WITHOUT accounting for within-comparison (or within-study) correlations. The output for each is a univariate, random-effects meta-regression.

```{r, echo=FALSE, warning=FALSE}
#?mixmeta

###ALL ANALYSES WITHOUT HODGSON 1989 PHD CHAPTER IV (a or b)

# Organizational Note: 
#All models with 'a' at the end of its name have cumulative exposure as its predictor. 
#All models with 'b' at the end of its name have exposure concentration as its predictor. 

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_totalmort1a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_cm2, S = logRR_var,
                              random =  ~ 0 + Sed_exposure_mg_cm2 | Comparison,
                              data = DS_totalmort_b2, method = "ml")
mod_DS_totalmort1b <- mixmeta(logRR ~ 0 + Sed_level_standardized, S = logRR_var,
                              random =  ~ 0 + Sed_level_standardized | Comparison,
                              data = DS_totalmort_b2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_totalmort2a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_cm2, S = logRR_var,
                              random =  ~ 0 + Sed_exposure_mg_cm2 | Ref/Comparison,
                              data = DS_totalmort_b2, method = "ml")
mod_DS_totalmort2b <- mixmeta(logRR ~ 0 + Sed_level_standardized, S = logRR_var,
                              random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
                              data = DS_totalmort_b2, method = "ml")

# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_DS_totalmort3a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_cm2,
                              random =  ~ 0 + Sed_exposure_mg_cm2 | Comparison,
                              data = DS_totalmort_b2, method = "ml",
                              control=list(addSlist=addS_DS_totalmort_b))
mod_DS_totalmort3b <- mixmeta(logRR ~ 0 + Sed_level_standardized,
                              random =  ~ 0 + Sed_level_standardized | Comparison,
                              data = DS_totalmort_b2, method = "ml",
                              control=list(addSlist=addS_DS_totalmort_b))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in getSlist(S, nay, groups, m, k, control$addSlist, control$checkPD) : 'addSlist' not consistent with required format and grouping length. See help(mixmeta.control)
#mod_DS_totalmort4a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_cm2,
#                              random =  ~ 0 + Sed_exposure_mg_cm2 | Ref/Comparison,
#                              data = DS_totalmort_b2, method = "ml",
#                              control=list(addSlist=addS_DS_totalmort_b))
#mod_DS_totalmort4b <- mixmeta(logRR ~ 0 + Sed_level_standardized,
#                              random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
#                              data = DS_totalmort_b2, method = "ml",
#                              control=list(addSlist=addS_DS_totalmort_b))
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.logrr function. 

```{r, eval=FALSE, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#addS_DS_totalmort_b <- lapply(split(DS_totalmort_b, DS_totalmort_b$Comparison), function(x)
#  covar.logrr(y=logRR, v=logRR_var, cases=Tx_n_dead_adj, n=Tx_n_total_adj, type=Type, data=x))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for co-variance matrix to include for addSlist for Ref/Comparison
#addS_DS_totalmort_b is the list of co-variance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_PMORT <- list(NA) #holds temp list of co-variance matrices associated with each reference
templist_PMORT2 <- list(NA)
reflista <- DS_totalmort_b %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from xxx that are all from the same reference [i]
  templist_PMORT[i] <- list(addS_DS_totalmort_b[reflist==unique(reflista$Ref)[i]])
  
  for (j in seq(1,length(templist_PMORT[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_PMORT2
     templist_PMORT2[j] <- list(templist_PMORT[[i]][[j]]$S)
  }
  
  #turn list of covars from all comparisons in one reference into block diag matrix
  addS_DS_totalmort_b[i] <- list(bdiagMat(templist_PMORT2))
  templist_PMORT2 <- list(NA)
}

addS_DS_totalmort_b2 <- list(bdiagMat(addS_DS_totalmort_b))


mod_DS_totalmort4a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_cm2,
                              random =  ~ 0 + Sed_exposure_mg_cm2 | Ref/Comparison,
                              data = DS_totalmort_b2, method = "ml",
                              control=list(addSlist=addS_DS_totalmort_b2))
mod_DS_totalmort4b <- mixmeta(logRR ~ 0 + Sed_level_standardized,
                              random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
                              data = DS_totalmort_b2, method = "ml",
                              control=list(addSlist=addS_DS_totalmort_b2))
```
    
## C. Model Comparison and Summary
And now to compare relative fit of linear models...
```{r, echo=FALSE, warning=FALSE}
AIC(mod_DS_totalmort1a, mod_DS_totalmort2a, mod_DS_totalmort3a)
#of these, model 3a has lowest AIC

AIC(mod_DS_totalmort1b, mod_DS_totalmort2b, mod_DS_totalmort3b)
#of these, model 3b has lowest AIC
```
  
And now to evaluate residuals of models...
  
```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))

resid_a <- resid(mod_DS_totalmort3a)
fitted_a <- fitted(mod_DS_totalmort3a)
plot(fitted_a, resid_a, main = "A: logRR ~ mg_cm2, control = addSlist,
     random =  ~ mg_cm2 | Comparison")
abline(0,0)

resid_b <- resid(mod_DS_totalmort3b)
fitted_b <- fitted(mod_DS_totalmort3b)
plot(fitted_b, resid_b, main = "B: logRR ~ mg_cm2_d, control = addSlist,
     random =  ~ mg_cm2_d | Comparison")
abline(0,0)

par(op)


# Normal Q-Q Plot
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))
qqnorm(resid_a)
qqline(resid_a)
qqnorm(resid_b)
qqline(resid_b)
par(op)


# Patterns:
# 1.  Looks ok despite sparse data.
```
   
## D. Best-Fit Model Summary
  
### 1. MG/CM^2^ IS PREDICTOR
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_DS_totalmort3a)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS
#predict(mod_DS_totalmort3a, newdata=data.frame(Sed_exposure_mg_cm2=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_DS_totalmort3a <- predict(mod_DS_totalmort3a, newdata=DS_totalmort_b2, ci=TRUE)
DS_totalmort_b2_CI <- cbind(DS_totalmort_b2, pred_mod_DS_totalmort3a)
#head(DS_totalmort_b2_CI)
min_exp <- DS_totalmort_b2_CI %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp=min(Sed_exposure_mg_cm2))
min_exp <- as.numeric(min_exp)

ggplot(DS_totalmort_b2_CI, 
       aes(x = Sed_exposure_mg_cm2,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  labs(x = expression("Sediment cumulative exposure (mg/cm"^"2"*")"),
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_cm2, y = logRR,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_cm2, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(10,10000), breaks=c(10,100,1000,10000,min_exp), 
                label=c("10","100","1000","10000",round(min_exp,digits=1)))
```
  
### 2. MG/CM^2^/DAY IS PREDICTOR
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_DS_totalmort3b)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS
#predict(mod_DS_totalmort3b, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_DS_totalmort3b <- predict(mod_DS_totalmort3b, newdata=DS_totalmort_b2, ci=TRUE)
DS_totalmort_b2_CI2 <- cbind(DS_totalmort_b2, pred_mod_DS_totalmort3b)
#head(DS_totalmort_b2_CI2)
min_conc <- DS_totalmort_b2_CI2 %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_conc=min(Sed_exposure_mg_cm2))
min_conc2 <- as.numeric(min_conc)

ggplot(DS_totalmort_b2_CI2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  labs(x = expression("Sediment exposure concentration (mg/cm"^"2"*"/day)"),
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = logRR,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits=c(1,100),breaks=c(1,10,100,min_conc2),
                label=c("1","10","100",round(min_conc2,digits=1)))
```
  
  
# II. Suspended Sediment  
  
## A. Plots  

```{r, echo=FALSE, warning=FALSE}

#CUMULATIVE EXPOSURE vs. effect size, by study
ggplot(SS_totalmort2, 
       aes(x = Sed_exposure_mg_d_L,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(10,10000), breaks=c(10,100,1000,10000), 
                label=c("10","100","1000","10000"))
#EXPOSURE CONCENTRATION vs. effect size, by study
ggplot(SS_totalmort2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,200), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000"))

#EXPOSURE CONCENTRATION vs. effect size, by SEDIMENT TYPE
ggplot(SS_totalmort2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Sed_grain_category,
           shape = Sed_source,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Sediment relative\ngrain size",
       shape = "Sediment source") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,200), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000"))
ggplot(SS_totalmort2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Sed_grain_class,
           shape = Sed_mineralogy,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Sediment\ngrain class",
       shape = "Sediment mineralogy") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,200), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000"))

#EXPOSURE CONCENTRATION vs. effect size, by PHYLOGENY
ggplot(SS_totalmort2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Gsp,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Species") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,200), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000"))

#EXPOSURE CONCENTRATION vs. effect size, by OCEAN and REGION
ggplot(SS_totalmort2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Region,
           shape = Ocean,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  ggtitle("Colony mortality rate") +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Region",
       shape = "Ocean") +
  geom_abline(intercept=0, slope=0) +
  theme_classic() +
  scale_x_log10(limits = c(1,200), breaks=c(1,10,100,1000), 
                label=c("1","10","100","1000"))
```
  
There does not appear to be a relationship between sediment exposure and effect size. Also, there does not appear to be strong effects of phylogeny (genus) or geography (ocean and region). Sediment type (source, origin, grain size) is yet to be analyzed.
  
## B. Model Fitting  
The following set of functions model fixed and random (nested) effects WITHOUT accounting for within-comparison (or within-study) correlations. The output for each is a univariate, random-effects meta-regression.
  
```{r, echo=FALSE, warning=FALSE}
#?mixmeta

###ALL ANALYSES WITHOUT HODGSON 1989 PHD CHAPTER IV (a or b)

# Organizational Note: 
#All models with 'a' at the end of its name have cumulative exposure as its predictor. 
#All models with 'b' at the end of its name have exposure concentration as its predictor. 

# LINEAR FIXED AND RANDOM EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_SS_totalmort1a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_d_L, S = logRR_var,
                              random =  ~ 0 + Sed_exposure_mg_d_L | Comparison,
                              data = SS_totalmort2, method = "ml")
mod_SS_totalmort1b <- mixmeta(logRR ~ 0 + Sed_level_standardized, S = logRR_var,
                              random =  ~ 0 + Sed_level_standardized | Comparison,
                              data = SS_totalmort2, method = "ml")

# LINEAR FIXED AND RANDOM, NESTED EFFECTS NOT ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
mod_SS_totalmort2a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_d_L, S = logRR_var,
                              random =  ~ 0 + Sed_exposure_mg_d_L | Ref/Comparison,
                              data = SS_totalmort2, method = "ml")
mod_SS_totalmort2b <- mixmeta(logRR ~ 0 + Sed_level_standardized, S = logRR_var,
                              random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
                              data = SS_totalmort2, method = "ml")

# LINEAR FIXED AND RANDOM EFFECTS ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in getSlist(S, nay, groups, m, k, control$addSlist, control$checkPD) : 'addSlist' not consistent with required format and grouping length. See help(mixmeta.control)
#mod_SS_totalmort3a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_d_L,
#                              random =  ~ 0 + Sed_exposure_mg_d_L | Comparison,
#                              data = SS_totalmort2, method = "ml",
#                              control=list(addSlist=addS_DS_totalmort_b))
#mod_SS_totalmort3b <- mixmeta(logRR ~ 0 + Sed_level_standardized,
#                              random =  ~ 0 + Sed_level_standardized | Comparison,
#                              data = SS_totalmort2, method = "ml",
#                              control=list(addSlist=addS_DS_totalmort_b))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-STUDY CORRELATIONS
#Error in getSlist(S, nay, groups, m, k, control$addSlist, control$checkPD) : 'addSlist' not consistent with required format and grouping length. See help(mixmeta.control)
#mod_SS_totalmort4a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_d_L,
#                              random =  ~ 0 + Sed_exposure_mg_d_L | Ref/Comparison,
#                              data = SS_totalmort2, method = "ml",
#                              control=list(addSlist=addS_DS_totalmort_b))
#mod_SS_totalmort4b <- mixmeta(logRR ~ 0 + Sed_level_standardized,
#                              random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
#                              data = SS_totalmort2, method = "ml",
#                              control=list(addSlist=addS_DS_totalmort_b))
```

To account for within-comparison correlations in the mixmeta model, I replace the 'S' argument with a 'control' argument, which requires me to provide the covariance matrices, as done with the covar.logrr function. 

```{r, eval=FALSE, echo=FALSE, warning=FALSE}
# COMPUTE THE WITHIN-COMPARISON CORRELATIONS 
# already done above but code repeated here...
#addS_DS_totalmort_b <- lapply(split(DS_totalmort_b, DS_totalmort_b$Comparison), function(x)
#  covar.logrr(y=logRR, v=logRR_var, cases=Tx_n_dead_adj, n=Tx_n_total_adj, type=Type, data=x))

# LINEAR FIXED AND RANDOM, NESTED EFFECTS ACCOUNTING FOR WITHIN-COMPARISON & WITHIN-STUDY CORRELATIONS
#Code for co-variance matrix to include for addSlist for Ref/Comparison
#addS_DS_totalmort_b is the list of co-variance matrices for the block diag matrix by reference for the nested hierarchial ref/comparison
templist_PMORT <- list(NA) #holds temp list of co-variance matrices associated with each reference
templist_PMORT2 <- list(NA)
reflista <- DS_totalmort_b %>% distinct(Ref,Ref_name,Comparison)
reflist <- reflista[,1]
for (i in seq(1,length(unique(reflista$Ref))))  {
  #pull the elements from xxx that are all from the same reference [i]
  templist_PMORT[i] <- list(addS_DS_totalmort_b[reflist==unique(reflista$Ref)[i]])
  
  for (j in seq(1,length(templist_PMORT[[i]]))) {
  #for each comparison in the reference, pull out the covar matrices (element $S) and put in into templist_PMORT2
     templist_PMORT2[j] <- list(templist_PMORT[[i]][[j]]$S)
  }
  
  #turn list of covars from all comparisons in one reference into block diag matrix
  addS_DS_totalmort_b[i] <- list(bdiagMat(templist_PMORT2))
  templist_PMORT2 <- list(NA)
}

addS_SS_totalmort2 <- list(bdiagMat(addS_DS_totalmort_b))


mod_SS_totalmort4a <- mixmeta(logRR ~ 0 + Sed_exposure_mg_d_L,
                              random =  ~ 0 + Sed_exposure_mg_d_L | Ref/Comparison,
                              data = SS_totalmort2, method = "ml",
                              control=list(addSlist=addS_SS_totalmort2))
mod_SS_totalmort4b <- mixmeta(logRR ~ 0 + Sed_level_standardized,
                              random =  ~ 0 + Sed_level_standardized | Ref/Comparison,
                              data = SS_totalmort2, method = "ml",
                              control=list(addSlist=addS_SS_totalmort2))
```
    
## C. Model Comparison and Summary
And now to compare relative fit of linear models...
```{r, echo=FALSE, warning=FALSE}
AIC(mod_SS_totalmort1a, mod_SS_totalmort2a)
#of these, model 1a has lowest AIC (but 2a is within 2 AIC)

AIC(mod_SS_totalmort1b, mod_SS_totalmort2b)
#of these, model 1b has lowest AIC (but 2b is within 2 AIC)
```
  
And now to evaluate residuals of models...
  
```{r, echo=FALSE, warning=FALSE}
# Residuals vs. Fitted Plots
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))

resid_a <- resid(mod_SS_totalmort1a)
fitted_a <- fitted(mod_SS_totalmort1a)
plot(fitted_a, resid_a, main = "A: logRR ~ mg_d_L, S = logRR_var,
     random =  ~ mg_d_L | Comparison")
abline(0,0)

resid_b <- resid(mod_SS_totalmort1b)
fitted_b <- fitted(mod_SS_totalmort1b)
plot(fitted_b, resid_b, main = "B: logRR ~ mg_L, S = logRR_var,
     random =  ~ mg_L | Comparison")
abline(0,0)

par(op)


# Normal Q-Q Plot
op <- par(mfrow = c(1,2), mar = c(2,2,4,1))
qqnorm(resid_a)
qqline(resid_a)
qqnorm(resid_b)
qqline(resid_b)
par(op)


# Patterns:
# 1.  Looks ok despite sparse data.
```
   
## D. Best-Fit Model Summary
  
### 1. MG x DAY/L IS PREDICTOR
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_SS_totalmort1a)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS
#predict(mod_SS_totalmort1a, newdata=data.frame(Sed_exposure_mg_d_L=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_SS_totalmort1a <- predict(mod_SS_totalmort1a, newdata=SS_totalmort2, ci=TRUE)
SS_totalmort2_CI <- cbind(SS_totalmort2, pred_mod_SS_totalmort1a)
#head(SS_totalmort2_CI)
min_exp_SS <- SS_totalmort2_CI %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_exp_SS=min(Sed_exposure_mg_d_L))
min_exp_SS2 <- as.numeric(min_exp_SS)

ggplot(SS_totalmort2_CI, 
       aes(x = Sed_exposure_mg_d_L,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  labs(x = "Sediment cumulative exposure (mg x day/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_exp_SS2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_exposure_mg_d_L, y = logRR,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_exposure_mg_d_L, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(10,10000), breaks=c(10,100,1000,10000,min_exp_SS2), 
                label=c("10","100","1000","10000",round(min_exp_SS2,digits=1)))
```
  
### 2. MG/L IS PREDICTOR, Model using dosresmeta calculation of Hedges' *d*
Now I will predict the effect size along the exposure range and plot with confidence intervals.  

```{r, echo=FALSE, warning=FALSE}
summary(mod_SS_totalmort1b)

# PREDICT THE EFFECT SIZE FOR 13.2 mg/cm2 FROM TWO MODELS
#predict(mod_SS_totalmort1b, newdata=data.frame(Sed_level_standardized=13.2), ci=TRUE)

# PREDICT THE EFFECT SIZE AND PLOT WITH CONFIDENCE INTERVALS
pred_mod_SS_totalmort1b <- predict(mod_SS_totalmort1b, newdata=SS_totalmort2, ci=TRUE)
SS_totalmort2_CI2 <- cbind(SS_totalmort2, pred_mod_SS_totalmort1b)
#head(SS_totalmort2_CI2)
min_conc_SS <- SS_totalmort2_CI %>% 
  mutate(overlap0 = 0 >= ci.lb & 0 <= ci.ub) %>% 
  filter(overlap0==FALSE) %>% 
  summarize(min_conc_SS=min(Sed_level_standardized))
min_conc_SS2 <- as.numeric(min_conc_SS)

ggplot(SS_totalmort2_CI2, 
       aes(x = Sed_level_standardized,
           y = logRR,
           color = Ref,
           ymin = logRR-logRR_var,
           ymax = logRR+logRR_var)) + 
  geom_pointrange() +
  labs(x = "Sediment exposure concentration (mg/L)",
       y = "Log Relative Risk +/- s.d.",
       color = "Study") +
  geom_abline(intercept=0, slope=0) +
  geom_vline(xintercept=min_conc_SS2, linetype="dashed", color = "red") +
  geom_ribbon(aes(x = Sed_level_standardized, y = logRR,
                  ymin = ci.lb, ymax = ci.ub), 
              fill = "grey70", alpha = .15, 
              show.legend=FALSE, inherit.aes=FALSE) +
  geom_line(aes(x = Sed_level_standardized, y = fit), inherit.aes=FALSE) +
  theme_classic() +
  scale_x_log10(limits = c(1,200), breaks=c(1,10,100,1000,min_conc_SS2), 
                label=c("1","10","100","1000",round(min_conc_SS2,digits=1)))
```
  